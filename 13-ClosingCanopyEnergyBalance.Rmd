# Closing canopy and soil energy balances {#closecanopysoilenergybalance}

In chapter \@ref(radiationbalance) we described the details of radiation energy exchanges. Plant transpiration is an important latent heat component of the canopy energy balance, and the details of how plant transpiration is determined were given in chapters \@ref(planthydraulics), \@ref(photosynthesisstomatalregulation) and \@ref(transpirationsperry). We devote the first part of the current chapter to describe the calculations of convective and latent heat energy exchanges. These are the remaining energy exchange components to close the energy balance of the canopy (eq. \@ref(eq:canopyenergybalance)) and the soil (eq. \@ref(eq:soilenergybalance)). Temperature changes applied to the canopy and soil layers are also described here.

## Convective energy

Convective energy fluxes between atmosphere and the canopy ($H_{ca}$) and between the canopy and the soil ($H_{cs}$) are determined as follows:
\begin{eqnarray}
H_{ca} &=& \frac{\rho_{a} \cdot c_p}{r_{ca}}\cdot (T_{can} - T_a) \\
H_{cs} &=& \frac{\rho_{c} \cdot c_p}{r_{cs}}\cdot (T_{can} - T_{soil})
\end{eqnarray}
where $\rho_{a}$ and $\rho_{c}$ are the air density above-canopy and inside-canopy, respectively, $c_{p}$ = 1013.86 $J·kg^{-1}·C^{-1}$ is the specific heat capacity of the air. $r_{ca}$ and $r_{cs}$ are the atmosphere-canopy and canopy-soil aerodynamic resistances (in $s·m^{-1}$). These, in turn, are calculated using the FAO56 calculation procedure and canopy height, total LAI and above-canopy and below-canopy wind speeds. Wind speed below the canopy is calculated as explained in \@ref(windextinctionprofile) assuming a height of 2 m.

## Latent heat
As mentioned above, the canopy exchanges of latent heat include latent heat exchanged from plant transpiration and evaporation of rain intercepted by the canopy. After determining stomatal regulation and transpiration for each plant cohort, latent heat exchange for the canopy is calculated as:
\begin{equation}
LE_{c} = \lambda_{T_{canopy}} \left(In_{step} + \sum_{i}{E_i} \right)
\end{equation}
where $\lambda_{T_{canopy}}$ is the latent heat of vaporization at temperature $T_{canopy}$ (in $J·kg^{-1}$), $E_i$ is the instanteous transpiration flux calculated for cohort $i$ and $In_{step}$ is amount of water intercepted by the canopy for the current time step (total daily interception $In$ is divided into timesteps according to the proportion of shortwave radiation absorbed by the canopy at each time step).

The latent heat exchange of the soil ($LE_s$) comes either from water evaporated from the soil surface or snow melting. They do not occur simultaneously, but can be expressed in the same equation:
\begin{equation}
LE_s = \lambda_{T_{soil}} \cdot Es_{step} + \lambda_{fusion} \cdot Sm_{step}
\end{equation}
where $\lambda_{T_{soil}}$ is the latent heat of vaporization at temperature $T_{soil}$  and $\lambda_{fusion} = 0.33355$ is the latent heat of fusion (in $J·kg^{-1}$). As before, daily evaporation from bare soil ($Es$) and snow melt water equivalent ($Sm$) are divided into time steps according to the proportion of shortwave radiation absorbed by the soil layer each step.

## Canopy capacitance and temperature changes

After evaluating the canopy energy balance equation \@ref(eq:canopyenergybalance) one has to translate energy balance into temperature variation of the canopy, hence:
\begin{equation}
\Delta T_{canopy} =  \Delta t_{step} \cdot \frac{K_{abs,ca} + (L_{abs,ca} - L_{em,c}) + (L_{abs,cs} - L_{em,c}) - LE_{c} - H_{ca} - H_{cs}}{C_{canopy}}
\end{equation}
where $C_{canopy}$ is the canopy thermal capacitance and $\Delta t_{step} = 86400/n_t$ is the size of the time step in seconds. Canopy thermal capacitance depends on the leaf area index of the stand:
\begin{equation}
C_{canopy} = C_{LAI} \cdot \frac{0.8 \cdot LAI_{stand} + 1.2 \cdot (LAI_{stand}^{phi} + \cdot LAI_{stand}^{dead})}{2}
\end{equation}
where $C_{LAI}$ is the thermal capacitance per LAI unit, which is specified by the control parameter `thermalCapacityLAI`. By using both the maximum leaf area of the stand, $LAI_{stand}$, and its current live/dead leaf area ($LAI_{stand}^{phi}+LAI_{stand}^{dead}$) it is assumed that part of thermal capacitance corresponds to stems and branches, so that capacitance does not drop to zero for deciduous canopies.

## Soil temperature changes

Instantaneous soil temperature changes on each soil layer $s$ depend on the balance between incoming and outcoming energies ($G_s$ and $G_{s-1}$):
\begin{equation}
C_{soil,s} \cdot \frac{\delta T_{soil,s}}{\delta t} = \frac{G_s - G_{s-1}}{d_s}
\end{equation}
where $d_s$ is the soil width of layer $s$ and $C_{soil,s}$ is the *thermal capacity* of layer $s$, calculated from soil moisture and texture following a simplification of @Cox1999 (see function `soil_thermalcapacity()`).

Energy inflow to the first layer (i.e. $G_0$) is the result of the soil energy balance equation \@ref(eq:soilenergybalance), while energy transfers between layers (i.e. $G_s$) depend on the soil temperature gradient:
\begin{eqnarray}
G_0 &=&  K_{abs,sa} + L_{abs,sa} - L_{em,s} + L_{abs,sc} + H_{cs} - LE_{s} \\
G_k &=& \lambda_{soil,s} \cdot \frac{\delta T_{soil,s}}{\delta z}
\end{eqnarray}
where $\lambda_{soil,s}$ is the *thermal conductivity* of layer $s$, calculted from soil moisture and texture following @Dharssi2009 (see function `soil_thermalconductivity`). The gradient in the bottom layer is calculated assuming a temperature of the earth (at 10 m) of 15.5 Celsius.

The change in temperature for a given soil layer $s$ in the current time step is simply:
\begin{equation}
\Delta T_{soil,s} = \cdot \Delta t_{step} \cdot \frac{\delta T_{soil,s}}{\delta t}
\end{equation}
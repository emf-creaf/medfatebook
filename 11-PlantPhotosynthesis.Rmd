# Plant photosynthesis {#plantphotosynthesis}

In chapter \@ref(planthydraulics) we introduced the necessary concepts of steady-state plant hydraulics to define the *hydraulic supply function for the soil-plant continuum*. The supply function specifies the flow rate, as per leaf area, for values of leaf water potential and given a soil moisture status. In the first section of this chapter we describe leaf photosynthesis functions, which define leaf gas exchange, photosynthesis and energy balance for values of leaf water potential. This requires knowing wind, water vapor and temperature conditions of the air surrounding leaves (section \@ref(canopycapacitancetemperature)), the short-wave radiation absorbed by leaf elements (section \@ref(shortwaveradiationcanopyabs)) and the leaf long-wave radiation balance (section \@ref(longwaveradiation)). In the second section of this chapter we discuss how to upscale photosynthesis values to the crown level.

## Leaf energy balance, gas exchange and photosynthesis {#leafenergybalancephoto}

The supply function specifies the transpiration flow rate $E$ for values of leaf water potential $\Psi_{leaf}$. If we know air temperature, water vapor pressure and the light conditions in which leaves are, we can translate the supply function into a **leaf photosynthesis function** [@Sperry2016]. In a nutshell, $E$ from the supply function is first used to calculate leaf temperature from an evaluation of the leaf energy balance. The diffusive conductances of the leaf to $H_2O$ and $CO_{2}$ are obtained from water supply and leaf water vapor deficit. Finally, the gross/net assimilation rate is then obtained from the diffusive conductance and a modelled curve between assimilation and leaf internal $CO_{2}$ concentration. The following subsections detail each of these steps separately.


```{r, echo=FALSE}
Tmin = 15
Tmax = 30
RHmin = 60
RHmax = 75
Tcan = meteoland::utils_averageDaylightTemperature(Tmin, Tmax)
VPatm = meteoland::utils_averageDailyVP(Tmin, Tmax, RHmin, RHmax)
Patm = meteoland::utils_atmosphericPressure(100)

Q = 2000
Catm = 386

Vmax298 = 100
Jmax298 = 1.67*Vmax298
Gmin = 0.00001;
Gmax = 0.3

Rabs = 740 #W * m-2
```


### Leaf temperature

Leaf temperature ($T_{leaf}$; in $^\circ C$) can be calculated for any given flow rate $E$ using an energy balance equation [@Campbell1998]:
\begin{equation}
T_{leaf} = T_{air}+\frac{\Phi_{SWR}^{leaf} + L_{net}^{leaf}-\lambda_v(T_{air})\cdot E_{two-sided}}{C_p\cdot(g_r+g_{Ha})}
(\#eq:leaftemperatureequation)
\end{equation}
where $\Phi_{SWR}^{leaf}$ (in $W \cdot m^{-2}$) is the instantaneous shortwave radiation absorbed per leaf area unit, $L_{net}^{leaf}$ is the instantaneous net long-wave radiation per leaf area unit, $E_{two-sided}$ is the flow rate $E$ converted to $mol \cdot s^{-1} \cdot m^{-2}$ per two-sided leaf area basis, $\epsilon$ is longwave radiation emissivity (0.97), $\sigma$ is the Stephan-Boltzman constant, $T_{air}$ is the temperature of the air surrounding the leaf (in $^\circ C$), $C_p$ = 29.3 $J \cdot mol^{-1} \cdot ºC^{-1}$ is the specific heat capacity of dry air at constant pressure and $\lambda_v(T_{air})$ is the latent heat of vaporization (in $J \cdot mol^{-1}$) corresponding to $T_{air}$ (see [utility functions](http://vegmod.ctfc.cat/meteolandbook/miscellaneous.html#physicalutils) in the **meteoland** reference manual). If canopy energy balance is performed assuming a single canopy layer $T_{air}$ corresponds to  $T_{can}$, the whole-canopy air temperature resulting from the energy balance of the previous step (see section \@ref(canopycapacitancetemperature)). If a multi-layer canopy energy balance is used, $T_{air}$ corresponds to $T_{air,j}$, the air temperature of the canopy layer $j$ that contains the leaf. Finally, $g_r$ and $g_{Ha}$ are the radiative and heat conductance values (in $mol \cdot m^{-2} \cdot s^{-1}$), respectively [@Campbell1998]:
\begin{eqnarray}
g_r &=& \frac{4\cdot \epsilon \cdot \sigma \cdot (T_{air}+273.15)^3}{C_p} \\
g_{Ha} &=& 0.189 \cdot (u_{leaf}/d)^{0.5}
\end{eqnarray}
where $u_{leaf}$ is the leaf-level wind speed (in $m \cdot s^{-1}$) and $d$ is 0.72 times the leaf width (species parameter `LeafWidth` in $cm$). As before, $u_{leaf}$ corresponds to $u_j$, the wind-speed at the canopy layer $j$ where the leaf is located (see \@ref(windextinctionprofile)).

By inspecting eq. \@ref(eq:leaftemperatureequation), we can conclude that transpiration flow decreases leaf temperature, whereas radiation increases it and wind speed makes it more similar to the temperature of the surrounding air. The following figures illustrate the effect of varying wind speed and flow rate on $T_{leaf}$ for two contrasted leaf widths (see function `biophysics_leafTemperature`):


(ref:leaftemperaturewind-cap) Values of $T_{leaf}$ for two leaf widths and varying values of wind speed and flow rate, calculated for 24ºC air temperature and 740 $W \cdot m^{-2}$ instantaneous absorbed radiation (including SWR and LWR). 


```{r leaftemperaturewind, echo=FALSE, fig.width=8, fig.height=4, fig.align="center", fig.cap='(ref:leaftemperaturewind-cap)'}
par(mar=c(4,4,2,1), mfrow=c(1,2))
uvec = seq(0.1, 5, by=0.1)
E = seq(0, 8, by=0.1)
LT1 = matrix(0, nrow= length(uvec), ncol=length(E))
LT2 = matrix(0, nrow= length(uvec), ncol=length(E))
for(i in 1:length(uvec)) {
  for(j in 1:length(E)){
    LT1[i,j] = biophysics_leafTemperature(Rabs,Tcan, uvec[i], E[j], 10.0)
    LT2[i,j] = biophysics_leafTemperature(Rabs,Tcan, uvec[i], E[j], 0.1)
  }
} 
contour(x=uvec, y=E, z=LT1, xlab="Wind speed (m/s)", ylab="Flow rate (mmol·s-1·m-2)", main = "Wide leaf (10 cm) temperature (ºC)")
contour(x=uvec, y=E, z=LT2, xlab="Wind speed (m/s)", ylab="Flow rate (mmol·s-1·m-2)", main = "Narrow leaf (0.1 cm) temperature (ºC)")
```


Let us now fix wind speed at the leaf leavel to $u_{leaf} = 2$ m/s. The application of the above equations to the $E(\Psi_{leaf})$ curves corresponding to the complete hydraulic network (\@ref(supplycontinuum)) yields the following $T_{leaf}(\Psi_{leaf})$ curves:


(ref:leaftemperaturefunction-cap) Examples of leaf temperature functions for a hydraulic network, corresponding to fig. \@ref(fig:supplynetwork) and for different soil textures. Left/right panel shows values for uncavitated/cavitated supply functions. 

```{r leaftemperaturefunction, echo=FALSE, fig.width=8, fig.height=4, fig.align="center", fig.cap='(ref:leaftemperaturefunction-cap)'}
u = 2 # m*s-1
par(mar=c(4,4,2,1), mfrow=c(1,2))
psi2A11 = photo_leafPhotosynthesisFunction(supplyNetwork11$E,supplyNetwork11$psiLeaf, Catm, Patm,Tcan, VPatm, u, Rabs, Q, Vmax298, Jmax298)
psi2A12 = photo_leafPhotosynthesisFunction(supplyNetwork12$E,supplyNetwork12$psiLeaf,Catm, Patm,Tcan, VPatm, u, Rabs, Q, Vmax298, Jmax298)
psi2A13 = photo_leafPhotosynthesisFunction(supplyNetwork13$E,supplyNetwork13$psiLeaf,Catm, Patm,Tcan, VPatm, u, Rabs, Q, Vmax298, Jmax298)
psi2A14 = photo_leafPhotosynthesisFunction(supplyNetwork14$E,supplyNetwork14$psiLeaf,Catm, Patm,Tcan, VPatm, u, Rabs, Q, Vmax298, Jmax298)
psi2A21 = photo_leafPhotosynthesisFunction(supplyNetwork21$E,supplyNetwork21$psiLeaf,Catm, Patm,Tcan, VPatm, u, Rabs, Q, Vmax298, Jmax298)
psi2A22 = photo_leafPhotosynthesisFunction(supplyNetwork22$E,supplyNetwork22$psiLeaf,Catm, Patm,Tcan, VPatm, u, Rabs, Q, Vmax298, Jmax298)
psi2A23 = photo_leafPhotosynthesisFunction(supplyNetwork23$E,supplyNetwork23$psiLeaf,Catm, Patm,Tcan, VPatm, u, Rabs, Q, Vmax298, Jmax298)
psi2A24 = photo_leafPhotosynthesisFunction(supplyNetwork24$E,supplyNetwork24$psiLeaf,Catm, Patm,Tcan, VPatm, u, Rabs, Q, Vmax298, Jmax298)
psi2A31 = photo_leafPhotosynthesisFunction(supplyNetwork31$E,supplyNetwork31$psiLeaf,Catm, Patm,Tcan, VPatm, u, Rabs, Q, Vmax298, Jmax298)
psi2A32 = photo_leafPhotosynthesisFunction(supplyNetwork32$E,supplyNetwork32$psiLeaf,Catm, Patm,Tcan, VPatm, u, Rabs, Q, Vmax298, Jmax298)
psi2A33 = photo_leafPhotosynthesisFunction(supplyNetwork33$E,supplyNetwork33$psiLeaf,Catm, Patm,Tcan, VPatm, u, Rabs, Q, Vmax298, Jmax298)
psi2A34 = photo_leafPhotosynthesisFunction(supplyNetwork34$E,supplyNetwork34$psiLeaf,Catm, Patm,Tcan, VPatm, u, Rabs, Q, Vmax298, Jmax298)

psi2A11emb = photo_leafPhotosynthesisFunction(supplyNetwork11emb$E,supplyNetwork11emb$psiLeaf,Catm, Patm,Tcan, VPatm, u, Rabs, Q, Vmax298, Jmax298)
psi2A12emb = photo_leafPhotosynthesisFunction(supplyNetwork12emb$E,supplyNetwork12emb$psiLeaf,Catm, Patm,Tcan, VPatm, u, Rabs, Q, Vmax298, Jmax298)
psi2A13emb = photo_leafPhotosynthesisFunction(supplyNetwork13emb$E,supplyNetwork13emb$psiLeaf,Catm, Patm,Tcan, VPatm, u, Rabs, Q, Vmax298, Jmax298)
psi2A14emb = photo_leafPhotosynthesisFunction(supplyNetwork14emb$E,supplyNetwork14emb$psiLeaf,Catm, Patm,Tcan, VPatm, u, Rabs, Q, Vmax298, Jmax298)
psi2A21emb = photo_leafPhotosynthesisFunction(supplyNetwork21emb$E,supplyNetwork21emb$psiLeaf,Catm, Patm,Tcan, VPatm, u, Rabs, Q, Vmax298, Jmax298)
psi2A22emb = photo_leafPhotosynthesisFunction(supplyNetwork22emb$E,supplyNetwork22emb$psiLeaf,Catm, Patm,Tcan, VPatm, u, Rabs, Q, Vmax298, Jmax298)
psi2A23emb = photo_leafPhotosynthesisFunction(supplyNetwork23emb$E,supplyNetwork23emb$psiLeaf,Catm, Patm,Tcan, VPatm, u, Rabs, Q, Vmax298, Jmax298)
psi2A24emb = photo_leafPhotosynthesisFunction(supplyNetwork24emb$E,supplyNetwork24emb$psiLeaf,Catm, Patm,Tcan, VPatm, u, Rabs, Q, Vmax298, Jmax298)
psi2A31emb = photo_leafPhotosynthesisFunction(supplyNetwork31emb$E,supplyNetwork31emb$psiLeaf,Catm, Patm,Tcan, VPatm, u, Rabs, Q, Vmax298, Jmax298)
psi2A32emb = photo_leafPhotosynthesisFunction(supplyNetwork32emb$E,supplyNetwork32emb$psiLeaf,Catm, Patm,Tcan, VPatm, u, Rabs, Q, Vmax298, Jmax298)
psi2A33emb = photo_leafPhotosynthesisFunction(supplyNetwork33emb$E,supplyNetwork33emb$psiLeaf,Catm, Patm,Tcan, VPatm, u, Rabs, Q, Vmax298, Jmax298)
psi2A34emb = photo_leafPhotosynthesisFunction(supplyNetwork34emb$E,supplyNetwork34emb$psiLeaf,Catm, Patm,Tcan, VPatm, u, Rabs, Q, Vmax298, Jmax298)

plot(-supplyNetwork11$psiLeaf, psi2A11$LeafTemperature, type="l", col=col1, ylab="Leaf temperature (ºC)", xlab = "Leaf pressure (-MPa)",  xlim=c(0, 7), ylim=c(26,27.5), lwd=1, main="original")
lines(-supplyNetwork12$psiLeaf,psi2A12$LeafTemperature, lty=1, lwd=1, col=col2)
lines(-supplyNetwork13$psiLeaf, psi2A13$LeafTemperature, lty=1, lwd=1, col=col3)
lines(-supplyNetwork14$psiLeaf, psi2A14$LeafTemperature, lty=1, lwd=1, col=col4)
lines(-supplyNetwork21$psiLeaf, psi2A21$LeafTemperature, lty=2, lwd=1, col=col1)
lines(-supplyNetwork22$psiLeaf, psi2A22$LeafTemperature, lty=2, lwd=1, col=col2)
lines(-supplyNetwork23$psiLeaf, psi2A23$LeafTemperature, lty=2, lwd=1, col=col3)
lines(-supplyNetwork24$psiLeaf, psi2A24$LeafTemperature, lty=2, lwd=1, col=col4)
lines(-supplyNetwork31$psiLeaf, psi2A31$LeafTemperature, lty=3, lwd=1, col=col1)
lines(-supplyNetwork32$psiLeaf, psi2A32$LeafTemperature, lty=3, lwd=1, col=col2)
lines(-supplyNetwork33$psiLeaf, psi2A33$LeafTemperature, lty=3, lwd=1, col=col3)
lines(-supplyNetwork34$psiLeaf, psi2A34$LeafTemperature, lty=3, lwd=1, col=col4)
legend("bottomleft", bty="n", legend=textures, lwd=1, lty=1:3, cex=0.8)

plot(-supplyNetwork11emb$psiLeaf, psi2A11emb$LeafTemperature, type="l", col=col1, ylab="Leaf temperature (ºC)", xlab = "Leaf pressure (-MPa)",  xlim=c(0, 7), ylim=c(26,27.5), lwd=1, main="after cavitation")
lines(-supplyNetwork12emb$psiLeaf,psi2A12emb$LeafTemperature, lty=1, lwd=1, col=col2)
lines(-supplyNetwork13emb$psiLeaf, psi2A13emb$LeafTemperature, lty=1, lwd=1, col=col3)
lines(-supplyNetwork14emb$psiLeaf, psi2A14emb$LeafTemperature, lty=1, lwd=1, col=col4)
lines(-supplyNetwork21emb$psiLeaf, psi2A21emb$LeafTemperature, lty=2, lwd=1, col=col1)
lines(-supplyNetwork22emb$psiLeaf, psi2A22emb$LeafTemperature, lty=2, lwd=1, col=col2)
lines(-supplyNetwork23emb$psiLeaf, psi2A23emb$LeafTemperature, lty=2, lwd=1, col=col3)
lines(-supplyNetwork24emb$psiLeaf, psi2A24emb$LeafTemperature, lty=2, lwd=1, col=col4)
lines(-supplyNetwork31emb$psiLeaf, psi2A31emb$LeafTemperature, lty=3, lwd=1, col=col1)
lines(-supplyNetwork32emb$psiLeaf, psi2A32emb$LeafTemperature, lty=3, lwd=1, col=col2)
lines(-supplyNetwork33emb$psiLeaf, psi2A33emb$LeafTemperature, lty=3, lwd=1, col=col3)
lines(-supplyNetwork34emb$psiLeaf, psi2A34emb$LeafTemperature, lty=3, lwd=1, col=col4)
abline(v=-psiCav, col="gray", lwd=1.5)
legend("bottomleft", bty="n", legend=textures, lwd=1, lty=1:3, cex=0.8)
```

### Leaf vapor pressure deficit

Vapor pressure deficit in the leaf ($e_{leaf}$, in kPa) is calculated as:
\begin{equation}
VPD_{leaf} = e_{leaf} - e_{air}
\end{equation}
Where $e_{air}$ is the water vapor pressure of the air surrounding the leaf (but beyond the leaf boundary layer) and $e_{leaf}$ is the leaf vapor pressure, which can be calculated from leaf temperature ($T_{leaf}$) and leaf water potential ($\Psi_{leaf}$):
\begin{equation}
e_{leaf} = e_{sat}(T_{leaf}) \cdot \exp\left\{\frac{2.17 \cdot \Psi_{leaf}}{T_{leaf}+273.15}\right\}
(\#eq:leafvpequation)
\end{equation}
where $e_{sat}(T)$ is a function giving the saturated vapor pressure for temperature $T$ (see [utility functions](http://vegmod.ctfc.cat/meteolandbook/miscellaneous.html#physicalutils) of the **meteoland** reference manual). If a single-canopy energy balance is considered, the water vapor pressure of the air surrounding the leaf is taken as the average atmospheric water vapor pressure of the day, i.e. $e_{air} = e_{atm}$. When a multi-layer canopy energy balance is simulated, $e_{air}$ will correspond to the water vapor pressure $e_{air,j}$ of the canopy layer $j$ where the leaf is located.

Since $e_{leaf}$ decreases when leaf temperature decreases in eq. \@ref(eq:leafvpequation), increasing transpiration decreases leaf VPD as a result of decreasing leaf temperature. To illustrate this effect, let us assume the following values of relative humidity, yielding a $e_{air} = e_{atm} =1.91\, kPa$:
```{r}
RHmin = 60
RHmax = 75
VPatm = meteoland::utils_averageDailyVP(Tmin, Tmax, RHmin, RHmax)
VPatm
```

The application of the above equation to the $T_{leaf}(\Psi_{leaf})$ curves of fig. \@ref(fig:leaftemperaturefunction) yields the following $VPD_{leaf}(\Psi_{leaf})$ curves:

(ref:leafVPDfunction-cap) Examples of leaf vapour pressure deficit ($VPD_{leaf}$) functions for a hydraulic network, corresponding to fig. \@ref(fig:supplynetwork) and for different soil textures. Left/right panel shows values for uncavitated/cavitated supply functions. 

```{r leafVPDfunction, echo=FALSE, fig.width=8, fig.height=3.5, fig.align="center", fig.cap='(ref:leafVPDfunction-cap)'}
par(mar=c(4,4,2,1), mfrow=c(1,2))
plot(-supplyNetwork11$psiLeaf, psi2A11$LeafVPD, type="l", col=col1, ylab="Leaf VPD (kPa)", xlab = "Leaf pressure (-MPa)",  xlim=c(0, 7), lwd=1, ylim=c(1.3,1.72), main="original")
lines(-supplyNetwork12$psiLeaf,psi2A12$LeafVPD, lty=1, lwd=1, col=col2)
lines(-supplyNetwork13$psiLeaf, psi2A13$LeafVPD, lty=1, lwd=1, col=col3)
lines(-supplyNetwork14$psiLeaf, psi2A14$LeafVPD, lty=1, lwd=1, col=col4)
lines(-supplyNetwork21$psiLeaf, psi2A21$LeafVPD, lty=2, lwd=1, col=col1)
lines(-supplyNetwork22$psiLeaf, psi2A22$LeafVPD, lty=2, lwd=1, col=col2)
lines(-supplyNetwork23$psiLeaf, psi2A23$LeafVPD, lty=2, lwd=1, col=col3)
lines(-supplyNetwork24$psiLeaf, psi2A24$LeafVPD, lty=2, lwd=1, col=col4)
lines(-supplyNetwork31$psiLeaf, psi2A31$LeafVPD, lty=3, lwd=1, col=col1)
lines(-supplyNetwork32$psiLeaf, psi2A32$LeafVPD, lty=3, lwd=1, col=col2)
lines(-supplyNetwork33$psiLeaf, psi2A33$LeafVPD, lty=3, lwd=1, col=col3)
lines(-supplyNetwork34$psiLeaf, psi2A34$LeafVPD, lty=3, lwd=1, col=col4)
legend("bottomleft", bty="n", legend=textures, lwd=1, lty=1:3, cex=0.8)

plot(-supplyNetwork11emb$psiLeaf, psi2A11emb$LeafVPD, type="l", col=col1, ylab="Leaf VPD (kPa)", xlab = "Leaf pressure (-MPa)",  xlim=c(0, 7), lwd=1, ylim=c(1.3,1.72), main="after cavitation")
lines(-supplyNetwork12emb$psiLeaf,psi2A12emb$LeafVPD, lty=1, lwd=1, col=col2)
lines(-supplyNetwork13emb$psiLeaf, psi2A13emb$LeafVPD, lty=1, lwd=1, col=col3)
lines(-supplyNetwork14emb$psiLeaf, psi2A14emb$LeafVPD, lty=1, lwd=1, col=col4)
lines(-supplyNetwork21emb$psiLeaf, psi2A21emb$LeafVPD, lty=2, lwd=1, col=col1)
lines(-supplyNetwork22emb$psiLeaf, psi2A22emb$LeafVPD, lty=2, lwd=1, col=col2)
lines(-supplyNetwork23emb$psiLeaf, psi2A23emb$LeafVPD, lty=2, lwd=1, col=col3)
lines(-supplyNetwork24emb$psiLeaf, psi2A24emb$LeafVPD, lty=2, lwd=1, col=col4)
lines(-supplyNetwork31emb$psiLeaf, psi2A31emb$LeafVPD, lty=3, lwd=1, col=col1)
lines(-supplyNetwork32emb$psiLeaf, psi2A32emb$LeafVPD, lty=3, lwd=1, col=col2)
lines(-supplyNetwork33emb$psiLeaf, psi2A33emb$LeafVPD, lty=3, lwd=1, col=col3)
lines(-supplyNetwork34emb$psiLeaf, psi2A34emb$LeafVPD, lty=3, lwd=1, col=col4)
abline(v=-psiCav, col="gray", lwd=1.5)
legend("bottomleft", bty="n", legend=textures, lwd=1, lty=1:3, cex=0.8)
```
Note that the VPD decreasing curves do not start at the same $VPD_{leaf}$ value despite corresponding to the same $T_{leaf}$ value, because of the effect of $\Psi_{leaf}$ on $e_{leaf}$ in eq. \@ref(eq:leafvpequation).

### Leaf gas exchange

Leaf diffusive conductance to water vapor ($g_{w}$; in $mol\, H_2O \cdot s^{-1} \cdot m^{-2}$) and to carbon dioxide ($g_{c}$; in $mol\,CO_{2} \cdot s^{-1} \cdot m^{-2}$) are obtained for each value of transpiration flow $E$ (here expressed in $mol\, H_2O \cdot s^{-1} \cdot m^{-2}$) and $VPD_{leaf}$ using:
\begin{eqnarray}
g_{w} &=& E \cdot \frac{P_{atm}}{VPD_{leaf}}\\
g_{c} &=& g_{w}/1.6
\end{eqnarray}
Diffusive conductance to water vapour is assumed to be result of stomatal ($g_{sw}$) and boundary layer ($g_{bw}$) conductances (both in $mol\, H_2O \cdot s^{-1} \cdot m^{-2}$). If we estimate $g_{bw}$ using:
\begin{equation}
g_{bw} = 0.397 \cdot (u_{leaf}/d)^{0.5}
\end{equation}
then, stomatal conductance is:
\begin{equation}
g_{sw}^{-1} = g_{w}^{-1} - g_{bw}^{-1} 
\end{equation}
Ensuring here that $g_{w} \leq g_{bw}$ so that $g_{w}^{-1} \geq  g_{bw}^{-1}$. The application of equations for $g_{w}$, $g_{bw}$ and $g_{sw}$ to the $VPD_{leaf}(\Psi_{leaf})$ curves yields the following stomatal conductance $g_{sw}(\Psi_{leaf})$ curves:

(ref:leafGWfunction-cap) Examples of stomatal conductance to water vapour ($g_{sw}$) functions for a hydraulic network, corresponding to fig. \@ref(fig:supplynetwork) and for different soil textures. Left/right panel shows values for uncavitated/cavitated supply functions. Minimum and maximum conductance values ($g_{sw,\min} = 0.0045$ and $g_{sw,\max} = 0.3$) are indicated using dashed lines.

```{r leafGWfunction, echo=FALSE, fig.width=8, fig.height=3.5, fig.align="center", fig.cap='(ref:leafGWfunction-cap)'}
Gmin = 0.0045;
Gmax = 0.3

par(mar=c(4,4,2,1), mfrow=c(1,2))
plot(-supplyNetwork11$psiLeaf, psi2A11$Gsw, type="l", col=col1, ylab="Leaf stomatal conductance", xlab = "Leaf pressure (-MPa)",  xlim=c(0, 7), ylim=c(0,0.5), lwd=1, main="original")
lines(-supplyNetwork12$psiLeaf,psi2A12$Gsw, lty=1, lwd=1, col=col2)
lines(-supplyNetwork13$psiLeaf, psi2A13$Gsw, lty=1, lwd=1, col=col3)
lines(-supplyNetwork14$psiLeaf, psi2A14$Gsw, lty=1, lwd=1, col=col4)
lines(-supplyNetwork21$psiLeaf, psi2A21$Gsw, lty=2, lwd=1, col=col1)
lines(-supplyNetwork22$psiLeaf, psi2A22$Gsw, lty=2, lwd=1, col=col2)
lines(-supplyNetwork23$psiLeaf, psi2A23$Gsw, lty=2, lwd=1, col=col3)
lines(-supplyNetwork24$psiLeaf, psi2A24$Gsw, lty=2, lwd=1, col=col4)
lines(-supplyNetwork31$psiLeaf, psi2A31$Gsw, lty=3, lwd=1, col=col1)
lines(-supplyNetwork32$psiLeaf, psi2A32$Gsw, lty=3, lwd=1, col=col2)
lines(-supplyNetwork33$psiLeaf, psi2A33$Gsw, lty=3, lwd=1, col=col3)
lines(-supplyNetwork34$psiLeaf, psi2A34$Gsw, lty=3, lwd=1, col=col4)
abline(h=Gmin, col="gray", lty=2, lwd=1.5)
abline(h=Gmax, col="gray", lty=2, lwd=1.5)


plot(-supplyNetwork11emb$psiLeaf, psi2A11emb$Gsw, type="l", col=col1, ylab="Leaf stomatal conductance", xlab = "Leaf pressure (-MPa)",  xlim=c(0, 7), ylim=c(0,0.5), lwd=1, main="after cavitation")
lines(-supplyNetwork12emb$psiLeaf,psi2A12emb$Gsw, lty=1, lwd=1, col=col2)
lines(-supplyNetwork13emb$psiLeaf, psi2A13emb$Gsw, lty=1, lwd=1, col=col3)
lines(-supplyNetwork14emb$psiLeaf, psi2A14emb$Gsw, lty=1, lwd=1, col=col4)
lines(-supplyNetwork21emb$psiLeaf, psi2A21emb$Gsw, lty=2, lwd=1, col=col1)
lines(-supplyNetwork22emb$psiLeaf, psi2A22emb$Gsw, lty=2, lwd=1, col=col2)
lines(-supplyNetwork23emb$psiLeaf, psi2A23emb$Gsw, lty=2, lwd=1, col=col3)
lines(-supplyNetwork24emb$psiLeaf, psi2A24emb$Gsw, lty=2, lwd=1, col=col4)
lines(-supplyNetwork31emb$psiLeaf, psi2A31emb$Gsw, lty=3, lwd=1, col=col1)
lines(-supplyNetwork32emb$psiLeaf, psi2A32emb$Gsw, lty=3, lwd=1, col=col2)
lines(-supplyNetwork33emb$psiLeaf, psi2A33emb$Gsw, lty=3, lwd=1, col=col3)
lines(-supplyNetwork34emb$psiLeaf, psi2A34emb$Gsw, lty=3, lwd=1, col=col4)
abline(v=-psiCav, col="gray", lwd=1.5)
abline(h=Gmin, col="gray", lty=2, lwd=1.5)
abline(h=Gmax, col="gray", lty=2, lwd=1.5)
legend("topleft", bty="n", legend=textures, lwd=1, lty=1:3, cex=0.8)
```

In the previous figure we have indicated the thresholds of $g_{sw,\min}$ and $g_{sw,\max}$, the species-specific minimum and maximum water vapour conductances (i.e. conductances when stomata are fully closed and fully open, respectively; see parameters `Gswmin` and `Gswmax` in `SpParamsMED`). $g_{sw}$ cannot exceed $g_{sw,\max}$ so that some flow rates may not be possible (see stomatal regulation below). However, $g_{sw,\max}$ should quickly become non-limiting as soil dries (i.e. reducing $E$) or $VPD_{leaf}$ increases [@Sperry2016]. 

### Leaf photosynthesis
Rubisco-limited photosynthesis rate $A_c$ (in $\mu mol\, CO_2 \cdot s^{-1} \cdot m^{-2}$) is modelled using [@Collatz1991; @Medlyn2002]:
\begin{equation}
A_c=\frac{V_{max}\cdot (C_i- \Gamma*)}{C_i+K_c \cdot (1+ O_a/K_o)}
(\#eq:leafAcequation) 
\end{equation}
where $V_{max}$ is Rubisco's maximum carboxylation rate (in $\mu mol\, CO_2 \cdot s^{-1} \cdot m^{-2}$), $C_i$ is the internal carbon dioxide concentration (in $\mu mol \cdot mol^{-1}$), $\Gamma*$ is the compensation point (in $\mu mol \cdot mol^{-1}$), $K_c$ (in $\mu mol \cdot mol^{-1}$) and $K_o$ (in $mmol \cdot mol^{-1}$) are Michaelis-Menten constants for carboxylation and oxygenation, respectively, and $O_a$ is the atmospheric oxygen concentration (i.e. 209 $mmol \cdot mol^{-1}$). $\Gamma*$, $K_c$ and $K_o$ depend on leaf temperature ($T_{leaf}$, in $^\circ C$) [@Bernacchi2001]:
\begin{eqnarray}
\Gamma* &=& 42.75\cdot e^{\frac{37830\cdot (T_{leaf}-25)}{298\cdot R \cdot (T_{leaf}-273)}}\\
K_c &=& 404.9\cdot e^{\frac{79430\cdot (T_{leaf}-25)}{298\cdot R \cdot (T_{leaf}-273)}}\\
K_o &=& 278.4\cdot e^{\frac{36380\cdot (T_{leaf}-25)}{298\cdot R \cdot (T_{leaf}-273)}}
\end{eqnarray}
Electron transport-limited photosynthesis $A_e$ (in $\mu mol\, CO_2 \cdot s^{-1} \cdot m^{-2}$) was obtained from @Medlyn2002:
\begin{eqnarray}
A_e &=& \frac{J}{4}\cdot \frac{C_i-\Gamma*}{C_i+2\cdot \Gamma*} \\
J &=& \frac{(\alpha\cdot Q^{leaf}_{PAR} + J_{max})-\sqrt{(\alpha\cdot Q^{leaf}_{PAR} + J_{max})^2-4.0\cdot c \cdot \alpha \cdot Q^{leaf}_{PAR} \cdot J_{max}}}{2\cdot c}
\end{eqnarray}
where $\alpha = 0.3\,mol \, e \cdot mol\,photon^{-1}$ is the quantum yield of electron transport, $Q^{leaf}_{PAR}$ is the absorbed PAR photon flux density per leaf area ($\mu mol\,photon \cdot m^{-2} \cdot s^{-1}$), which is calculated from absorbed PAR per leaf area ($\Phi^{leaf}_{PAR}$; in $W \cdot m^{-2}$):
\begin{equation}
Q^{leaf}_{PAR} = \Phi^{leaf}_{PAR}\cdot 546 \cdot 0.836\cdot 10^{-2}
(\#eq:leafQequation) 
\end{equation}
where $546$ is the wavelength in $nm$. $J_{max}$ and $J$ are the maximum and actual rate of electron transport (both in $\mu mol\,e \cdot m^{-2} \cdot s^{-1}$) and $c=0.9$ defines the curvature of the light-response curve. The gross assimilation rate $A$ at a given $C_i$ is the minimum of $A_e$ and $A_c$. To obtain a smooth $A$-vs-$C_i$ curve we used [@Collatz1991]:
\begin{equation}
A = \frac{(A_c+A_e)-\sqrt{(A_c+A_e)^2-4.0\cdot c'\cdot A_e\cdot A_c}}{2\cdot c'}
\end{equation}
where $c'=0.98$ is a curvature factor. The temperature dependence of $J_{max}$ and $V_{max}$ relative to 25ºC (i.e., relative to input parameters $J_{max,298}$ and $V_{max,298}$) is modelled using @Leuning2002 (his eq. 1 with parameters from his Table 2). The internal $CO_2$ concentration, $C_i$, needs to be known to calculate $A$ using the previous equations. @Sperry2016a use a second equation for $A$ which uses $g_{c}$, the diffusive conductance to $CO_2$ (which includes both the stomatal conductance and boundary layer conductance):
\begin{equation}
A = g_{c} \cdot (C_{air}-C_i)
\end{equation}
where $C_{air}$ is the  $CO_{2}$ concentration (in $\mu mol \cdot mol^{-1}$) in the air surrounding the leaf (beyond the leaf boundary layer). If a single-layer canopy energy balance is used then $C_{air}=C_{atm}$, the atmospheric $CO_{2}$ concentration (see parameter \texttt{Catm} in function `defaultControl()`), whereas if a multi-layer canopy energy balance is used $C_{air}$ corresponds to $C_{air,j}$, the $CO_2$ concentration in the canopy layer $j$ where the leaf occurs, analogously to $T_{air}$ and $e_{air}$. Combining the two equations for $A$ and finding the root of the resulting equation using Newton-Raphson method allows determining $C_i$ and therefore $A$. Thus, after defining PAR photon flux density, atmosphere $CO_{2}$ concentration and maximum rate parameters:
```{r}
Q = 2000
Catm = 386
Vmax298 = 100
Jmax298 = 1.67*Vmax298
```

one can obtain the following $A(\Psi_{leaf})$ curves from $T_{leaf}(\Psi_{leaf})$ and $g_{sw}(\Psi_{leaf})$:


(ref:leafphotosynthesisfunction-cap) Examples of gross photosynthesis ($A$) functions for a hydraulic network, corresponding to fig. \@ref(fig:supplynetwork) and for different soil textures. Left/right panel shows values for uncavitated/cavitated supply functions. 

```{r leafphotosynthesisfunction, echo=FALSE, fig.width=8, fig.height=3.5, fig.align="center", fig.cap = '(ref:leafphotosynthesisfunction-cap)'}
par(mar=c(4,4,2,1), mfrow=c(1,2))
plot(-supplyNetwork11$psiLeaf, psi2A11$GrossPhotosynthesis, type="l", col=col1, ylab="Gross assimilation rate", xlab = "Leaf sap pressure (-MPa)",  xlim=c(0, 7), lwd=1, main="original")
lines(-supplyNetwork12$psiLeaf,psi2A12$GrossPhotosynthesis, lty=1, lwd=1, col=col2)
lines(-supplyNetwork13$psiLeaf, psi2A13$GrossPhotosynthesis, lty=1, lwd=1, col=col3)
lines(-supplyNetwork14$psiLeaf, psi2A14$GrossPhotosynthesis, lty=1, lwd=1, col=col4)
lines(-supplyNetwork21$psiLeaf, psi2A21$GrossPhotosynthesis, lty=2, lwd=1, col=col1)
lines(-supplyNetwork22$psiLeaf, psi2A22$GrossPhotosynthesis, lty=2, lwd=1, col=col2)
lines(-supplyNetwork23$psiLeaf, psi2A23$GrossPhotosynthesis, lty=2, lwd=1, col=col3)
lines(-supplyNetwork24$psiLeaf, psi2A24$GrossPhotosynthesis, lty=2, lwd=1, col=col4)
lines(-supplyNetwork31$psiLeaf, psi2A31$GrossPhotosynthesis, lty=3, lwd=1, col=col1)
lines(-supplyNetwork32$psiLeaf, psi2A32$GrossPhotosynthesis, lty=3, lwd=1, col=col2)
lines(-supplyNetwork33$psiLeaf, psi2A33$GrossPhotosynthesis, lty=3, lwd=1, col=col3)
lines(-supplyNetwork34$psiLeaf, psi2A34$GrossPhotosynthesis, lty=3, lwd=1, col=col4)
legend("topright", bty="n", legend=textures, lwd=1, lty=1:3, cex=0.8)

plot(-supplyNetwork11emb$psiLeaf, psi2A11emb$GrossPhotosynthesis, type="l", col=col1, ylab="Gross assimilation rate", xlab = "Leaf sap pressure (-MPa)",  xlim=c(0, 7), lwd=1, main="after cavitation")
lines(-supplyNetwork12emb$psiLeaf,psi2A12emb$GrossPhotosynthesis, lty=1, lwd=1, col=col2)
lines(-supplyNetwork13emb$psiLeaf, psi2A13emb$GrossPhotosynthesis, lty=1, lwd=1, col=col3)
lines(-supplyNetwork14emb$psiLeaf, psi2A14emb$GrossPhotosynthesis, lty=1, lwd=1, col=col4)
lines(-supplyNetwork21emb$psiLeaf, psi2A21emb$GrossPhotosynthesis, lty=2, lwd=1, col=col1)
lines(-supplyNetwork22emb$psiLeaf, psi2A22emb$GrossPhotosynthesis, lty=2, lwd=1, col=col2)
lines(-supplyNetwork23emb$psiLeaf, psi2A23emb$GrossPhotosynthesis, lty=2, lwd=1, col=col3)
lines(-supplyNetwork24emb$psiLeaf, psi2A24emb$GrossPhotosynthesis, lty=2, lwd=1, col=col4)
lines(-supplyNetwork31emb$psiLeaf, psi2A31emb$GrossPhotosynthesis, lty=3, lwd=1, col=col1)
lines(-supplyNetwork32emb$psiLeaf, psi2A32emb$GrossPhotosynthesis, lty=3, lwd=1, col=col2)
lines(-supplyNetwork33emb$psiLeaf, psi2A33emb$GrossPhotosynthesis, lty=3, lwd=1, col=col3)
lines(-supplyNetwork34emb$psiLeaf, psi2A34emb$GrossPhotosynthesis, lty=3, lwd=1, col=col4)
abline(v=-psiCav, col="gray", lwd=1.5)
legend("topright", bty="n", legend=textures, lwd=1, lty=1:3, cex=0.8)
```

Finally, leaf net photosynthesis ($A_n$; i.e. accounting for autotrophic respiration) is calculated as:
\begin{equation}
A_n = A - 0.015 \cdot V_{max}
\end{equation}


## Crown/canopy photosynthesis {#crownphotosynthesis}

In the previous subsection we showed how to calculate photosynthesis at the leaf level, but gross or net assimilation needs to be up-scaled to the crown or canopy levels, while accounting for the variation of leaf photosynthetic conditions across canopies. In this section, we briefly describe different alternatives for canopy/crown photosynthesis and justify our modelling choice. 

### Multi-layer canopy photosynthesis model

Ideally, crown or canopy photosynthesis requires repeating the calculations of leaf temperature, leaf VPD, leaf gas conductance and photosynthesis for every leaf. Multi-layer canopy models, however, divide the canopy into vertical layers and determine photosynthesis for each one (and each plant species or plant cohort, if required). Multi-layer models can account for the fact that environmental variables usually vary across the crown, including direct/diffuse absorbed radiation, air temperature, wind speed, water vapor pressure and $CO_2$ concentration. The amount of SWR and PAR absorbed per unit of leaf area at each canopy layer was shown in fig. \@ref(fig:absorbanceperlayer). 
```{r, include=FALSE}
ulayer = rep(2, 10)
```

Not only environmental factors, but leaves themselves may be different across canopy layers. Importantly, it is generally accepted that sunlit and shade leaves need to be treated separately [@DePury1997]. Separating the two kinds of leaves acknowledges that they operate at different parts of the light-saturation curve. Following @DePury1997, we further assume that maximum carboxylation and electron transport rates are highest for leaves at the top of the canopy and there is a exponential decrease from there towards the bottom, where maximum rates are 50% of those at the top: 
\begin{eqnarray}
V_{max,298,i,j} &=& V_{max,298,i}\cdot \exp(-0.713\cdot \sum_{h>i}{LAI^{\phi}_{h,j}}/LAI_i^{\phi}) \\  
J_{max,298,i,j} &=& J_{max,298,i}\cdot \exp(-0.713\cdot \sum_{h>i}{LAI^{\phi}_{h,j}}/LAI_i^{\phi})    
\end{eqnarray}
where $LAI^{\phi}_{i,j}$ is the LAI value of the plant cohort $i$ at a given canopy layer $j$ and $LAI_i^{\phi}$ is the expanded LAI of the plant cohort. The following figure illustrate this decrease for the single-species canopy example of section \@ref(shortwaveradiationcanopyabs):

```{r, echo=FALSE, fig.width=5, fig.height=4, fig.align="center", fig.cap="Decrease of Rubisco maximum carboxilation rate across the canopy"}
kn = 0.713 #~50% decrease from top to bottom of the canopy
Vmax298layer = numeric(nlayer)
s = 0
for(i in nlayer:1) {
  Vmax298layer[i]=Vmax298*1.5*exp(-kn*(s+LAIlayerlive[i,1]/2)/sum(LAIlayerlive[,1]))
  s =s+LAIlayerlive[i,1]
}
Jmax298layer=Vmax298layer*1.67
plot(Vmax298layer, 1:nlayer,type="l", ylab="Layer", xlab="Maximum carboxylation rate", ylim=c(1,nlayer), col="red")
```

In a multi-layer canopy photosynthesis model, gross and net photosynthesis values (i.e. $A$ and $An$) are determined for sunlit and shade leaves of each cohort in each canopy layer. Then, sunlit and shade photosynthesis values should be averaged across the crown for each plant cohort. Assuming that $\Psi_{leaf}$ is equal for all leaves across the crown, the function $A(\Psi_{leaf})$ would be obtained for each plant cohort. 

### Big-leaf canopy photosynthesis model

Multi-layer canopy photosynthesis models allow evaluating leaf conditions, stomatal conductance and photosynthesis for different points of the canopy. However, this comes at high computational cost. For this reason, many models implement what is called the *big-leaf approximation*. Assuming that wind speed, temperature, water vapor pressure and $CO_2$ concentration are similar for all leaves and that the distribution of photosynthetic capacity between leaves is in proportion to the profile of absorbed irradiance then the equation describing leaf photosynthesis will also represent canopy photosynthesis (Sellers et al. 1992). 

### Sun-shade canopy photosynthesis model

An alternative between multi-layer and big-leaf canopy photosynthesis models is to collapse variation of photosynthetic conditions into two leaf classes: sunlit and shade leaves. While big-leaf canopy models are known to be unaccurate under some situations, sun-shade canopy models [@DePury1997] provide estimates that are close to multiple layer models [@Hikosaka2016]. The sun-shade canopy photosynthesis model was adopted here. Assuming that wind speed, temperature, water vapor pressure and and $CO_2$ concentration are similar for all leaves, sun-shade models involve the following steps: 

a. Aggregate the leaf area of sunlit/shade leaves across layers: 
\begin{eqnarray}
LAI^{sunlit}_{i} &=& \sum_{j=1}^{l}{LAI^{sunlit}_{i,j}} \\
LAI^{shade}_{i} &=& \sum_{j=1}^{l}{LAI^{shade}_{i,j}}
\end{eqnarray}
where $LAI^{sunlit}_{i,j}$ and $LAI^{shade}_{i,j}$ are the leaf area index of sunlit and shade leaves for cohort $i$ in canopy layer $j$, from eq. \@ref(eq:sunlitshadelai).

b. Average the SWR/PAR absorbed by leaves of each kind across layers. The average light absorbed by sunlit/shaded foliage of cohort $i$ per ground area unit is found using:
\begin{eqnarray}
\Phi^{sunlit}_{abs,i} &=& \frac{\sum_{j=1}^{l}{K^{sunlit}_{abs,i,j}}}{LAI^{sunlit}_{i}} \\
\Phi^{shade}_{abs,i} &=& \frac{\sum_{j=1}^{l}{K^{shade}_{abs,i,j}}}{LAI^{shade}_{i}}
\end{eqnarray}
where $K^{sunlit}_{abs,i,j}$ and $K^{shade}_{abs,i,j}$ are the light absorbed per ground area unit by sunlit/shade leaves of cohort $i$ at layer $j$ (see section \@ref(shortwaveradiationcanopyabs)). Analogous equations were already given for the net long-wave radiation balance of sunlit leaves ($L^{sunlit}_{net,i}$) and shade leaves ($L^{shade}_{net,i}$) in section \@ref(longwaveradiationcohorts).

c. Average the maximum carboxylation (respectively, electron transport) rates across layers, again separating sunlit and shade leaves: 
\begin{eqnarray}
V^{sunlit}_{max,298,i} &=& \frac{\sum_{j=1}^{l}{V_{max,298,i,j} \cdot LAI^{sunlit}_{i,j}}}{LAI^{sunlit}_{i}} \\
V^{shade}_{max,298,i} &=& \frac{\sum_{j=1}^{l}{V_{max,298,i,j} \cdot LAI^{shade}_{i,j}}}{LAI^{shade}_{i}}
\end{eqnarray}

d. Use $V^{sunlit}_{max,298,i}$ as $V_{max,298}$ in @Leuning2002 to obtain $V_{max}$ for eq. \@ref(eq:leafAcequation); $\Phi^{sunlit}_{SWR,i}$ as $\Phi^{leaf}_{SWR}$ and $L^{sunlit}_{net,i}$ as $L^{leaf}_{net}$ in eq. \@ref(eq:leaftemperatureequation); and $\Phi^{sunlit}_{PAR,i}$ as $\Phi_{PAR}^{leaf}$ in eq. \@ref(eq:leafQequation) to estimate sunlit leaf photosynthesis, which can be up-scaled to the crown level multiplying by $LAI^{sunlit}_{i}$. The same would be done for shade leaves. In a sun-shade canopy model one then calls the photosynthesis function twice (i.e. once for shade leaves and once for sunlit leaves) for each plant cohort $i$.

### Comparison of big-leaf, sun-shade and multi-canopy photosynthesis models

The figure below provides the canopy photosynthesis functions obtained using the multi-layer canopy photosynthesis model (top), a sunshade canopy photosynthesis model (center) or a big-leaf photosynthesis model (bottom). These were generated using functions `photo_multilayerPhotosynthesisFunction()`, `photo_sunshadePhotosynthesisFunction()` and `photo_leafPhotosynthesisFunction()`, respectively, and assuming homogeneous wind, temperature and water vapor pressure through the canopy. Thus, only absorbed radiation varied across layers and leaf types. Note the coincidence between the multi-layer and the sun-shade models.

```{r, echo=FALSE}
psi2A11can = photo_multilayerPhotosynthesisFunction(supplyNetwork11$E,supplyNetwork11$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298layer, Jmax298layer)
psi2A12can = photo_multilayerPhotosynthesisFunction(supplyNetwork12$E,supplyNetwork12$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298layer, Jmax298layer)
psi2A13can = photo_multilayerPhotosynthesisFunction(supplyNetwork13$E,supplyNetwork13$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298layer, Jmax298layer)
psi2A14can = photo_multilayerPhotosynthesisFunction(supplyNetwork14$E,supplyNetwork14$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298layer, Jmax298layer)
psi2A21can = photo_multilayerPhotosynthesisFunction(supplyNetwork21$E,supplyNetwork21$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298layer, Jmax298layer)
psi2A22can = photo_multilayerPhotosynthesisFunction(supplyNetwork22$E,supplyNetwork22$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298layer, Jmax298layer)
psi2A23can = photo_multilayerPhotosynthesisFunction(supplyNetwork23$E,supplyNetwork23$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298layer, Jmax298layer)
psi2A24can = photo_multilayerPhotosynthesisFunction(supplyNetwork24$E,supplyNetwork24$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298layer, Jmax298layer)
psi2A31can = photo_multilayerPhotosynthesisFunction(supplyNetwork31$E,supplyNetwork31$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298layer, Jmax298layer)
psi2A32can = photo_multilayerPhotosynthesisFunction(supplyNetwork32$E,supplyNetwork32$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298layer, Jmax298layer)
psi2A33can = photo_multilayerPhotosynthesisFunction(supplyNetwork33$E,supplyNetwork33$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298layer, Jmax298layer)
psi2A34can = photo_multilayerPhotosynthesisFunction(supplyNetwork34$E,supplyNetwork34$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298layer, Jmax298layer)

psi2A11canemb = photo_multilayerPhotosynthesisFunction(supplyNetwork11emb$E,supplyNetwork11emb$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298layer, Jmax298layer)
psi2A12canemb = photo_multilayerPhotosynthesisFunction(supplyNetwork12emb$E,supplyNetwork12emb$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298layer, Jmax298layer)
psi2A13canemb = photo_multilayerPhotosynthesisFunction(supplyNetwork13emb$E,supplyNetwork13emb$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298layer, Jmax298layer)
psi2A14canemb = photo_multilayerPhotosynthesisFunction(supplyNetwork14emb$E,supplyNetwork14emb$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298layer, Jmax298layer)
psi2A21canemb = photo_multilayerPhotosynthesisFunction(supplyNetwork21emb$E,supplyNetwork21emb$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298layer, Jmax298layer)
psi2A22canemb = photo_multilayerPhotosynthesisFunction(supplyNetwork22emb$E,supplyNetwork22emb$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298layer, Jmax298layer)
psi2A23canemb = photo_multilayerPhotosynthesisFunction(supplyNetwork23emb$E,supplyNetwork23emb$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298layer, Jmax298layer)
psi2A24canemb = photo_multilayerPhotosynthesisFunction(supplyNetwork24emb$E,supplyNetwork24emb$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298layer, Jmax298layer)
psi2A31canemb = photo_multilayerPhotosynthesisFunction(supplyNetwork31emb$E,supplyNetwork31emb$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298layer, Jmax298layer)
psi2A32canemb = photo_multilayerPhotosynthesisFunction(supplyNetwork32emb$E,supplyNetwork32emb$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298layer, Jmax298layer)
psi2A33canemb = photo_multilayerPhotosynthesisFunction(supplyNetwork33emb$E,supplyNetwork33emb$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298layer, Jmax298layer)
psi2A34canemb = photo_multilayerPhotosynthesisFunction(supplyNetwork34emb$E,supplyNetwork34emb$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298layer, Jmax298layer)


SLarea = sum(SLarea)
SHarea = sum(SHarea)
QSL = sum(QSL*LAIlayerlive[,1]*fsunlit)
QSH = sum(QSH*LAIlayerlive[,1]*(1-fsunlit))
absRadSL = sum(absRadSL*LAIlayerlive[,1]*fsunlit)
absRadSH = sum(absRadSH*LAIlayerlive[,1]*(1-fsunlit))
Vmax298SL= sum(Vmax298layer*LAIlayerlive[,1]*fsunlit)
Jmax298SL = sum(Jmax298layer*LAIlayerlive[,1]*fsunlit)
Vmax298SH= sum(Vmax298layer*LAIlayerlive[,1]*(1-fsunlit))
Jmax298SH = sum(Jmax298layer*LAIlayerlive[,1]*(1-fsunlit))
ulayer = ulayer[1]

psi2A11ss = photo_sunshadePhotosynthesisFunction(supplyNetwork11$E,supplyNetwork11$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298SL, Vmax298SH, Jmax298SL, Jmax298SH)
psi2A12ss = photo_sunshadePhotosynthesisFunction(supplyNetwork12$E,supplyNetwork12$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298SL, Vmax298SH, Jmax298SL, Jmax298SH)
psi2A13ss = photo_sunshadePhotosynthesisFunction(supplyNetwork13$E,supplyNetwork13$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298SL, Vmax298SH, Jmax298SL, Jmax298SH)
psi2A14ss = photo_sunshadePhotosynthesisFunction(supplyNetwork14$E,supplyNetwork14$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298SL, Vmax298SH, Jmax298SL, Jmax298SH)
psi2A21ss = photo_sunshadePhotosynthesisFunction(supplyNetwork21$E,supplyNetwork21$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298SL, Vmax298SH, Jmax298SL, Jmax298SH)
psi2A22ss = photo_sunshadePhotosynthesisFunction(supplyNetwork22$E,supplyNetwork22$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298SL, Vmax298SH, Jmax298SL, Jmax298SH)
psi2A23ss = photo_sunshadePhotosynthesisFunction(supplyNetwork23$E,supplyNetwork23$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298SL, Vmax298SH, Jmax298SL, Jmax298SH)
psi2A24ss = photo_sunshadePhotosynthesisFunction(supplyNetwork24$E,supplyNetwork24$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298SL, Vmax298SH, Jmax298SL, Jmax298SH)
psi2A31ss = photo_sunshadePhotosynthesisFunction(supplyNetwork31$E,supplyNetwork31$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298SL, Vmax298SH, Jmax298SL, Jmax298SH)
psi2A32ss = photo_sunshadePhotosynthesisFunction(supplyNetwork32$E,supplyNetwork32$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298SL, Vmax298SH, Jmax298SL, Jmax298SH)
psi2A33ss = photo_sunshadePhotosynthesisFunction(supplyNetwork33$E,supplyNetwork33$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298SL, Vmax298SH, Jmax298SL, Jmax298SH)
psi2A34ss = photo_sunshadePhotosynthesisFunction(supplyNetwork34$E,supplyNetwork34$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298SL, Vmax298SH, Jmax298SL, Jmax298SH)
psi2A11ssemb = photo_sunshadePhotosynthesisFunction(supplyNetwork11emb$E,supplyNetwork11emb$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298SL, Vmax298SH, Jmax298SL, Jmax298SH)
psi2A12ssemb = photo_sunshadePhotosynthesisFunction(supplyNetwork12emb$E,supplyNetwork12emb$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298SL, Vmax298SH, Jmax298SL, Jmax298SH)
psi2A13ssemb = photo_sunshadePhotosynthesisFunction(supplyNetwork13emb$E,supplyNetwork13emb$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298SL, Vmax298SH, Jmax298SL, Jmax298SH)
psi2A14ssemb = photo_sunshadePhotosynthesisFunction(supplyNetwork14emb$E,supplyNetwork14emb$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298SL, Vmax298SH, Jmax298SL, Jmax298SH)
psi2A21ssemb = photo_sunshadePhotosynthesisFunction(supplyNetwork21emb$E,supplyNetwork21emb$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298SL, Vmax298SH, Jmax298SL, Jmax298SH)
psi2A22ssemb = photo_sunshadePhotosynthesisFunction(supplyNetwork22emb$E,supplyNetwork22emb$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298SL, Vmax298SH, Jmax298SL, Jmax298SH)
psi2A23ssemb = photo_sunshadePhotosynthesisFunction(supplyNetwork23emb$E,supplyNetwork23emb$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298SL, Vmax298SH, Jmax298SL, Jmax298SH)
psi2A24ssemb = photo_sunshadePhotosynthesisFunction(supplyNetwork24emb$E,supplyNetwork24emb$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298SL, Vmax298SH, Jmax298SL, Jmax298SH)
psi2A31ssemb = photo_sunshadePhotosynthesisFunction(supplyNetwork31emb$E,supplyNetwork31emb$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298SL, Vmax298SH, Jmax298SL, Jmax298SH)
psi2A32ssemb = photo_sunshadePhotosynthesisFunction(supplyNetwork32emb$E,supplyNetwork32emb$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298SL, Vmax298SH, Jmax298SL, Jmax298SH)
psi2A33ssemb = photo_sunshadePhotosynthesisFunction(supplyNetwork33emb$E,supplyNetwork33emb$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298SL, Vmax298SH, Jmax298SL, Jmax298SH)
psi2A34ssemb = photo_sunshadePhotosynthesisFunction(supplyNetwork34emb$E,supplyNetwork34emb$psiLeaf,Catm, Patm,Tcan, VPatm, 
                                                SLarea, SHarea, ulayer, 
                                                absRadSL, absRadSH, QSL, QSH,
                                                Vmax298SL, Vmax298SH, Jmax298SL, Jmax298SH)

BLarea = SLarea+SHarea
QBL = QSL+QSH
absRadBL = absRadSL+absRadSH
Vmax298BL = Vmax298SL + Vmax298SH
Jmax298BL = Jmax298SL + Jmax298SH
Gmax = 2.0
psi2A11bl = photo_leafPhotosynthesisFunction(supplyNetwork11$E, supplyNetwork11$psiLeaf,Catm, Patm,Tcan, VPatm, ulayer,
                                             absRadBL,QBL,Vmax298BL, Jmax298BL, 1.0, BLarea)
psi2A12bl = photo_leafPhotosynthesisFunction(supplyNetwork12$E, supplyNetwork12$psiLeaf,Catm, Patm,Tcan, VPatm,  ulayer,
                                             absRadBL,QBL,Vmax298BL, Jmax298BL, 1.0, BLarea)
psi2A13bl = photo_leafPhotosynthesisFunction(supplyNetwork13$E, supplyNetwork13$psiLeaf,Catm, Patm,Tcan, VPatm,  ulayer,
                                             absRadBL,QBL,Vmax298BL, Jmax298BL, 1.0, BLarea)
psi2A14bl = photo_leafPhotosynthesisFunction(supplyNetwork14$E, supplyNetwork14$psiLeaf,Catm, Patm,Tcan, VPatm,  ulayer,
                                             absRadBL,QBL,Vmax298BL, Jmax298BL, 1.0, BLarea)
psi2A21bl = photo_leafPhotosynthesisFunction(supplyNetwork21$E, supplyNetwork21$psiLeaf,Catm, Patm,Tcan, VPatm,  ulayer,
                                             absRadBL,QBL,Vmax298BL, Jmax298BL, 1.0, BLarea)
psi2A22bl = photo_leafPhotosynthesisFunction(supplyNetwork22$E, supplyNetwork22$psiLeaf,Catm, Patm,Tcan, VPatm,  ulayer,
                                             absRadBL,QBL,Vmax298BL, Jmax298BL, 1.0, BLarea)
psi2A23bl = photo_leafPhotosynthesisFunction(supplyNetwork23$E, supplyNetwork23$psiLeaf,Catm, Patm,Tcan, VPatm,  ulayer,
                                             absRadBL,QBL,Vmax298BL, Jmax298BL, 1.0, BLarea)
psi2A24bl = photo_leafPhotosynthesisFunction(supplyNetwork24$E, supplyNetwork24$psiLeaf,Catm, Patm,Tcan, VPatm,  ulayer,
                                             absRadBL,QBL,Vmax298BL, Jmax298BL, 1.0, BLarea)
psi2A31bl = photo_leafPhotosynthesisFunction(supplyNetwork31$E, supplyNetwork31$psiLeaf,Catm, Patm,Tcan, VPatm,  ulayer,
                                             absRadBL,QBL,Vmax298BL, Jmax298BL, 1.0, BLarea)
psi2A32bl = photo_leafPhotosynthesisFunction(supplyNetwork32$E, supplyNetwork32$psiLeaf,Catm, Patm,Tcan, VPatm,  ulayer,
                                             absRadBL,QBL,Vmax298BL, Jmax298BL, 1.0, BLarea)
psi2A33bl = photo_leafPhotosynthesisFunction(supplyNetwork33$E, supplyNetwork33$psiLeaf,Catm, Patm,Tcan, VPatm,  ulayer,
                                             absRadBL,QBL,Vmax298BL, Jmax298BL, 1.0, BLarea)
psi2A34bl = photo_leafPhotosynthesisFunction(supplyNetwork34$E, supplyNetwork34$psiLeaf,Catm, Patm,Tcan, VPatm,  ulayer,
                                             absRadBL,QBL,Vmax298BL, Jmax298BL, 1.0, BLarea)

psi2A11blemb = photo_leafPhotosynthesisFunction(supplyNetwork11emb$E, supplyNetwork11emb$psiLeaf,Catm, Patm,Tcan, VPatm, ulayer,
                                             absRadBL,QBL,Vmax298BL, Jmax298BL, 1.0, BLarea)
psi2A12blemb = photo_leafPhotosynthesisFunction(supplyNetwork12emb$E, supplyNetwork12emb$psiLeaf,Catm, Patm,Tcan, VPatm,  ulayer,
                                             absRadBL,QBL,Vmax298BL, Jmax298BL, 1.0, BLarea)
psi2A13blemb = photo_leafPhotosynthesisFunction(supplyNetwork13emb$E, supplyNetwork13emb$psiLeaf,Catm, Patm,Tcan, VPatm,  ulayer,
                                             absRadBL,QBL,Vmax298BL, Jmax298BL, 1.0, BLarea)
psi2A14blemb = photo_leafPhotosynthesisFunction(supplyNetwork14emb$E, supplyNetwork14emb$psiLeaf,Catm, Patm,Tcan, VPatm,  ulayer,
                                             absRadBL,QBL,Vmax298BL, Jmax298BL, 1.0, BLarea)
psi2A21blemb = photo_leafPhotosynthesisFunction(supplyNetwork21emb$E, supplyNetwork21emb$psiLeaf,Catm, Patm,Tcan, VPatm,  ulayer,
                                             absRadBL,QBL,Vmax298BL, Jmax298BL, 1.0, BLarea)
psi2A22blemb = photo_leafPhotosynthesisFunction(supplyNetwork22emb$E, supplyNetwork22emb$psiLeaf,Catm, Patm,Tcan, VPatm,  ulayer,
                                             absRadBL,QBL,Vmax298BL, Jmax298BL, 1.0, BLarea)
psi2A23blemb = photo_leafPhotosynthesisFunction(supplyNetwork23emb$E, supplyNetwork23emb$psiLeaf,Catm, Patm,Tcan, VPatm,  ulayer,
                                             absRadBL,QBL,Vmax298BL, Jmax298BL, 1.0, BLarea)
psi2A24blemb = photo_leafPhotosynthesisFunction(supplyNetwork24emb$E, supplyNetwork24emb$psiLeaf,Catm, Patm,Tcan, VPatm,  ulayer,
                                             absRadBL,QBL,Vmax298BL, Jmax298BL, 1.0, BLarea)
psi2A31blemb = photo_leafPhotosynthesisFunction(supplyNetwork31emb$E, supplyNetwork31emb$psiLeaf,Catm, Patm,Tcan, VPatm,  ulayer,
                                             absRadBL,QBL,Vmax298BL, Jmax298BL, 1.0, BLarea)
psi2A32blemb = photo_leafPhotosynthesisFunction(supplyNetwork32emb$E, supplyNetwork32emb$psiLeaf,Catm, Patm,Tcan, VPatm,  ulayer,
                                             absRadBL,QBL,Vmax298BL, Jmax298BL, 1.0, BLarea)
psi2A33blemb = photo_leafPhotosynthesisFunction(supplyNetwork33emb$E, supplyNetwork33emb$psiLeaf,Catm, Patm,Tcan, VPatm,  ulayer,
                                             absRadBL,QBL,Vmax298BL, Jmax298BL, 1.0, BLarea)
psi2A34blemb = photo_leafPhotosynthesisFunction(supplyNetwork34emb$E, supplyNetwork34emb$psiLeaf,Catm, Patm,Tcan, VPatm,  ulayer,
                                             absRadBL,QBL,Vmax298BL, Jmax298BL, 1.0, BLarea)
Gmax = 0.5
```

(ref:canopyphoto-cap) Whole-canopy photosynthesis functions obtained for a hydraulic network, corresponding to fig. \@ref(fig:supplynetwork) and different soil textures, using the multi-layer canopy photosynthesis model (top), a sunshade canopy photosynthesis model (center) or a big-leaf photosynthesis model (bottom). Left/right panel shows values for uncavitated/cavitated supply functions. 

```{r canopyphoto, echo=FALSE, fig.width=7, fig.height=10, fig.align="center", fig.cap="(ref:canopyphoto-cap)"}
par(mar=c(4,4,2,1), mfrow=c(3,2))
plot(-supplyNetwork11$psiLeaf, psi2A11can$GrossPhotosynthesis, type="l", col=col1, ylab="Multilayer photosynthesis", xlab = "Leaf pressure (-MPa)",  xlim=c(0, 7), lwd=1, main="original")
lines(-supplyNetwork12$psiLeaf,psi2A12can$GrossPhotosynthesis, lty=1, lwd=1, col=col2)
lines(-supplyNetwork13$psiLeaf, psi2A13can$GrossPhotosynthesis, lty=1, lwd=1, col=col3)
lines(-supplyNetwork14$psiLeaf, psi2A14can$GrossPhotosynthesis, lty=1, lwd=1, col=col4)
lines(-supplyNetwork21$psiLeaf, psi2A21can$GrossPhotosynthesis, lty=2, lwd=1, col=col1)
lines(-supplyNetwork22$psiLeaf, psi2A22can$GrossPhotosynthesis, lty=2, lwd=1, col=col2)
lines(-supplyNetwork23$psiLeaf, psi2A23can$GrossPhotosynthesis, lty=2, lwd=1, col=col3)
lines(-supplyNetwork24$psiLeaf, psi2A24can$GrossPhotosynthesis, lty=2, lwd=1, col=col4)
lines(-supplyNetwork31$psiLeaf, psi2A31can$GrossPhotosynthesis, lty=3, lwd=1, col=col1)
lines(-supplyNetwork32$psiLeaf, psi2A32can$GrossPhotosynthesis, lty=3, lwd=1, col=col2)
lines(-supplyNetwork33$psiLeaf, psi2A33can$GrossPhotosynthesis, lty=3, lwd=1, col=col3)
lines(-supplyNetwork34$psiLeaf, psi2A34can$GrossPhotosynthesis, lty=3, lwd=1, col=col4)
legend("bottomright", bty="n", legend=textures, lwd=1, lty=1:3, cex=0.8)

plot(-supplyNetwork11emb$psiLeaf, psi2A11canemb$GrossPhotosynthesis, type="l", col=col1, ylab="Multilayer photosynthesis", xlab = "Leaf pressure (-MPa)",  xlim=c(0, 7), lwd=1, main="after cavitation")
lines(-supplyNetwork12emb$psiLeaf,psi2A12canemb$GrossPhotosynthesis, lty=1, lwd=1, col=col2)
lines(-supplyNetwork13emb$psiLeaf, psi2A13canemb$GrossPhotosynthesis, lty=1, lwd=1, col=col3)
lines(-supplyNetwork14emb$psiLeaf, psi2A14canemb$GrossPhotosynthesis, lty=1, lwd=1, col=col4)
lines(-supplyNetwork21emb$psiLeaf, psi2A21canemb$GrossPhotosynthesis, lty=2, lwd=1, col=col1)
lines(-supplyNetwork22emb$psiLeaf, psi2A22canemb$GrossPhotosynthesis, lty=2, lwd=1, col=col2)
lines(-supplyNetwork23emb$psiLeaf, psi2A23canemb$GrossPhotosynthesis, lty=2, lwd=1, col=col3)
lines(-supplyNetwork24emb$psiLeaf, psi2A24canemb$GrossPhotosynthesis, lty=2, lwd=1, col=col4)
lines(-supplyNetwork31emb$psiLeaf, psi2A31canemb$GrossPhotosynthesis, lty=3, lwd=1, col=col1)
lines(-supplyNetwork32emb$psiLeaf, psi2A32canemb$GrossPhotosynthesis, lty=3, lwd=1, col=col2)
lines(-supplyNetwork33emb$psiLeaf, psi2A33canemb$GrossPhotosynthesis, lty=3, lwd=1, col=col3)
lines(-supplyNetwork34emb$psiLeaf, psi2A34canemb$GrossPhotosynthesis, lty=3, lwd=1, col=col4)
legend("bottomright", bty="n", legend=textures, lwd=1, lty=1:3, cex=0.8)

plot(-supplyNetwork11$psiLeaf, psi2A11ss$GrossPhotosynthesis, type="l", col=col1, ylab="Sun-shade photosynthesis", xlab = "Leaf pressure (-MPa)",  xlim=c(0, 7), lwd=1, main="original")
lines(-supplyNetwork12$psiLeaf,psi2A12ss$GrossPhotosynthesis, lty=1, lwd=1, col=col2)
lines(-supplyNetwork13$psiLeaf, psi2A13ss$GrossPhotosynthesis, lty=1, lwd=1, col=col3)
lines(-supplyNetwork14$psiLeaf, psi2A14ss$GrossPhotosynthesis, lty=1, lwd=1, col=col4)
lines(-supplyNetwork21$psiLeaf, psi2A21ss$GrossPhotosynthesis, lty=2, lwd=1, col=col1)
lines(-supplyNetwork22$psiLeaf, psi2A22ss$GrossPhotosynthesis, lty=2, lwd=1, col=col2)
lines(-supplyNetwork23$psiLeaf, psi2A23ss$GrossPhotosynthesis, lty=2, lwd=1, col=col3)
lines(-supplyNetwork24$psiLeaf, psi2A24ss$GrossPhotosynthesis, lty=2, lwd=1, col=col4)
lines(-supplyNetwork31$psiLeaf, psi2A31ss$GrossPhotosynthesis, lty=3, lwd=1, col=col1)
lines(-supplyNetwork32$psiLeaf, psi2A32ss$GrossPhotosynthesis, lty=3, lwd=1, col=col2)
lines(-supplyNetwork33$psiLeaf, psi2A33ss$GrossPhotosynthesis, lty=3, lwd=1, col=col3)
lines(-supplyNetwork34$psiLeaf, psi2A34ss$GrossPhotosynthesis, lty=3, lwd=1, col=col4)
legend("bottomright", bty="n", legend=textures, lwd=1, lty=1:3, cex=0.8)

plot(-supplyNetwork11emb$psiLeaf, psi2A11ssemb$GrossPhotosynthesis, type="l", col=col1, ylab="Sun-shade photosynthesis", xlab = "Leaf pressure (-MPa)",  xlim=c(0, 7), lwd=1, main="after cavitation")
lines(-supplyNetwork12emb$psiLeaf,psi2A12ssemb$GrossPhotosynthesis, lty=1, lwd=1, col=col2)
lines(-supplyNetwork13emb$psiLeaf, psi2A13ssemb$GrossPhotosynthesis, lty=1, lwd=1, col=col3)
lines(-supplyNetwork14emb$psiLeaf, psi2A14ssemb$GrossPhotosynthesis, lty=1, lwd=1, col=col4)
lines(-supplyNetwork21emb$psiLeaf, psi2A21ssemb$GrossPhotosynthesis, lty=2, lwd=1, col=col1)
lines(-supplyNetwork22emb$psiLeaf, psi2A22ssemb$GrossPhotosynthesis, lty=2, lwd=1, col=col2)
lines(-supplyNetwork23emb$psiLeaf, psi2A23ssemb$GrossPhotosynthesis, lty=2, lwd=1, col=col3)
lines(-supplyNetwork24emb$psiLeaf, psi2A24ssemb$GrossPhotosynthesis, lty=2, lwd=1, col=col4)
lines(-supplyNetwork31emb$psiLeaf, psi2A31ssemb$GrossPhotosynthesis, lty=3, lwd=1, col=col1)
lines(-supplyNetwork32emb$psiLeaf, psi2A32ssemb$GrossPhotosynthesis, lty=3, lwd=1, col=col2)
lines(-supplyNetwork33emb$psiLeaf, psi2A33ssemb$GrossPhotosynthesis, lty=3, lwd=1, col=col3)
lines(-supplyNetwork34emb$psiLeaf, psi2A34ssemb$GrossPhotosynthesis, lty=3, lwd=1, col=col4)
legend("bottomright", bty="n", legend=textures, lwd=1, lty=1:3, cex=0.8)

plot(-supplyNetwork11$psiLeaf, psi2A11bl$GrossPhotosynthesis, type="l", col=col1, ylab="Big-leaf photosynthesis", xlab = "Leaf pressure (-MPa)",  xlim=c(0, 7), lwd=1, main="original")
lines(-supplyNetwork12$psiLeaf,psi2A12bl$GrossPhotosynthesis, lty=1, lwd=1, col=col2)
lines(-supplyNetwork13$psiLeaf, psi2A13bl$GrossPhotosynthesis, lty=1, lwd=1, col=col3)
lines(-supplyNetwork14$psiLeaf, psi2A14bl$GrossPhotosynthesis, lty=1, lwd=1, col=col4)
lines(-supplyNetwork21$psiLeaf, psi2A21bl$GrossPhotosynthesis, lty=2, lwd=1, col=col1)
lines(-supplyNetwork22$psiLeaf, psi2A22bl$GrossPhotosynthesis, lty=2, lwd=1, col=col2)
lines(-supplyNetwork23$psiLeaf, psi2A23bl$GrossPhotosynthesis, lty=2, lwd=1, col=col3)
lines(-supplyNetwork24$psiLeaf, psi2A24bl$GrossPhotosynthesis, lty=2, lwd=1, col=col4)
lines(-supplyNetwork31$psiLeaf, psi2A31bl$GrossPhotosynthesis, lty=3, lwd=1, col=col1)
lines(-supplyNetwork32$psiLeaf, psi2A32bl$GrossPhotosynthesis, lty=3, lwd=1, col=col2)
lines(-supplyNetwork33$psiLeaf, psi2A33bl$GrossPhotosynthesis, lty=3, lwd=1, col=col3)
lines(-supplyNetwork34$psiLeaf, psi2A34bl$GrossPhotosynthesis, lty=3, lwd=1, col=col4)
legend("bottomright", bty="n", legend=textures, lwd=1, lty=1:3, cex=0.8)

plot(-supplyNetwork11emb$psiLeaf, psi2A11blemb$GrossPhotosynthesis, type="l", col=col1, ylab="Big-leaf photosynthesis", xlab = "Leaf pressure (-MPa)",  xlim=c(0, 7), lwd=1, main="after cavitation")
lines(-supplyNetwork12emb$psiLeaf,psi2A12blemb$GrossPhotosynthesis, lty=1, lwd=1, col=col2)
lines(-supplyNetwork13emb$psiLeaf, psi2A13blemb$GrossPhotosynthesis, lty=1, lwd=1, col=col3)
lines(-supplyNetwork14emb$psiLeaf, psi2A14blemb$GrossPhotosynthesis, lty=1, lwd=1, col=col4)
lines(-supplyNetwork21emb$psiLeaf, psi2A21blemb$GrossPhotosynthesis, lty=2, lwd=1, col=col1)
lines(-supplyNetwork22emb$psiLeaf, psi2A22blemb$GrossPhotosynthesis, lty=2, lwd=1, col=col2)
lines(-supplyNetwork23emb$psiLeaf, psi2A23blemb$GrossPhotosynthesis, lty=2, lwd=1, col=col3)
lines(-supplyNetwork24emb$psiLeaf, psi2A24blemb$GrossPhotosynthesis, lty=2, lwd=1, col=col4)
lines(-supplyNetwork31emb$psiLeaf, psi2A31blemb$GrossPhotosynthesis, lty=3, lwd=1, col=col1)
lines(-supplyNetwork32emb$psiLeaf, psi2A32blemb$GrossPhotosynthesis, lty=3, lwd=1, col=col2)
lines(-supplyNetwork33emb$psiLeaf, psi2A33blemb$GrossPhotosynthesis, lty=3, lwd=1, col=col3)
lines(-supplyNetwork34emb$psiLeaf, psi2A34blemb$GrossPhotosynthesis, lty=3, lwd=1, col=col4)
legend("bottomright", bty="n", legend=textures, lwd=1, lty=1:3, cex=0.8)
```

### Within-canopy variation in environmental conditions

When presenting the sun-shade photosynthesis model, we assumed constant wind, temperature, water vapor pressure and $CO_2$ concentration values through the canopy. If a single-layer canopy energy balance is used, $CO_2$ concentration and vapor pressure are assumed equal to the atmosphere (i.e., $e_{air}  = e_{atm}$ and $C_{air} = C_{atm}$), whereas air temperature is that of the canopy (i.e., $T_{air} = T_{can}$), but leaf-level wind speed ($u_{leaf}$) can still be different for different canopy layers. If a multi-layer canopy energy balance is used, all four environmental variables can differ between canopy layers (i.e. $T_{air,j}$, $e_{air,j}$, $C_{air,j}$ and $u_j$). In the sun-shade photosynthesis model, the question arises on how to determine layer $j$ for sunlit or shade leaves of a given cohort $i$. The choice is done by calculating the height corresponding to the mass center of sunlit leaves or shade leaves of each cohort $i$. The canopy layer $j$ where this mass center height is contained is chosen as the layer from which environmental conditions will be taken. For any given plant cohort $i$, sunlit leaves will take their environmental conditions from layers above (or equal to) those corresponding to shade leaves.
# Transpiration, photosynthesis and drought stress under Granier's model {#transpirationgranier}

This chapter describes how daily plant transpiration is modelled in the basic water balance model, completing the flows needed to evaluate eq. \@ref(eq:basicwaterbalanceequation). The model uses the approach of BILJOU [@Granier1999] to estimate stand maximum transpiration, and then divides this value among the contribution of plant cohorts and estimate actual transpiration depending on soil moisture and cohort functional parameters, which determine plant drought. The chapter also describes how is daily photosynthesis estimated, a process that in this model does not influence transpiration but is necessary for growth calculations (chapter \@ref(growthmodelling)). 

## Plant transpiration and photosynthesis
### Maximum transpiration {#maximumtranspiration}

Potential evapotranspiration ($PET$, in mm) is assumed to represent open water evaporation potential. Maximum canopy transpiration $Tr_{\max}$ depends on both $PET$ and the amount of transpirating surface, i.e. the current cumulative $LAI$ of the stand, $LAI^{\phi}_{stand}$. To estimate $Tr_{\max}$ the model uses the empirical equation of @Granier1999, where $Tr_{\max}/PET$ is a function of $LAI^{\phi}_{stand}$:

\begin{equation}
\frac{Tr_{\max}}{PET}= -0.006\cdot (LAI^{\phi}_{stand})^2+0.134\cdot LAI^{\phi}_{stand}+0.036
\end{equation}
This equation has already been adopted for Mediterranean biomes [@Fyllas2009; @Ruffault2013]. 

(ref:tmaxpet-cap) Empirical relationship between $Tr_{\max}/PET$ and $LAI^{\phi}_{stand}$

```{r tmaxpet, fig.width=4, fig.height=4, fig.align = "center", echo=FALSE, fig.cap='(ref:tmaxpet-cap)'}
par(mar=c(4,4,1,1))
LAIc = seq(0,10, by=0.01)
TmaxPET = -0.006*(LAIc^2) + 0.134*LAIc + 0.036
plot(LAIc, TmaxPET, type="l", ylab="Tr_max/PET", xlab="LAIstand", ylim=c(0,1))
```

Since medfate's **ver. 2.1**, empirical coefficients can be species-specific and @Granier1999 empirical equation has been generalized to:
\begin{equation}
\frac{Tr_{\max}}{PET}=  T_{max,LAI} \cdot LAI^{\phi}_{stand} + T_{max,sqLAI} \cdot (LAI^{\phi}_{stand})^2 
\end{equation}
where $T_{max,LAI}$ and $T_{max,sqLAI}$ are species-specific parameters (if missing, they are given default values 0.134 and -0.006, respectively). 

The maximum transpiration for a given plant cohort $i$ is calculated using the portion of $Tr_{\max}$ defined by $f_i$ the fraction of total absorbed SWR that is due
to cohort $i$ (see section \@ref(basiclightextinction)):
\begin{equation}
Tr_{\max, i} = Tr_{\max} \cdot \frac{f_i^{0.75}}{\sum_{j}{f_j^{0.75}}}
\end{equation} 
Before **ver 2.5.0** $Tr_{\max, i}$ was linearly related to $f_i$, but an exponent 0.75 is now used to decrease *ad hoc* the proportion of transpiration corresponding to cohorts absorbing high SWR fractions with respect to those absorbing low amounts of SWR, which has been found to better match the transpiration predicted using the advanced transpiration model. Note that the actual amount of radiation energy absorbed by plants is much more difficult to determine, involving diffuse and direct radiation, as well as net long-wave radiation (see chapter \@ref(radiationbalance)). 



### Actual plant transpiration and plant water potential {#actualtranspiration}

Actual plant transpiration depends on soil moisture and is calculated for each plant cohort and each soil layer separately. $Tr_{i,s}$ (in mm) represents the transpiration made by cohort $i$ from layer $s$. Actual plant transpiration from a given layer is regulated by soil moisture and the resistance to water flow through the plant. For each plant cohort $i$ and soil layer $s$, the model first estimates the a whole-plant relative water transpiration, $K_{i,s}$, which varies between 0 and 1 depending on $\Psi_{extract,i}$, the potential at which transpiration is 50% of maximum, and $\Psi_s$, the water potential in layer $s$. This relationship is modelled using a Weibull function (see function `hydraulics_psi2K()`):
\begin{equation}
K_{i,s}=K_{i}(\Psi_s) = \exp \left \{\ln{(0.5)}\cdot \left[ \frac{\Psi_s}{\Psi_{extract,i}} \right] ^r \right \} 
(\#eq:relativewholeplantconductance)
\end{equation}
where $r$ is an exponent that modulates the steepness of the decrease in relative
conductance when soil potential becomes negative (by default, $r = 3$) and $\ln(0.5)$
is used to ensure that $K_{i}(\Psi_{extract,i}) = 0.5$ (Fig. \@ref(fig:wholeplantconductance)).

(ref:wholeplantconductance-cap) Whole-plant relative water conductance functions for different water potential values ($r = 3$ in all cases)

```{r wholeplantconductance, fig.width=4, fig.height=4, fig.align="center", echo=FALSE, fig.cap='(ref:wholeplantconductance-cap)'}
par(mar=c(4,4,1,1))
x = seq(-10, 0, by=0.01)
plot(-x ,unlist(lapply(x,hydraulics_psi2K,-2.0,3.0)), type="l", ylab="K (relative conductance)", xlim=c(0,10), ylim=c(0,1),xlab="Soil water potential (-MPa)", frame=FALSE)
lines(-x, unlist(lapply(x,hydraulics_psi2K,-3.0,3.0)), lty=2)
lines(-x, unlist(lapply(x,hydraulics_psi2K,-4.0,3.0)), lty=3)
lines(-x, unlist(lapply(x,hydraulics_psi2K,-5.0,3.0)), lty=4)
legend("topright", lty=1:4, col=c(rep("black",4)), 
       legend = paste("Psi_extract = ", c(-2.0,-3.0,-4.0, -5.0), "MPa"), bty="n", cex=0.8)
abline(h=50, col="gray", lwd=2)
```

Until **ver 2.5.0**, actual transpiration of plant cohort $i$ from a given soil layer $s$, $Tr_{i,s}$, was defined as the product of [@Mouillot2001]: the maximum transpiration of the plant cohort ($Tr_{\max,i}$), the relative whole-plant transpiration ($K_{i,s}$) corresponding to the species and water potential in layer $s$, and the proportion of plant fine roots in layer $s$, $FRP_{i,s}$:
\begin{equation}
Tr_{i,s} =  Tr_{\max,i} \cdot K_{i,s} \cdot FRP_{i,s}
\end{equation}
Since **ver 2.5.0**, this equation has been slightly modified and is now:
\begin{equation}
Tr_{i,s} =  Tr_{\max,i} \cdot K_{i,s} \cdot \frac{K_{unsat,s}^{0.5} \cdot FRP_{i,s}}{\sum_r{K_{unsat,r}^{0.5} \cdot FRP_{i,r}}}
\end{equation}
where $K_{unsat,s}$ is the unsaturated soil conductivity of layer $s$. This modification was introduced to allow the plant to increase the amount of water drawn from layers with higher levels of moisture in seasons where the usual water pools are depleted. This formulation decreases the differences in soil moisture between soil layers, which in the advanced model is achieved thanks to hydraulic redistribution process.  

The total amount of water transpired by plants, $Tr$ (in mm), is the sum of $Tr_{i,s}$ values over all plant cohorts and soil layers:
\begin{equation}
Tr =\sum_{s}\sum_{i}{Tr_{i,s}}
\end{equation}
Assuming no water limitations (i.e. $K_{i,s} = 1$), we have that $Tr = Tr_{\max}$. Total stand transpiration will be lower than $Tr_{\max}$ if soil water potential in any layer is negative enough to cause a significant reduction in whole-plant conductance. At the plant level, the transpiration of a given plant cohort will be lower than that of others if: 

  a. The cohort is under the shade (it reduces $f_i$ and hence $Tr_{\max,i}$)
  b. The cohort has a lower amount of leaf area (it reduces $f_i$ and hence $Tr_{\max,i}$)
  c. The soil layers exploited by the cohort have more negative water potentials (it reduces $K_{i,s}$). 


The basic water balance model does not allow estimating a water potential drop from soil to the leaf. Moreover, in a multilayered soil it is difficult to know what would be the water potential of the plant. Despite these limitations, a gross surrogate of  'plant' water potential ($\Psi_{plant, i}$; in MPa) may be obtained averaging whole-plant relative conductance values and inverting the relative transpiration function:
\begin{equation}
\Psi_{plant, i}= K_i^{-1}\left(\sum_{s}{K_{i,s}\cdot v_{i,s}}\right)
\end{equation}
where $K_i^{-1}$ is the inverse of the relative whole-plant transpiration eq. \@ref(eq:relativewholeplantconductance). The plant water potential is used to determine plant stress levels and cavitation, as explained in \@ref(dailystressbasicwater) and \@ref(irreversiblecavitation). 

Importantly, changes in $\Psi_{plant, i}$ induce changes in plant water content, which may induce a release of water in the transpiration stream or an absorption of water from it.

### Minimum (cuticular) transpiration


### Transpiration with plant water pools {#transpirationpools}
Considering plant water pools (i.e. setting `plantWaterPools = TRUE` in the control parameters) involves partitioning the stand area into fractions corresponding to the abundance of each plant cohort. More specifically, the model defines as many plant water pools as plant cohorts, with proportions defined by their LAI values:
\begin{equation}
f_{pool,i} = \frac{LAI^{live}_i}{LAI^{live}_{stand}}
\end{equation}
Overall soil moisture is then related to moisture of plant water pools by the following equation, that is fulfilled for each soil layer $s$:
\begin{equation}
W_{s} = \sum_{i}{f_{pool,i} \cdot W_{i,s}}
\end{equation}
where $W_{i,s}$ is the soil moisture (relative to field capacity) of layer $s$ in the plant water pool of cohort $i$, i.e. under the area of the stand attributed to cohort $i$.

When transpiration occurs and plant water pools are considered, the model assumes that the rhizosphere of each plant cohort occupies its own water pool but may enter into the water pools under other plant cohorts. In other words, the root systems of different cohorts may overlap horizontally. A given plant cohort $i$ will have its roots in layer $s$ partitioned among different water pools. Let us assume that we know $fr_{i,s,j}$, the (horizontal) proportion of fine roots of cohort $i$ in layer $s$ of the water pool $j$ (see section \@ref(plantwaterpools)). These proportions fulfill:
\begin{equation}
\sum_{j}{fr_{i,s,j}} = 1 \,\, \forall i,s
\end{equation}
The soil moisture *sensed* by plant cohort $i$ in layer $s$, $W_{rhizo,i,s}$ is a weighted sum of moisture in water pools, with weights being the proportion of fine roots in each pool:
\begin{equation}
W_{rhizo,i,s} = \sum_{j}{fr_{i,s,j} \cdot W_{i,s}}
\end{equation}
This moisture determines $\Psi_{s,i}$, the corresponding water potential, which replaces $\Psi_{s}$ in eq. \@ref(eq:relativewholeplantconductance), so that plant conductance depends on the soil moisture *sensed* by the rhizosphere of the plant cohort. If the (actual) transpiration of cohort $i$ from soil layer $s$ is $Tr_{i,s}$, the water extracted by transpiration from a water pool $j$ will be:
\begin{equation}
Tr_{i,s,j} = \frac{fr_{i,s,j} \cdot Tr_{i,s}}{f_{pool,j}}
\end{equation}
It is easy to verify that this definition ensures the fulfillment of an equation analogous to that between $W_{s}$ and $W_{s,i}$:
\begin{equation}
Tr_{i,s} = \sum_{j}{f_{pool,j} \cdot Tr_{i,s,j}}
\end{equation}


### Plant photosynthesis {#basicphotosynthesis}

Because it is useful for growth, and for compatibility with the 'Sperry' transpiration mode (chapter \@ref(advancedwaterbalance)), the water balance model using 'Granier' transpiration mode also calculates gross assimilated carbon. Assuming a constant maximum water use efficiency ($WUE_{\max}$), gross photosynthesis for a given plant cohort $i$ (in $g\,C \cdot m^{-2}$) is estimated as a function of transpiration:
\begin{equation}
A_{g,i} = Tr_i \cdot WUE_{\max,i} \cdot (L^{PAR}_i)^{WUE_{decay,i}}
\end{equation}
where $Tr_i$ is the transpiration of plant cohort $i$, $WUE_{\max,i}$ is the maximum water use efficiency of the cohort (in $g\,C \cdot mm^{-1}$) - a species-specific parameter where WUE assumed to be estimated under conditions of no water stress and maximum light availability -, $L^{PAR}_i$ is the proportion of photosynthetically-active radiation available at the mid-crown of cohort $i$, according to the Beer-Lambert extinction model, and $WUE_{decay,i}$ is a species-specific exponent indicating how relative WUE decreases with lower light levels. The dependency of photosynthesis on drought stress is represented in the $Tr_i$ term, whereas the reduction of photosynthesis due to low light availability (for cohorts in the understory) is represented by the reduction of relative WUE given by low values of $L^{PAR}_i$:

```{r WUErelationship, out.width='100%', fig.align="center", fig.cap="Relationship between the percentage of PAR available to a cohort and the water use efficiency (left) or the water use efficiency relative to the maximum value observed in the stand for the same species (right). WUE values were estimated using the advanced water balance model and a non-linear regression was fitted.", echo=FALSE}
knitr::include_graphics("WUE_relationship.png")
```

## Plant drought stress and cavitation

### Daily drought stress {#dailystressbasicwater}

Similarly to @Mouillot2002, daily drought stress of a given plant cohort $i$, $DDS_i$, is defined as the one-complement of relative whole-plant transpiration (see eq. \@ref(eq:relativewholeplantconductance)) estimated from its plant water potential ($\Psi_{plant,i}$):
\begin{equation}
DDS_i=\phi_i \cdot (1-K_{i}(\Psi_{plant,i}))
\end{equation}
Leaf-phenological status is included to prevent winter deciduous plants from suffering drought stress during winter. Daily drought stress values can be later used to define other drought stress indices for larger temporal scales.
 
### Cavitation and hydraulic recovery {#irreversiblecavitation}
The water balance model is normally run assuming that although soil drought may reduce transpiration, embolized xylem conduits are automatically refilled when soil moisture recovers (in other words, cavitation is reversible and `cavitationRefill = "total"`). It is possible to simulate irreversible cavitation by setting `cavitationRefill = "none"`, `cavitationRefill = "rate"` or `cavitation = "annual"` in the control parameters. Any of these options cause the model to keep track of the maximum value of cavitation so far experienced using the proportion of of lost conductance for the plant cohort $i$ ($PLC_i$), which is modelled also using a Weibull function:
\begin{equation}
PLC_{i} = \max \left \{PLC_{i}, 1 - \exp \left \{ \ln{(0.5)}\cdot \left[ \frac{\Psi_{plant,i}}{\Psi_{critic,i}} \right] ^r \right \} \right \} 
\end{equation}
and then $K_{i,s}$ from eq. \@ref(eq:relativewholeplantconductance) cannot be larger than the one-complement of $PLC_i$ :
\begin{equation}
K_{i,s} = \min \{K_{i}(\Psi_s), 1.0 - PLC_{i} \}
\end{equation}

For simulations of less than one year one can use `cavitationRefill = "none"` to keep track of the maximum cavitation. However, for simulations of several years, it is normally advisable to allow recovery. If `cavitation = "annual"`, $PLC_{i}$ values are set to zero at the beginning of each year, assuming that embolized plants overcome the conductance loss by creating new xylem tissue. Finally, if `cavitationRefill = "rate"` the model simulates stem refilling at daily steps as a function of symplasmic water potential. First, a daily recovery rate ($r_{refill}$; in $cm^2 \cdot m^{-2} \cdot day^{-1}$) is estimated as a function of $\Psi_{plant,i}$:
\begin{equation}
r_{refill}(\Psi_{plant,i}) = r_{\max,refill} \cdot \max \{0.0, (\Psi_{plant,i} + 1.5)/1.5\}
\end{equation}
Where $r_{\max,refill}$ is the control parameter `refillMaximumRate` indicating a maximum refill rate. The right part of the equation normalizes the water potential, so that $r_{refill} = r_{refill,\max}$ if $\Psi_{plant,i} = 0$ and $r_{refill} = 0$ if $\Psi_{plant,i} <= -1.5MPa$. The proportion of conductance lost is then updated using:
\begin{equation}
PLC_{i}= \max \{0.0, PLC_{i} - (r_{refill}/H_v) \}
\end{equation}
where $H_v$ is the Huber value in units of $cm^2 \cdot m^{-2}$.


## Water content of plant tissues {#plantwatercontent}

Following @Martin-StPaul2017, we consider two kind of tissues in (leaf and stem) plant segments [@Tyree1990]. The first are conduits (tracheids or vessels), which will release water due to cavitation and may be refilled with water from adjacent living tissue or upstream segments. The second source of water is formed by more elastic living cells (i.e. parenchyma) and can potentially be a large source of water. This source can be described using the relative water content of a symplasmic tissue.


### Relative water content of symplasmic tissues {#pressurevolumecurves}

A pressure-volume curve of a tissue relates its water potential against its *relative water content* ($RWC$; $kg\,H_2O \cdot kg^{-1}\,H_2O$ at saturation). Pressure-volume theory is usually applied to leaf tissues [@Bartlett2012], but it can also be applied to other tissues such as sapwood or cambium cells. 

For living cells, the relationship between $\Psi$ and $RWC$ of the symplasmic fraction ($RWC_{sym}$) is achieved by separating $\Psi$ into osmotic (solute) potential ($\Psi_{S}$) and the turgor potential ($\Psi_{P}$):
\begin{equation}
\Psi = \Psi_{S} + \Psi_{P}
\end{equation}
The relationship for $\Psi_{P}$ is:
\begin{equation}
\Psi_{P} = -\pi_0 -\epsilon\cdot (1.0 - RWC_{sym})
\end{equation}
where $\pi_0$ (MPa) is the osmotic potential at full turgor (i.e. when $RWC_{sym} = 1$), and $\epsilon$ is the modulus of elasticity (i.e. the slope of the relationship). Assuming constant solute content, the relationship for $\Psi_{S}$ is:
\begin{equation}
\Psi_{S} = \frac{-\pi_0}{RWC_{sym}} 
\end{equation}
When $\Psi \leq \Psi_{tlp}$, the water potential at turgor loss point, then $\Psi_{P} = 0$ and $\Psi = \Psi_{S}$. If $\Psi > \Psi_{tlp}$ then the two components are needed. The water potential at turgor loss point ($\Psi_{tlp}$) can be found by [@Bartlett2012]:
\begin{equation}
\Psi_{tlp} = \frac{\pi_0 \cdot \epsilon}{\pi_0 + \epsilon}
(\#eq:turgorlosspoint)
\end{equation}
As an example, the following figure draws the pressure-volume curve for a tissue with $\epsilon = 12$ and $\pi_0 = -3.0$MPa:
```{r, fig.width=4, fig.height=4, echo=FALSE, fig.align="center"}
psi = seq(-10,0, by=0.1)
rwc_s = rep(NA, length(psi))
for(i in 1:length(psi)) rwc_s[i] =moisture_symplasticRWC(psi[i],-3,12)
plot(psi, rwc_s, type="l", xlab="Water potential (MPa)", ylab = "Symplasmic RWC")
```

To calculate $RWC_{sym}$ from the water potential of a tissue, the previous equations need to be combined and, after isolating $RWC_{sym}$, a quadratic relationship is obtained [@Martin-StPaul2017]. 
  

### Relative water content of apoplastic tissues 

In **medfate** it is assumed that apoplastic water fraction of an organ corresponds to the water in its xylem conduits. Xylem conduits consist of inelastic cells that have very small changes of water volume in relation to changes in water potential. However, xylem conduits release their water to the transpiration stream following the formation of emboli. As in @Holtta2009, we equate the relative water content of the apoplastic reservoir of a segment (leaves or stem) to the proportion of conductance lost (relative to the maximum conductance) for a given water potential (see \@ref(eq:xylemvulnerability)):
\begin{equation}
RWC_{apo}(\Psi_{apo}) = \frac{k(\Psi_{apo})}{k_{max}} = e^{-((\Psi_{apo}/d)^c)}
\end{equation}
Hence we assume that the relationship between $\Psi_{apo}$ and the relative water content follows the same function as the relationship between $\Psi_{apo}$ and the proportion of conductance loss (i.e. the hydraulic vulnerability curve).
```{r, fig.width=4, fig.height=4, echo=FALSE, fig.align="center"}
psi = seq(-7,0, by=0.1)
rwc_a = rep(NA, length(psi))
for(i in 1:length(psi)) rwc_a[i] =moisture_apoplasticRWC(psi[i],stemc,stemd)
plot(psi, rwc_a, type="l", xlab="Water potential (MPa)", ylab = "Apoplastic RWC")
```

Since cavitation in leaves is assumed reversible we have that the relative water content of the apoplastic fraction in leaves ($RWC_{leaf,apo}$) will follow the leaf xylem water potential as indicated above. In stems, however, cavitation may be non-reversible, so $RWC_{stem,apo}$ will be dictated by the current level of embolisation, which is represented by $PLC_{stem}$ and not by the current xylem water potential: 
\begin{equation}
RWC_{stem,apo} = 1 - PLC_{stem}
\end{equation}
If water compartments are not considered, $PLC_{stem}$ is determined by $\Psi_{stem, cav}$, the minimum stem water potential experienced so far. When water comparments are considered, increases in  $PLC_{stem}$ follow decreases in stem water content and the water released can contribute to the transpirational stream [@Martin-StPaul2017]. This will be treated in the next section. 


### Average relative water content of a segment {#averagerelativewatercontent}

The average relative water content in a given segment or organ ($RWC$) can be obtained by calculating  $RWC_{apo}$ and $RWC_{sym}$ followed by assuming a constant apoplastic fraction $f_{apo}$:

\begin{equation}
RWC = RWC_{apo} \cdot f_{apo} + RWC_{sym} \cdot (1 - f_{apo})
\end{equation}

Normally the apoplastic fraction is large (~80%) in the stem and small (~15%) in leaves. Hence, the relative water content in stems will be mostly dictated by the level of cavitation, whereas that of leaves will mostly follow leaf symplastic water potential and the symplastic pressure-volume curve.



# Plant hydraulics {#planthydraulics}


```{r, echo=FALSE}
col1 = "black"
col2 = "red"
col3 = "blue"
col4 = "dark green"
col1pale = "gray"
col2pale = "orange"
col3pale = "light blue"
col4pale = "green"
```

The supply-loss theory of plant hydraulics, presented by @Sperry2016 and used in @Sperry2016, uses the physics of flow through soil and xylem to quantify how steady-state canopy water supply declines with drought and ceases by hydraulic failure. The theory builds on the  hydraulic model of @Sperry1998 and can be applied to different segmentations of the soil-plant continuum. In our case we considered a network of $(N \times 2 + S + 1)$ resistance elements, with soil being represented in $N$ different layers and $S$ different stem segments. For each soil layer there is a rhizosphere element in series with a root xylem element. The $N$ soil layers are in parallel up to the root crown. From there there are $S$ stem xylem segments and a final leaf segment, all in series. Althougth the model implements this network representation of the soil-plant continuum, simpler one-element, two-element and three-element representations will be used in this document to facilitate understanding.


## Vulnerability curves
Each continuum element has a vulnerability curve that starts at maximum hydraulic conductance ($k_{max}$, flow rate per pressure drop) and monotonically declines as water pressure ($\Psi$) becomes more negative. Vulnerability curves form the basis of hydraulic calculations.

### Xylem vulnerability curves
Xylem tissues are assigned a two-parameter Weibull function as the vulnerability curve $k(\Psi)$:
\begin{equation}
k(\Psi) = k_{max}\cdot e^{-((\Psi/d)^c)}
(\#eq:xylemvulnerability)
\end{equation}
where $k_{max}$ is the maximum hydraulic conductance (defined as flow per leaf surface unit and per pressure drop), and $c$ and $d$ are species-specific and tissue-specific parameters. Note that parameter $d$ is the water potential (in MPa) at which $k(\Psi)/k_{max} = e^{-1} = 0.367$. Parameter $c$ controls the shape of the vulnerability curve (‘exponential’ shape with no threshold has $c \leq 1$, sigmoidal threshold has $c > 1$). 

For example, we define the following parameter values for a stem xylem ($k_{s,max}$ and parameters $c_s$ and $d_s$ of the vulnerability curve):
```{r}
kstemmax = 5.0 # mmol·m-2·s-1·MPa-1
stemc = 3 
stemd = -3.0 # MPa
```

For root xylem ($k_{r,max}$), we may assume a higher conductance (i.e. higher efficiency) but also higher vulnerability to cavitation (defined by parameters $c_r$ and $d_r$):

```{r}
krootmax = 6.6 # mmol·m-2·s-1·MPa-1
rootc = 2
rootd = -2.5 #MPa
```

```{r, echo=FALSE}
dE =0.01
Emax = 20
psiVec = seq(-0.1, -7.0, by =-0.01)
```

The concept of vulnerability curve can be used to specify the relationship between pressure and conductance in any portion of the flow path. Leaf vulnerability curve $k_l(\Psi)$ can be modelled using the same equation as for xylem:
\begin{equation}
k_l(\Psi) = k_{l,max}\cdot e^{-((\Psi/d_l)^{c_l})}
(\#eq:leafvulnerability)
\end{equation}
where $k_{l,max}$ is the leaf maximum hydraulic conductance. Values defined below specify higher conductance for leaves but also slightly higher vulnerability:
```{r}
kleafmax = 10
leafc = 2
leafd = -2
```


With these parameter values, the vulnerability curves for root, stem and leaf are (see `hydraulics_xylemConductance()`):
```{r, fig.width=5, fig.height=5, fig.align = "center", echo=FALSE}
psiCav = -2.5
plcCav = 1 -moisture_apoplasticRWC(psiCav, stemc, stemd)
par(mar=c(4,4,1,1), mfrow=c(1,1))
kleaf = unlist(lapply(psiVec,hydraulics_xylemConductance, kleafmax, leafc, leafd))
kstem = unlist(lapply(psiVec,hydraulics_xylemConductance, kstemmax, stemc, stemd))
kroot = unlist(lapply(psiVec,hydraulics_xylemConductance, krootmax, rootc, rootd))
plot(-psiVec, kstem, type="l",ylab="Xylem K (mmol·m-2·s-1·MPa-1)", xlab="Canopy pressure (-MPa)", 
     lwd=2,ylim=c(0,max(kstemmax, krootmax, kleafmax)))
lines(-psiVec, kroot, lty=2, lwd=2)
lines(-psiVec, kleaf, lty=3, lwd=2)
# abline(v=-psiCav, col="gray", lwd=1.5)
lines(x=c(0,-psiCav), y=rep(hydraulics_xylemConductance(psiCav, kstemmax, stemc, stemd),2), lty=4, lwd=2)
legend("topright", legend =c("leaf", "stem xylem (original)","stem xylem (cavitation)", "root xylem"), 
       lty=c(3,1,4,2), bty="n", cex=0.8, lwd=2)
```


The dotted line between 0 and $\Psi_{cav} = -2.5$ MPa indicates the modification of the stem xylem vulnerability curve when cavitation has occurred (i.e., previous embolism limits a the maximum conductance value), as indicated in @Sperry2016. The corresponding proportion of conductance loss can be found using the stem vulnerability curve:
\begin{equation}
PLC(\Psi_{cav}) = 1.0 - \frac{k_s(\Psi_{cav})}{k_{s,max}} = 1.0 - e^{-((\Psi/{d_s})^{c_s})}
\end{equation}

```{r}
1.0 - exp(-(-2.5/stemd)^stemc)
```


Although root xylem are  more vulnerable to the formation of emboli for a given potential, it is generally accepted that the less negative potentials of root xylem compared to the stem lead to cavitation occurring more often in the stem. The constrain created by cavitation has an effect on the calculation of the flow rates and derived quantities (see below).


### Rhizosphere vulnerability curve
The rhizosphere conductance function $k_{rh}(\Psi)$ is modeled as a van Genuchten function [@Genuchten1980]:
\begin{eqnarray}
k_{rh}(\Psi) &=& k_{rh,max} \cdot v^{(n-1)/(2\cdot n)} \cdot ((1-v)^{(n-1)/n}-1)^2 \\
v &=& [(\alpha \Psi)^{n}+1]^{-1}
(\#eq:rhizovulnerability)
\end{eqnarray}
where $k_{rh,max}$ is the maximum rhizosphere conductance, and $n$ and $\alpha$ are texture-specific parameters [@Leij1996; @Carsel1988]. These are automatically set by function `soil()` when initializing soil objects (see parameters `VG_alpha` and `VG_n` in the output of `soil()`), but we can use function `soil_vanGenuchtenParamsCarsel()` to derive them from texture types:

```{r}
textures = c("Sandy loam","Silt loam", "Clay")
#Textural parameters
#Sandy clay loam 
p1 = soil_vanGenuchtenParamsCarsel(textures[1])
p1
alpha1 = p1[1]  
n1 = p1[2]
#Silt loam
p2 = soil_vanGenuchtenParamsCarsel(textures[2])
p2
alpha2 =  p2[1]
n2 = p2[2]
#Silty clay
p3 = soil_vanGenuchtenParamsCarsel(textures[3])
p3
alpha3 =  p3[1]
n3 = p3[2]
```


We can estimate maximum rhizosphere conductance values assuming that they account for an average percentage of the resistance (e.g. 15%) across the continuum (see functions `hydraulics_averageRhizosphereResistancePercent()` and `hydraulics_findRhizosphereMaximumConductance()`):

```{r}
percentResistance = 15
#Sandy clay loam 
krmax1 =hydraulics_findRhizosphereMaximumConductance(percentResistance, 
                      n1,alpha1, krootmax, rootc,rootd, kstemmax, stemc, stemd,
                      kleafmax, leafc, leafd)
krmax1
#Silt loam
krmax2 =hydraulics_findRhizosphereMaximumConductance(percentResistance, 
                      n2,alpha2, krootmax, rootc,rootd, kstemmax, stemc, stemd,
                      kleafmax, leafc, leafd)
krmax2
#Silty clay
krmax3 =hydraulics_findRhizosphereMaximumConductance(percentResistance, 
                      n3,alpha3, krootmax, rootc,rootd, kstemmax, stemc, stemd,
                      kleafmax, leafc, leafd)
krmax3
```
With these parameters, the resulting $k_{rh}(\Psi)$ functions can be displayed using the function `hydraulics_vanGenuchtenConductance()`:
```{r,  fig.width=4, fig.height=3.5, echo=FALSE, fig.align = "center"}
par(mar=c(4,4,1,1), mfrow=c(1,1))
k1 = unlist(lapply(psiVec,hydraulics_vanGenuchtenConductance, krmax1, n1, alpha1))
k2 = unlist(lapply(psiVec,hydraulics_vanGenuchtenConductance, krmax2, n2, alpha2))
k3 = unlist(lapply(psiVec,hydraulics_vanGenuchtenConductance, krmax3, n3, alpha3))
plot(-psiVec, k1, type="l", col="black", ylab="Rhizosphere K (mmol·m-2·s-1·MPa-1)", xlab = "Soil hydraulic pressure (-MPa)",  xlim=c(0, max(-psiVec)), ylim=c(0, 100))
lines(-psiVec, k2, lty=2, lwd=1.5)
lines(-psiVec, k3, lty=3, lwd=1.5)
legend("topright", bty="n", legend=textures, lty=1:3, cex=0.8, lwd=1.5)
```


## Water content of plant tissues

In **medfate** the water content of leaves and stems is tracked explicitly. Following @Martin-StPaul2017, we consider two sources of water in plant segments [@Tyree1990]. The first comes from the conduits (tracheids or vessels), which will release water due to cavitation and may be refilled with water from adjacent living tissue. The second source of water is formed by more elastic living cells (i.e. parenchyma) and can potentially be a large source of water during relatively high water potentials. This source can be described using the relative water content of a symplasmic tissue. This storage compartment has its own water potential and exchanges water with the xylem conduits according to the difference in water potential.

### Pressure-volume curves
A pressure-volume curve of a tissue relates a water potential against relative water content ($RWC$; $kg H_2O \cdot kg^{-1}H_2O$ at saturation) in drying tissues. Pressure-volume theory is usually applied to leaves [@Bartlett2012], but it can also be applied to other tissues such as sapwood or cambium cells. 

For living cells, the relationship between $\Psi$ and $RWC$ of the symplasmic fraction ($RWC_{sym}$) is achieved by separating $\Psi$ into osmotic (solute) potential ($\Psi_{S}$) and the turgor potential ($\Psi_{P}$):
\begin{equation}
\Psi = \Psi_{S} + \Psi_{P}
\end{equation}
The relationship for $\Psi_{P}$ is:
\begin{equation}
\Psi_{P} = -\pi_0 -\epsilon\cdot (1.0 - RWC_{sym})
\end{equation}
where $\pi_0$ (MPa) is the osmotic potential at full turgor (i.e. when $RWC_{sym} = 1$), and $\epsilon$ is the modulus of elasticity (i.e. the slope of the relationship). Assuming constant solute content, the relationship for $\Psi_{S}$ is:
\begin{equation}
\Psi_{S} = \frac{-\pi_0}{RWC_{sym}} 
\end{equation}
When $\Psi \leq \Psi_{tlp}$, the water potential at turgor loss point, then $\Psi_{P} = 0$ and $\Psi = \Psi_{S}$. If $\Psi > \Psi_{tlp}$ then the two components are needed. The water potential at turgor loss point ($\Psi_{tlp}$) can be found by [@Bartlett2012]:
\begin{equation}
\Psi_{tlp} = \frac{\pi_0 \cdot \epsilon}{\pi_0 + \epsilon}
\end{equation}
As an example, the following figure draws the pressure-volume curve for a tissue with $\epsilon = 12$ and $\pi_0 = -3.0$MPa:
```{r, fig.width=4, fig.height=4, echo=FALSE, fig.align="center"}
psi = seq(-10,0, by=0.1)
rwc_s = rep(NA, length(psi))
for(i in 1:length(psi)) rwc_s[i] =moisture_symplasticRWC(psi[i],-3,12)
plot(psi, rwc_s, type="l", xlab="Water potential (MPa)", ylab = "Symplasmic RWC")
```

To calculate $RWC_{sym}$ from the water potential of a tissue, the previous equations need to be combined and, after isolating $RWC_{sym}$, a quadratic relationship is obtained. 
  
Apoplastic reservoirs (e.g. sapwood) consist of inelastic cells that release their water to the transpiration stream following embolism. As in @Holtta2009, we equate the relative water content of the apoplastic reservoir of a segment (leaves or stem) to the proportion of maximum conductance in the vulnerability curve:
\begin{equation}
RWC_{apo}(\Psi) = \frac{k(\Psi)}{k_{max}} = e^{-((\Psi/d)^{c})}
\end{equation}

```{r, fig.width=4, fig.height=4, echo=FALSE, fig.align="center"}
psi = seq(-7,0, by=0.1)
rwc_a = rep(NA, length(psi))
for(i in 1:length(psi)) rwc_a[i] =moisture_apoplasticRWC(psi[i],stemc,stemd)
plot(psi, rwc_a, type="l", xlab="Water potential (MPa)", ylab = "Apoplastic RWC")
```


The average relative water content in a given compartment ($RWC$) can be obtained from $\Psi_{sym}$ and $\Psi_{apo}$ by calculating  $RWC_{sym}(\Psi_{sym})$ and $RWC_{apo}(\Psi_{apo})$ followed by assuming a constant apoplastic fraction $f_{apo}$:
\begin{equation}
RWC = RWC_{apo}(\Psi_{apo}) \cdot f_{apo} + RWC_{sym}(\Psi_{sym}) \cdot (1 - f_{apo})
\end{equation}

### Water content and live fuel moisture content

Pressure-volume curves are useful to determine the moisture content of live fuel elements (leaves and twigs). Given an average relative water content of a water compartment, its live fuel moisture content ($LFMC$ in $g H_2O \cdot g^{-1}$ of dry tissue) can be calculated using:
\begin{equation}
LFMC = RWC \cdot \Theta \cdot \frac{\rho_{H_2O}}{\rho} = RWC \cdot LFMC_{max}
\end{equation}
where $\Theta$ is the tissue porosity ($cm^3$ of water per $cm^3$ of tissue), $\rho$ is the density of the tissue and $\rho_{H_2O}$ is the density of water.

If we know $RWC_{apo}(\Psi_{apo})$, the relative water content in conduits, and $V_{segment}$ (in $m^3$), the volume of conducting tissue (sapwood) in the segment, then the mass of water that is stored in conduits is: 
\begin{equation}
S_{apo}(\Psi_{apo}) = V_{segment} \cdot f_{apo} \cdot RWC_{apo}(\Psi_{apo}) \cdot \rho_{w}
\end{equation}
where $\rho_{w}$ is the density of water ($kgH_2O \cdot m^{-3}$) and $f_{apo,s}$ is the volume fraction of apoplastic tissue within sapwood. Similarly, the amount of water stored in the symplastic tissue of the segment at any time is:
\begin{equation}
S_{sym}(\Psi_{sym}) = V_{segment} \cdot (1 - f_{apo}) \cdot RWC_{sym}(\Psi_{sym}) \cdot \rho_{w}
\end{equation}

Finally, if we consider that both apoplastic and symplastic tissues are at the same water potential, the water content in the segment will be:
\begin{equation}
S(\Psi) = V_{segment} \cdot (f_{apo} \cdot RWC_{apo}(\Psi) + (1 - f_{apo}) \cdot RWC_{sym}(\Psi)) \cdot \rho_{w}
\end{equation}

### Relative water content and cavitation

In **medfate** we assume that cavitation in stems is non-reversible. Within a given sapwood segment, we further assume that the proportion of conductance loss ($PLC$) is related to the relative water content ($RWC$) in its conduit vessels (i.e. the water volume in conduit vessels with respect to the maximum water volume):
\begin{equation}
PLC(\Psi_{cav}) = 1 - RWC_{apo}(\Psi_{cav})
\end{equation}
where $RWC_{apo,s}$ is the function of relative water content for apoplastic stem tissue. With this assumption one can relate changes in PLC derived from cavitation with decreases in water content in xylem conduits. When $PLC$ increases the associated change in water content is a source of water can be added to the transpirational stream [@Martin-StPaul2017]. 



## Supply functions
The supply function describes the rate of water supply (i.e. flow) for transpiration ($E$) as a function of pressure. The steady-state flow rate $E_i$ through each $i$ element of the continuum is related to the flow-induced drop in pressure across that element ($\Delta \Psi_i$) by the integral transform of the element's vulnerability curve $k_i(\Psi)$ [@Sperry2015]:
\begin{equation}
E_i(\Delta \Psi_i) = \int_{\Psi_{up}}^{\Psi_{down}}{k_i(\Psi) d\Psi}
(\#eq:generalsupply)
\end{equation}
where $\Psi_{up}$ and $\Psi_{down}$ are the upstream and downstream water potential values, respectively. The integral transform assumes infinite discretization of the flow path. The supply function can be defined for individual elements of the continuum or for the whole soil-plant continuum using different topologies. In the following subsections we illustrate the supply function for different cases.


### Supply function for single elements

In the case of a single stem xylem element the supply function describes the flow rate as a function of canopy pressure ($\Psi_{canopy}$). It can be calculated by numerical integration or aproximated using an incomplete gamma function. The shape of the supply function starting at different root crown water potential values ($\Psi_{rootcrown}$) is (see function `hydraulics_EXylem()`):
```{r, fig.width=8, fig.height=3.5, fig.align = "center", echo=FALSE}
par(mar=c(4,4,2,1), mfrow=c(1,2))
psiSoil1 = -0.1
psiSoil2 = -1.0
psiSoil3 = -2.0
psiSoil4 = -3.0
E1 = unlist(lapply(psiVec,hydraulics_EXylem, psiSoil1, kstemmax, stemc, stemd))
E2 = unlist(lapply(psiVec,hydraulics_EXylem, psiSoil2, kstemmax, stemc, stemd))
E3 = unlist(lapply(psiVec,hydraulics_EXylem, psiSoil3, kstemmax, stemc, stemd))
E4 = unlist(lapply(psiVec,hydraulics_EXylem, psiSoil4, kstemmax, stemc, stemd))
E1emb = unlist(lapply(psiVec,hydraulics_EXylem, psiSoil1, kstemmax, stemc, stemd, psiCav = psiCav))
E2emb = unlist(lapply(psiVec,hydraulics_EXylem, psiSoil2, kstemmax, stemc, stemd, psiCav = psiCav))
E3emb = unlist(lapply(psiVec,hydraulics_EXylem, psiSoil3, kstemmax, stemc, stemd, psiCav = psiCav))
E4emb = unlist(lapply(psiVec,hydraulics_EXylem, psiSoil4, kstemmax, stemc, stemd, psiCav = psiCav))
E1[E1<0] = NA
E2[E2<0] = NA
E3[E3<0] = NA
E4[E4<0] = NA
E1emb[E1emb<0] = NA
E2emb[E2emb<0] = NA
E3emb[E3emb<0] = NA
E4emb[E4emb<0] = NA
Psic =hydraulics_psiCrit(stemc,stemd)
plot(-psiVec, E1, type="l", ylab="Xylem flow rate (mmol·m-2·s-1)", xlab="Canopy pressure (-MPa)", ylim=c(0,max(c(E1,E2,E3,E4), na.rm=TRUE)), lwd=1.5, col=col1, main="original")
lines(-psiVec, E2, lty=1, lwd=1.5, col=col2)
lines(-psiVec, E3, lty=1, lwd=1.5, col=col3)
lines(-psiVec, E4, lty=1, lwd=1.5, col=col4)

plot(-psiVec, E1emb, type="l", ylab="Xylem flow rate (mmol·m-2·s-1)", xlab="Canopy pressure (-MPa)", ylim=c(0,max(c(E1,E2,E3,E4), na.rm=TRUE)), lwd=1.5, col=col1, main="after cavitation")
lines(-psiVec, E2emb, lty=1, lwd=1.5, col=col2)
lines(-psiVec, E3emb, lty=1, lwd=1.5, col=col3)
lines(-psiVec, E4emb, lty=1, lwd=1.5, col=col4)
abline(v=-psiCav, col="gray", lwd=1.5)
```

Right pane shows the supply functions that are obtained in the case of a cavitated xylem (i.e. without refilling), assuming that the minimum water potential experienced so far was -2.5 MPa. Note the linear part of the flow rate between $\Psi_{soil}$ and this limit.

The supply function of the rhizosphere element relates the flow rate to the pressure inside the roots ($\Psi_{root}$). It is calculated by numerical integration of the van Genuchten function (see function `hydraulics_EVanGenuchten()`), for which we use the analytical approximation of @VanLier2009. Here we draw the supply function for the rhizosphere starting at the four different values of bulk soil pressure ($\Psi_{soil}$) and for the same three texture types:

```{r, fig.width=4, fig.height=4, fig.align = "center", echo=FALSE}
par(mar=c(4,4,1,1))
psiVec1 = psiSoil1+c(0,psiVec)
psiVec2 = psiSoil2+c(0,psiVec)
psiVec3 = psiSoil3+c(0,psiVec)
psiVec4 = psiSoil4+c(0,psiVec)
EVG11 = unlist(lapply(psiVec1,hydraulics_EVanGenuchten, psiSoil1, krmax1, n1, alpha1))
EVG12 = unlist(lapply(psiVec2,hydraulics_EVanGenuchten, psiSoil2, krmax1, n1, alpha1))
EVG13 = unlist(lapply(psiVec3,hydraulics_EVanGenuchten, psiSoil3, krmax1, n1, alpha1))
EVG14 = unlist(lapply(psiVec4,hydraulics_EVanGenuchten, psiSoil4, krmax1, n1, alpha1))
EVG21 = unlist(lapply(psiVec1,hydraulics_EVanGenuchten, psiSoil1, krmax2, n2, alpha2))
EVG22 = unlist(lapply(psiVec2,hydraulics_EVanGenuchten, psiSoil2, krmax2, n2, alpha2))
EVG23 = unlist(lapply(psiVec3,hydraulics_EVanGenuchten, psiSoil3, krmax2, n2, alpha2))
EVG24 = unlist(lapply(psiVec4, hydraulics_EVanGenuchten, psiSoil4, krmax2, n2, alpha2))
EVG31 = unlist(lapply(psiVec1, hydraulics_EVanGenuchten, psiSoil1, krmax3, n3, alpha3))
EVG32 = unlist(lapply(psiVec2, hydraulics_EVanGenuchten, psiSoil2, krmax3, n3, alpha3))
EVG33 = unlist(lapply(psiVec3, hydraulics_EVanGenuchten, psiSoil3, krmax3, n3, alpha3))
EVG34 = unlist(lapply(psiVec4, hydraulics_EVanGenuchten, psiSoil4, krmax3, n3, alpha3))
plot(-psiVec1, EVG11, type="l", ylab="Rhizosphere flow rate (mmol·m-2·s-1)", xlab = "Root pressure (-MPa)",  xlim=c(0, 7), ylim=c(0,2), col=col1)
lines(-psiVec1, EVG21, lty=2, lwd=1.5, col=col1)
lines(-psiVec1, EVG31, lty=3, lwd=1.5, col=col1)
lines(-psiVec2, EVG12, lty=1, lwd=1.5, col=col2)
lines(-psiVec2, EVG22, lty=2, lwd=1.5, col=col2)
lines(-psiVec2, EVG32, lty=3, lwd=1.5, col=col2)
lines(-psiVec3, EVG13, lty=1, lwd=1.5, col=col3)
lines(-psiVec3, EVG23, lty=2, lwd=1.5, col=col3)
lines(-psiVec3, EVG33, lty=3, lwd=1.5, col=col3)
lines(-psiVec4, EVG14, lty=1, lwd=1.5, col=col4)
lines(-psiVec4, EVG24, lty=2, lwd=1.5, col=col4)
lines(-psiVec4, EVG34, lty=3, lwd=1.5, col=col4)
legend("topright", bty="n", legend=textures, lty=1:3, lwd=1.5, cex=0.8)
```

The nearly vertical lines indicate that for many values of $E_i$ the corresponding drop in water potential through the rhizosphere will be negligible. Only for increasingly negative soil water potential values the decrease in water potential through the rhizosphere becomes relevant. Both in the case of a xylem element or a rhyzosphere element the derivative $dE_i/d\Psi$ of the supply function is equal to the corresponding vulnerability curve.


### Supply function of two elements in series

Let us describe the soil-plant continuum is represented using \emph{two} elements in series (rhizosphere + stem xylem). In this case, the supply function has to be calculated by sequentially using the previous supply functions. The $E_i$ is identical for each element and equal to the canopy $E$. Since $\Psi_{soil}$ is known, one first inverts the supply function of the rhizosphere to find $\Psi_{root}$ (see function `hydraulics_E2psiVanGenuchten()`) and then inverts the supply function of the xylem to find $\Psi_{canopy}$ (see function `hydraulics_E2psiXylem()`). The two operations can be summarized in a single supply function describing the potential rate of water supply for transpiration ($E$) as function of the canopy xylem pressure ($\Psi_{canopy}$), starting from different bulk soil ($\Psi_{soil}$) values (see function `hydraulics\_supplyFunctionTwoElements()`): 

```{r, fig.width=8, fig.height=4.5, fig.align = "center", echo=FALSE}
par(mar=c(4,4,2,1), mfrow=c(1,2))
psi2E11 = hydraulics_supplyFunctionTwoElements(Emax, psiSoil1, krmax1, kstemmax, n1, alpha1, stemc,stemd, 0.0, dE)
psi2E12 = hydraulics_supplyFunctionTwoElements(Emax, psiSoil2, krmax1, kstemmax, n1, alpha1, stemc,stemd, 0.0, dE)
psi2E13 = hydraulics_supplyFunctionTwoElements(Emax, psiSoil3, krmax1, kstemmax, n1, alpha1, stemc,stemd, 0.0, dE)
psi2E14 = hydraulics_supplyFunctionTwoElements(Emax, psiSoil4, krmax1, kstemmax, n1, alpha1, stemc,stemd, 0.0, dE)
psi2E21 = hydraulics_supplyFunctionTwoElements(Emax, psiSoil1, krmax2, kstemmax, n2, alpha2, stemc,stemd, 0.0, dE)
psi2E22 = hydraulics_supplyFunctionTwoElements(Emax, psiSoil2, krmax2, kstemmax, n2, alpha2, stemc,stemd, 0.0, dE)
psi2E23 = hydraulics_supplyFunctionTwoElements(Emax, psiSoil3, krmax2, kstemmax, n2, alpha2, stemc,stemd, 0.0, dE)
psi2E24 = hydraulics_supplyFunctionTwoElements(Emax, psiSoil4, krmax2, kstemmax, n2, alpha2, stemc,stemd, 0.0, dE)
psi2E31 = hydraulics_supplyFunctionTwoElements(Emax, psiSoil1, krmax3, kstemmax, n3, alpha3, stemc,stemd, 0.0, dE)
psi2E32 = hydraulics_supplyFunctionTwoElements(Emax, psiSoil2, krmax3, kstemmax, n3, alpha3, stemc,stemd, 0.0, dE)
psi2E33 = hydraulics_supplyFunctionTwoElements(Emax, psiSoil3, krmax3, kstemmax, n3, alpha3, stemc,stemd, 0.0, dE)
psi2E34 = hydraulics_supplyFunctionTwoElements(Emax, psiSoil4, krmax3, kstemmax, n3, alpha3, stemc,stemd, 0.0, dE)
mm = max(psi2E11$FittedE)
plot(-psi2E11$psiPlant, psi2E11$FittedE, type="l", col=col1, ylab="Flow rate (mmol·m-2·s-1)", xlab = "Canopy pressure (-MPa)",  xlim=c(0, 7), ylim=c(0,mm), lwd=1, main="original")
lines(-psi2E12$psiPlant, psi2E12$FittedE, lty=1, lwd=1, col=col2)
lines(-psi2E13$psiPlant, psi2E13$FittedE, lty=1, lwd=1, col=col3)
lines(-psi2E14$psiPlant, psi2E14$FittedE, lty=1, lwd=1, col=col4)
lines(-psi2E21$psiPlant, psi2E21$FittedE, lty=2, lwd=1, col=col1)
lines(-psi2E22$psiPlant, psi2E22$FittedE, lty=2, lwd=1, col=col2)
lines(-psi2E23$psiPlant, psi2E23$FittedE, lty=2, lwd=1, col=col3)
lines(-psi2E24$psiPlant, psi2E24$FittedE, lty=2, lwd=1, col=col4)
lines(-psi2E31$psiPlant, psi2E31$FittedE, lty=3, lwd=1, col=col1)
lines(-psi2E32$psiPlant, psi2E32$FittedE, lty=3, lwd=1, col=col2)
lines(-psi2E33$psiPlant, psi2E33$FittedE, lty=3, lwd=1, col=col3)
lines(-psi2E34$psiPlant, psi2E34$FittedE, lty=3, lwd=1, col=col4)
legend("topleft", bty="n", legend=textures, lwd=1, lty=1:3, cex=0.8)

psi2E11emb = hydraulics_supplyFunctionTwoElements(Emax, psiSoil1, krmax1, kstemmax, n1, alpha1, stemc,stemd,psiCav, dE)
psi2E12emb = hydraulics_supplyFunctionTwoElements(Emax, psiSoil2, krmax1, kstemmax, n1, alpha1, stemc,stemd, psiCav, dE)
psi2E13emb = hydraulics_supplyFunctionTwoElements(Emax, psiSoil3, krmax1, kstemmax, n1, alpha1, stemc,stemd, psiCav, dE)
psi2E14emb = hydraulics_supplyFunctionTwoElements(Emax, psiSoil4, krmax1, kstemmax, n1, alpha1, stemc,stemd, psiCav, dE)
psi2E21emb = hydraulics_supplyFunctionTwoElements(Emax, psiSoil1, krmax2, kstemmax, n2, alpha2, stemc,stemd, psiCav, dE)
psi2E22emb = hydraulics_supplyFunctionTwoElements(Emax, psiSoil2, krmax2, kstemmax, n2, alpha2, stemc,stemd, psiCav, dE)
psi2E23emb = hydraulics_supplyFunctionTwoElements(Emax, psiSoil3, krmax2, kstemmax, n2, alpha2, stemc,stemd, psiCav, dE)
psi2E24emb = hydraulics_supplyFunctionTwoElements(Emax, psiSoil4, krmax2, kstemmax, n2, alpha2, stemc,stemd, psiCav, dE)
psi2E31emb = hydraulics_supplyFunctionTwoElements(Emax, psiSoil1, krmax3, kstemmax, n3, alpha3, stemc,stemd, psiCav, dE)
psi2E32emb = hydraulics_supplyFunctionTwoElements(Emax, psiSoil2, krmax3, kstemmax, n3, alpha3, stemc,stemd, psiCav, dE)
psi2E33emb = hydraulics_supplyFunctionTwoElements(Emax, psiSoil3, krmax3, kstemmax, n3, alpha3, stemc,stemd, psiCav, dE)
psi2E34emb = hydraulics_supplyFunctionTwoElements(Emax, psiSoil4, krmax3, kstemmax, n3, alpha3, stemc,stemd, psiCav, dE)

plot(-psi2E11emb$psiPlant, psi2E11emb$FittedE, type="l", col=col1, ylab="Flow rate (mmol·m-2·s-1)", xlab = "Canopy pressure (-MPa)",  xlim=c(0, 7), ylim=c(0,mm), lwd=1, main="after cavitation")
lines(-psi2E12emb$psiPlant, psi2E12$FittedE, lty=1, lwd=1, col=col2)
lines(-psi2E13emb$psiPlant, psi2E13$FittedE, lty=1, lwd=1, col=col3)
lines(-psi2E14emb$psiPlant, psi2E14emb$FittedE, lty=1, lwd=1, col=col4)
lines(-psi2E21emb$psiPlant, psi2E21emb$FittedE, lty=2, lwd=1, col=col1)
lines(-psi2E22emb$psiPlant, psi2E22emb$FittedE, lty=2, lwd=1, col=col2)
lines(-psi2E23emb$psiPlant, psi2E23emb$FittedE, lty=2, lwd=1, col=col3)
lines(-psi2E24emb$psiPlant, psi2E24emb$FittedE, lty=2, lwd=1, col=col4)
lines(-psi2E31emb$psiPlant, psi2E31emb$FittedE, lty=3, lwd=1, col=col1)
lines(-psi2E32emb$psiPlant, psi2E32emb$FittedE, lty=3, lwd=1, col=col2)
lines(-psi2E33emb$psiPlant, psi2E33emb$FittedE, lty=3, lwd=1, col=col3)
lines(-psi2E34emb$psiPlant, psi2E34emb$FittedE, lty=3, lwd=1, col=col4)
abline(v=-psiCav, col="gray", lwd=1.5)
legend("topleft", bty="n", legend=textures, lwd=1, lty=1:3, cex=0.8)
```

The supply function for the whole continuum contains much information. The $\Psi$ intercept at $E=0$ represents the predawn canopy sap pressure which integrates the rooted soil moisture profile. As $E$ increments from zero, the disproportionately greater drop in $\Psi_{canopy}$ results from the loss of conductance. As the soil dries the differences in flow due to soil texture become more apparent. The derivative of the whole continuum supply function, $dE/d\Psi$, is not equal to either of the vulnerability curves and it has to be obtained numerically. The derivative functions corresponding to the supply functions shown in the previous figure are:

```{r, fig.width=8, fig.height=4.5, fig.align = "center", echo=FALSE}
par(mar=c(4,4,2,1), mfrow=c(1,2))
plot(-psi2E11$psiPlant, psi2E11$dEdP, type="l", col=col1, ylab="dE/dP (mmol·m-2·s-1·MPa-1)", xlab = "Canopy pressure (-MPa)",  xlim=c(0, 7), ylim=c(0,max(psi2E11$dEdP)), lwd=1 , main="original")
lines(-psi2E12$psiPlant, psi2E12$dEdP, lty=1, lwd=1, col=col2)
lines(-psi2E13$psiPlant, psi2E13$dEdP, lty=1, lwd=1, col=col3)
lines(-psi2E14$psiPlant, psi2E14$dEdP, lty=1, lwd=1, col=col4)
lines(-psi2E21$psiPlant, psi2E21$dEdP, lty=2, lwd=1, col=col1)
lines(-psi2E22$psiPlant, psi2E22$dEdP, lty=2, lwd=1, col=col2)
lines(-psi2E23$psiPlant, psi2E23$dEdP, lty=2, lwd=1, col=col3)
lines(-psi2E24$psiPlant, psi2E24$dEdP, lty=2, lwd=1, col=col4)
lines(-psi2E31$psiPlant, psi2E31$dEdP, lty=3, lwd=1, col=col1)
lines(-psi2E32$psiPlant, psi2E32$dEdP, lty=3, lwd=1, col=col2)
lines(-psi2E33$psiPlant, psi2E33$dEdP, lty=3, lwd=1, col=col3)
lines(-psi2E34$psiPlant, psi2E34$dEdP, lty=3, lwd=1, col=col4)
legend("topright", bty="n", legend=textures, lwd=1, lty=1:3, cex=0.8)

plot(-psi2E11emb$psiPlant, psi2E11emb$dEdP, type="l", col=col1, ylab="dE/dP (mmol·m-2·s-1·MPa-1)", xlab = "Canopy pressure (-MPa)",  xlim=c(0, 7), ylim=c(0,max(psi2E11$dEdP)), lwd=1, main="after cavitation")
lines(-psi2E12emb$psiPlant, psi2E12emb$dEdP, lty=1, lwd=1, col=col2)
lines(-psi2E13emb$psiPlant, psi2E13emb$dEdP, lty=1, lwd=1, col=col3)
lines(-psi2E14emb$psiPlant, psi2E14emb$dEdP, lty=1, lwd=1, col=col4)
lines(-psi2E21emb$psiPlant, psi2E21emb$dEdP, lty=2, lwd=1, col=col1)
lines(-psi2E22emb$psiPlant, psi2E22emb$dEdP, lty=2, lwd=1, col=col2)
lines(-psi2E23emb$psiPlant, psi2E23emb$dEdP, lty=2, lwd=1, col=col3)
lines(-psi2E24emb$psiPlant, psi2E24emb$dEdP, lty=2, lwd=1, col=col4)
lines(-psi2E31emb$psiPlant, psi2E31emb$dEdP, lty=3, lwd=1, col=col1)
lines(-psi2E32emb$psiPlant, psi2E32emb$dEdP, lty=3, lwd=1, col=col2)
lines(-psi2E33emb$psiPlant, psi2E33emb$dEdP, lty=3, lwd=1, col=col3)
lines(-psi2E34emb$psiPlant, psi2E34emb$dEdP, lty=3, lwd=1, col=col4)
abline(v=-psiCav, col="gray", lwd=1.5)
legend("topright", bty="n", legend=textures, lwd=1, lty=1:3, cex=0.8)
```

The derivative $dE/d\Psi_{canopy}$ is the conductance if the entire continuum was exposed to $\Psi_{canopy}$ [@Sperry2015]. It corresponds to the local loss of hydraulic conductance at the downstream end of the flow path. It falls towards zero for asymptotic critical values ($E_{crit}$). For a cavitated system $dE/d\Psi_{canopy}$ can be rather flat, in accordance with the close to linear part of the supply function.

### Supply function of three elements in series
If the soil-plant continuum is represented using \emph{three} elements in series (rhizosphere + stem xylem + leaf), the resulting overall conductance and resistance fractions (under wet conditions) are:

```{r}
rstemmin = 1/kstemmax
rleafmin = 1/kleafmax

#Percentages of minimum resistance
rvec = c(rstemmin,rleafmin)
100*rvec/sum(rvec)

#Maximum overall conductance
1/sum(rvec)

```

As before, the supply function has to be calculated by sequentially. The $E_i$ is identical for each element. Since $\Psi_{soil}$ is known, one first inverts the supply function of the rhizosphere to find $\Psi_{root}$ and then inverts the supply function of the xylem to find $\Psi_{stem}$. Finally, one inverts the supply function of the leaf element to find $\Psi_{leaf}$. As before, the three operations can be summarized in a single supply function describing the potential rate of water supply for transpiration ($E$) as function of the leaf pressure ($\Psi_{leaf}$), starting from different bulk soil ($\Psi_{soil}$) values (see function `hydraulics_supplyFunctionThreeElements()`):

```{r, fig.width=8, fig.height=4.5, fig.align = "center", echo=FALSE}
par(mar=c(4,4,2,1), mfrow=c(1,2))
psi2E11 = hydraulics_supplyFunctionThreeElements(Emax, psiSoil1, krmax1, kstemmax, kleafmax, n1, alpha1, stemc,stemd, leafc,leafd, 0.0, dE)
psi2E12 = hydraulics_supplyFunctionThreeElements(Emax, psiSoil2, krmax1, kstemmax, kleafmax, n1, alpha1, stemc,stemd, leafc,leafd, 0.0, dE)
psi2E13 = hydraulics_supplyFunctionThreeElements(Emax, psiSoil3, krmax1, kstemmax, kleafmax, n1, alpha1, stemc,stemd, leafc,leafd, 0.0, dE)
psi2E14 = hydraulics_supplyFunctionThreeElements(Emax, psiSoil4, krmax1, kstemmax, kleafmax, n1, alpha1, stemc,stemd, leafc,leafd, 0.0, dE)
psi2E21 = hydraulics_supplyFunctionThreeElements(Emax, psiSoil1, krmax2, kstemmax, kleafmax,n2, alpha2, stemc,stemd, leafc,leafd, 0.0, dE)
psi2E22 = hydraulics_supplyFunctionThreeElements(Emax, psiSoil2, krmax2, kstemmax, kleafmax,n2, alpha2, stemc,stemd, leafc,leafd, 0.0, dE)
psi2E23 = hydraulics_supplyFunctionThreeElements(Emax, psiSoil3, krmax2, kstemmax, kleafmax,n2, alpha2, stemc,stemd, leafc,leafd, 0.0, dE)
psi2E24 = hydraulics_supplyFunctionThreeElements(Emax, psiSoil4, krmax2, kstemmax, kleafmax,n2, alpha2, stemc,stemd, leafc,leafd, 0.0, dE)
psi2E31 = hydraulics_supplyFunctionThreeElements(Emax, psiSoil1, krmax3, kstemmax, kleafmax,n3, alpha3, stemc,stemd, leafc,leafd, 0.0, dE)
psi2E32 = hydraulics_supplyFunctionThreeElements(Emax, psiSoil2, krmax3, kstemmax, kleafmax,n3, alpha3, stemc,stemd, leafc,leafd, 0.0, dE)
psi2E33 = hydraulics_supplyFunctionThreeElements(Emax, psiSoil3, krmax3, kstemmax, kleafmax,n3, alpha3, stemc,stemd, leafc,leafd, 0.0, dE)
psi2E34 = hydraulics_supplyFunctionThreeElements(Emax, psiSoil4, krmax3, kstemmax, kleafmax,n3, alpha3, stemc,stemd, leafc,leafd, 0.0, dE)
mm = max(psi2E11$FittedE)
plot(-psi2E11$psiLeaf, psi2E11$FittedE, type="l", col=col1, ylab="Flow rate (mmol·m-2·s-1)", xlab = "Leaf pressure (-MPa)",  xlim=c(0, 7), ylim=c(0,mm), lwd=1, main="original")
lines(-psi2E12$psiLeaf, psi2E12$FittedE, lty=1, lwd=1, col=col2)
lines(-psi2E13$psiLeaf, psi2E13$FittedE, lty=1, lwd=1, col=col3)
lines(-psi2E14$psiLeaf, psi2E14$FittedE, lty=1, lwd=1, col=col4)
lines(-psi2E21$psiLeaf, psi2E21$FittedE, lty=2, lwd=1, col=col1)
lines(-psi2E22$psiLeaf, psi2E22$FittedE, lty=2, lwd=1, col=col2)
lines(-psi2E23$psiLeaf, psi2E23$FittedE, lty=2, lwd=1, col=col3)
lines(-psi2E24$psiLeaf, psi2E24$FittedE, lty=2, lwd=1, col=col4)
lines(-psi2E31$psiLeaf, psi2E31$FittedE, lty=3, lwd=1, col=col1)
lines(-psi2E32$psiLeaf, psi2E32$FittedE, lty=3, lwd=1, col=col2)
lines(-psi2E33$psiLeaf, psi2E33$FittedE, lty=3, lwd=1, col=col3)
lines(-psi2E34$psiLeaf, psi2E34$FittedE, lty=3, lwd=1, col=col4)
legend("topleft", bty="n", legend=textures, lwd=1, lty=1:3, cex=0.8)

psi2E11emb = hydraulics_supplyFunctionThreeElements(Emax, psiSoil1, krmax1, kstemmax, kleafmax,n1, alpha1, stemc,stemd, leafc,leafd,psiCav, dE)
psi2E12emb = hydraulics_supplyFunctionThreeElements(Emax, psiSoil2, krmax1, kstemmax, kleafmax,n1, alpha1, stemc,stemd, leafc,leafd, psiCav, dE)
psi2E13emb = hydraulics_supplyFunctionThreeElements(Emax, psiSoil3, krmax1, kstemmax, kleafmax,n1, alpha1, stemc,stemd, leafc,leafd, psiCav, dE)
psi2E14emb = hydraulics_supplyFunctionThreeElements(Emax, psiSoil4, krmax1, kstemmax, kleafmax,n1, alpha1, stemc,stemd, leafc,leafd, psiCav, dE)
psi2E21emb = hydraulics_supplyFunctionThreeElements(Emax, psiSoil1, krmax2, kstemmax, kleafmax,n2, alpha2, stemc,stemd, leafc,leafd, psiCav, dE)
psi2E22emb = hydraulics_supplyFunctionThreeElements(Emax, psiSoil2, krmax2, kstemmax, kleafmax,n2, alpha2, stemc,stemd, leafc,leafd, psiCav, dE)
psi2E23emb = hydraulics_supplyFunctionThreeElements(Emax, psiSoil3, krmax2, kstemmax, kleafmax,n2, alpha2, stemc,stemd, leafc,leafd, psiCav, dE)
psi2E24emb = hydraulics_supplyFunctionThreeElements(Emax, psiSoil4, krmax2, kstemmax, kleafmax,n2, alpha2, stemc,stemd, leafc,leafd, psiCav, dE)
psi2E31emb = hydraulics_supplyFunctionThreeElements(Emax, psiSoil1, krmax3, kstemmax, kleafmax,n3, alpha3, stemc,stemd, leafc,leafd, psiCav, dE)
psi2E32emb = hydraulics_supplyFunctionThreeElements(Emax, psiSoil2, krmax3, kstemmax, kleafmax,n3, alpha3, stemc,stemd, leafc,leafd, psiCav, dE)
psi2E33emb = hydraulics_supplyFunctionThreeElements(Emax, psiSoil3, krmax3, kstemmax, kleafmax,n3, alpha3, stemc,stemd, leafc,leafd, psiCav, dE)
psi2E34emb = hydraulics_supplyFunctionThreeElements(Emax, psiSoil4, krmax3, kstemmax, kleafmax,n3, alpha3, stemc,stemd, leafc,leafd, psiCav, dE)

plot(-psi2E11emb$psiLeaf, psi2E11emb$FittedE, type="l", col=col1, ylab="Flow rate (mmol·m-2·s-1)", xlab = "Leaf pressure (-MPa)",  xlim=c(0, 7), ylim=c(0,mm), lwd=1, main="after cavitation")
lines(-psi2E12emb$psiLeaf, psi2E12$FittedE, lty=1, lwd=1, col=col2)
lines(-psi2E13emb$psiLeaf, psi2E13$FittedE, lty=1, lwd=1, col=col3)
lines(-psi2E14emb$psiLeaf, psi2E14emb$FittedE, lty=1, lwd=1, col=col4)
lines(-psi2E21emb$psiLeaf, psi2E21emb$FittedE, lty=2, lwd=1, col=col1)
lines(-psi2E22emb$psiLeaf, psi2E22emb$FittedE, lty=2, lwd=1, col=col2)
lines(-psi2E23emb$psiLeaf, psi2E23emb$FittedE, lty=2, lwd=1, col=col3)
lines(-psi2E24emb$psiLeaf, psi2E24emb$FittedE, lty=2, lwd=1, col=col4)
lines(-psi2E31emb$psiLeaf, psi2E31emb$FittedE, lty=3, lwd=1, col=col1)
lines(-psi2E32emb$psiLeaf, psi2E32emb$FittedE, lty=3, lwd=1, col=col2)
lines(-psi2E33emb$psiLeaf, psi2E33emb$FittedE, lty=3, lwd=1, col=col3)
lines(-psi2E34emb$psiLeaf, psi2E34emb$FittedE, lty=3, lwd=1, col=col4)
abline(v=-psiCav, col="gray", lwd=1.5)
legend("topleft", bty="n", legend=textures, lwd=1, lty=1:3, cex=0.8)
```

Note that overall conductance and the maximum flow of the supply function are smaller in this case than in the representation using two elements in series. While the rhizosphere component only adds a significant resistance when the soil dries, considering the leaf segment (or a root xylem segment) increases the overall resistance of the continuum. Higher vulnerability of leaves also makes the curve to saturate for less negative soil water potentials. The derivative functions corresponding to the supply functions shown in the previous figure are (note the highest value being equal to the overall maximum conductance):

```{r, fig.width=8, fig.height=4.5, fig.align = "center", echo=FALSE}
par(mar=c(4,4,2,1), mfrow=c(1,2))
plot(-psi2E11$psiLeaf, psi2E11$dEdP, type="l", col=col1, ylab="dE/dP (mmol·m-2·s-1·MPa-1)", xlab = "Leaf pressure (-MPa)",  xlim=c(0, 7), ylim=c(0,max(psi2E11$dEdP)), lwd=1 , main="original")
lines(-psi2E12$psiLeaf, psi2E12$dEdP, lty=1, lwd=1, col=col2)
lines(-psi2E13$psiLeaf, psi2E13$dEdP, lty=1, lwd=1, col=col3)
lines(-psi2E14$psiLeaf, psi2E14$dEdP, lty=1, lwd=1, col=col4)
lines(-psi2E21$psiLeaf, psi2E21$dEdP, lty=2, lwd=1, col=col1)
lines(-psi2E22$psiLeaf, psi2E22$dEdP, lty=2, lwd=1, col=col2)
lines(-psi2E23$psiLeaf, psi2E23$dEdP, lty=2, lwd=1, col=col3)
lines(-psi2E24$psiLeaf, psi2E24$dEdP, lty=2, lwd=1, col=col4)
lines(-psi2E31$psiLeaf, psi2E31$dEdP, lty=3, lwd=1, col=col1)
lines(-psi2E32$psiLeaf, psi2E32$dEdP, lty=3, lwd=1, col=col2)
lines(-psi2E33$psiLeaf, psi2E33$dEdP, lty=3, lwd=1, col=col3)
lines(-psi2E34$psiLeaf, psi2E34$dEdP, lty=3, lwd=1, col=col4)
legend("topright", bty="n", legend=textures, lwd=1, lty=1:3, cex=0.8)

plot(-psi2E11emb$psiLeaf, psi2E11emb$dEdP, type="l", col=col1, ylab="dE/dP (mmol·m-2·s-1·MPa-1)", xlab = "Leaf pressure (-MPa)",  xlim=c(0, 7), ylim=c(0,max(psi2E11$dEdP)), lwd=1, main="after cavitation")
lines(-psi2E12emb$psiLeaf, psi2E12emb$dEdP, lty=1, lwd=1, col=col2)
lines(-psi2E13emb$psiLeaf, psi2E13emb$dEdP, lty=1, lwd=1, col=col3)
lines(-psi2E14emb$psiLeaf, psi2E14emb$dEdP, lty=1, lwd=1, col=col4)
lines(-psi2E21emb$psiLeaf, psi2E21emb$dEdP, lty=2, lwd=1, col=col1)
lines(-psi2E22emb$psiLeaf, psi2E22emb$dEdP, lty=2, lwd=1, col=col2)
lines(-psi2E23emb$psiLeaf, psi2E23emb$dEdP, lty=2, lwd=1, col=col3)
lines(-psi2E24emb$psiLeaf, psi2E24emb$dEdP, lty=2, lwd=1, col=col4)
lines(-psi2E31emb$psiLeaf, psi2E31emb$dEdP, lty=3, lwd=1, col=col1)
lines(-psi2E32emb$psiLeaf, psi2E32emb$dEdP, lty=3, lwd=1, col=col2)
lines(-psi2E33emb$psiLeaf, psi2E33emb$dEdP, lty=3, lwd=1, col=col3)
lines(-psi2E34emb$psiLeaf, psi2E34emb$dEdP, lty=3, lwd=1, col=col4)
abline(v=-psiCav, col="gray", lwd=1.5)
legend("topright", bty="n", legend=textures, lwd=1, lty=1:3, cex=0.8)
```



### Supply function of a root system
So far we considered supply functions of elements in series, but resistance elements will be in parallel if soil is represented using $N>1$ different layers. For each soil layer there is a rhizosphere element in series with a root xylem element. The $N$ soil layers are in parallel up to the root crown. 

Network of $N$ rhizosphere components and root layers in parallel there are $N+1$ unknown pressures: the $N$ root surface pressures ($\Psi_{rootsurf,1},\dots,\Psi_{rootsurf,N}$) and the root crown pressure at the downstream junction for all root components ($\Psi_{rootcrown}$). The $N+1$ unknown pressures are solved, for each specified total flow value $E$, using multidimensional Newton-Raphson on a set of equations for steady-state flow [@Sperry2016a]:
\begin{eqnarray}
   E_{k, rhizosphere}-E_{k,root} &=& 0 \\
   \sum_{k}^{n}{E_{k,root}}-E &=& 0
\end{eqnarray}
where $E_{k, rhizosphere}$ and $E_{k, root}$ are supply flows calculated using the integrals of either van Genuchten or Weibull function as vulnerability curves, respectively. In the case of rhizosphere elements, $\Psi_{up,k}=\Psi_{soil,k}$ and in the case of root elements $\Psi_{up,k}=\Psi_{rootsurf,k}$. Solving the steady-state equations also provides values for flow across each of the parallel paths $E_{k, rhizosphere} = E_{k, root}$, which are useful to conduct water balance operations on each layer. 

```{r, out.width='80%', fig.align="center", fig.cap="Schematic representation of hydraulics in a root network", echo=FALSE}
knitr::include_graphics("hydraulics_rs.jpg")
```

As an example, we start by defining the water potential of three soil layers corresponding to four situations (analogously with the soil water potentials defined above): 
```{r}
 psiSoilLayers1 = c(-0.3,-0.2,-0.1)
 psiSoilLayers2 = c(-1.3,-1.2,-1.1)
 psiSoilLayers3 = c(-2.3,-2.2,-2.1)
 psiSoilLayers4 = c(-3.3,-3.2,-3.1)
```

In a network of several soil layers, one has to divide the total rhizosphere and root xylem conductances among layers. Let layer depths be:
```{r}
d = c(300,700,3000) #Soil layer widths in mm
```

Now let $v_1$, $v_2$ and $v_3$ be the proportion of fine root biomass in each soil layer.
```{r}
Z50 = 200 #Parameter of LDR root distribution
Z95 = 1200 #Parameter of LDR root distribution
v = root_ldrDistribution(Z50, Z95, d)
v
```

In the case of the rhizosphere conductances, we can simply define them (for each soil texture type) as:
```{r}
krhizomaxvec1 = krmax1*v
krhizomaxvec2 = krmax2*v
krhizomaxvec3 = krmax3*v
```

To divide maximum root xylem conductance among soil layers we need weights inversely proportional to the length of transport distances [@Sperry2016a]. Vertical transport lengths can be calculated from soil depths and radial spread can be calculated assuming cylinders with volume proportional to the proportions of fine root biomass. The whole process can be done using function `root_rootXylemConductanceProportions()`:
```{r}
weights = root_xylemConductanceProportions(v, d)
weights
```

Transport weights are quite different than the fine root biomass proportions. This is because radial lengths are largest for the first (top) layer and vertical lengths are largest for the third (bottom) layer. The root xylem conductances are (in this case they do not depend on soil texture):
```{r}
krootmaxvec = krootmax*weights
krootmaxvec
```

Having all these maximum conductances, we can now build the supply functions for each soil texture and starting from the different soil water potential configurations (see function `hydraulics_supplyFunctionBelowground()`): 
```{r, fig.width=8, fig.height=4.5, fig.align = "center", echo=FALSE}
par(mar=c(4,4,2,1), mfrow=c(1,2))
psiMax = -7.0
supplyRS11 = hydraulics_supplyFunctionBelowground(psiSoilLayers1,
                                  krhizomaxvec1,rep(n1,3),rep(alpha1,3),
                                  krootmaxvec, rootc,rootd,
                                  maxNsteps = 400)
supplyRS12 = hydraulics_supplyFunctionBelowground(psiSoilLayers2,
                                  krhizomaxvec1,rep(n1,3),rep(alpha1,3),
                                  krootmaxvec, rootc,rootd,
                                  maxNsteps = 400)
supplyRS13 = hydraulics_supplyFunctionBelowground(psiSoilLayers3,
                                  krhizomaxvec1,rep(n1,3),rep(alpha1,3),
                                  krootmaxvec, rootc,rootd,
                                  maxNsteps = 400)
supplyRS14 = hydraulics_supplyFunctionBelowground(psiSoilLayers4,
                                  krhizomaxvec1,rep(n1,3),rep(alpha1,3),
                                  krootmaxvec, rootc,rootd,
                                  maxNsteps = 400)
supplyRS21 = hydraulics_supplyFunctionBelowground(psiSoilLayers1,
                                  krhizomaxvec2,rep(n2,3),rep(alpha2,3),
                                  krootmaxvec, rootc,rootd,
                                  maxNsteps = 400)
supplyRS22 = hydraulics_supplyFunctionBelowground(psiSoilLayers2,
                                  krhizomaxvec2,rep(n2,3),rep(alpha2,3),
                                  krootmaxvec, rootc,rootd,
                                  maxNsteps = 400)
supplyRS23 = hydraulics_supplyFunctionBelowground(psiSoilLayers3,
                                  krhizomaxvec2,rep(n2,3),rep(alpha2,3),
                                  krootmaxvec, rootc,rootd,
                                  maxNsteps = 400)
supplyRS24 = hydraulics_supplyFunctionBelowground(psiSoilLayers4,
                                  krhizomaxvec2,rep(n2,3),rep(alpha2,3),
                                  krootmaxvec, rootc,rootd,
                                  maxNsteps = 400)
supplyRS31 = hydraulics_supplyFunctionBelowground(psiSoilLayers1,
                                  krhizomaxvec3,rep(n3,3),rep(alpha3,3),
                                  krootmaxvec, rootc,rootd,
                                  maxNsteps = 400)
supplyRS32 = hydraulics_supplyFunctionBelowground(psiSoilLayers2,
                                  krhizomaxvec3,rep(n3,3),rep(alpha3,3),
                                  krootmaxvec, rootc,rootd,
                                  maxNsteps = 400)
supplyRS33 = hydraulics_supplyFunctionBelowground(psiSoilLayers3,
                                  krhizomaxvec3,rep(n3,3),rep(alpha3,3),
                                  krootmaxvec, rootc,rootd,
                                  maxNsteps = 400)
supplyRS34 = hydraulics_supplyFunctionBelowground(psiSoilLayers4,
                                  krhizomaxvec3,rep(n3,3),rep(alpha3,3),
                                  krootmaxvec, rootc,rootd,
                                  maxNsteps = 400)
plot(-supplyRS11$psiRoot, supplyRS11$E, type="l", col=col1, ylab="Flow rate  (mmol·m-2·s-1)", 
     xlab = "Root crown pressure (-MPa)",  xlim=c(0, 7), ylim=c(0,max(supplyRS11$E)), lwd=1, main  = "E")
lines(-supplyRS12$psiRoot, supplyRS12$E, lty=1, col=col2)
lines(-supplyRS13$psiRoot, supplyRS13$E, lty=1, col=col3)
lines(-supplyRS14$psiRoot, supplyRS14$E, lty=1, col=col4)
lines(-supplyRS21$psiRoot, supplyRS21$E, lty=2, col=col1)
lines(-supplyRS22$psiRoot, supplyRS22$E, lty=2, col=col2)
lines(-supplyRS23$psiRoot, supplyRS23$E, lty=2, col=col3)
lines(-supplyRS24$psiRoot, supplyRS24$E, lty=2, col=col4)
lines(-supplyRS32$psiRoot, supplyRS32$E, lty=3, col=col1)
lines(-supplyRS32$psiRoot, supplyRS32$E, lty=3, col=col2)
lines(-supplyRS33$psiRoot, supplyRS33$E, lty=3, col=col3)
lines(-supplyRS34$psiRoot, supplyRS34$E, lty=3, col=col4)
legend("topleft", bty="n", legend=textures, lwd=1, lty=1:3, cex=0.8)

plot(-supplyRS11$psiRoot, supplyRS11$dEdP, type="l", col=col1, ylab="dE/dP  (mmol·m-2·s-1·MPa-1)", 
     xlab = "Root crown pressure (-MPa)",  xlim=c(0, 7), ylim=c(0,max(supplyRS11$dEdP)), lwd=1, main="dE/dP")
lines(-supplyRS12$psiRoot, supplyRS12$dEdP, lty=1, col=col2)
lines(-supplyRS13$psiRoot, supplyRS13$dEdP, lty=1, col=col3)
lines(-supplyRS14$psiRoot, supplyRS14$dEdP, lty=1, col=col4)
lines(-supplyRS21$psiRoot, supplyRS21$dEdP, lty=2, col=col1)
lines(-supplyRS22$psiRoot, supplyRS22$dEdP, lty=2, col=col2)
lines(-supplyRS23$psiRoot, supplyRS23$dEdP, lty=2, col=col3)
lines(-supplyRS24$psiRoot, supplyRS24$dEdP, lty=2, col=col4)
lines(-supplyRS31$psiRoot, supplyRS31$dEdP, lty=3, col=col1)
lines(-supplyRS32$psiRoot, supplyRS32$dEdP, lty=3, col=col2)
lines(-supplyRS33$psiRoot, supplyRS33$dEdP, lty=3, col=col3)
lines(-supplyRS34$psiRoot, supplyRS34$dEdP, lty=3, col=col4)
legend("topright", bty="n", legend=textures, lwd=1, lty=1:3, cex=0.8)
```

The derivative of $dE/d\Psi_{rootcrown}$ for the supply function of the root system is again obtained numerically. Solving the previous system of equations provides the water potentials in different points of the root system. Here we plot them for the results of silt loam texture and the first and last soil potential vectors defined above:

```{r, fig.width=8, fig.height=10, fig.align = "center", echo=FALSE}
par(mar=c(4,4,4,1), mfrow=c(2,2))
plot(supplyRS21$E, -supplyRS21$psiRoot, type="l", col="black", xlab="Total flow rate", 
     ylab = "Pressure (-MPa)",  main="Soil potentials 1 (original)", ylim=c(0, 5), xlim=c(0,max(supplyRS21$E)), lwd=2)
lines(supplyRS21$E,-supplyRS21$psiRhizo[,1], lty=4, col="black", lwd=2)
lines(supplyRS21$E,-supplyRS21$psiRhizo[,2],  lty=4, col="red", lwd=2)
lines(supplyRS21$E,-supplyRS21$psiRhizo[,3], lty=4, col="blue", lwd=2)
legend("topleft", bty="n", legend=c("Root crown", "Rhizo 1", "Rhizo 2", "Rhizo 3"), 
       lwd=2, lty=c(1,2,3,4,4,4), col=c(rep("black",4), "red","blue"), cex=0.8)

plot(supplyRS22$E, -supplyRS22$psiRoot, type="l", col="black", xlab="Total flow rate", 
     ylab = "Pressure (-MPa)",  main="Soil potentials 2 (original)", ylim=c(0, 5), xlim=c(0,max(supplyRS22$E)), lwd=2)
lines(supplyRS22$E,-supplyRS22$psiRhizo[,1], lty=4, col="black", lwd=2)
lines(supplyRS22$E,-supplyRS22$psiRhizo[,2],  lty=4, col="red", lwd=2)
lines(supplyRS22$E,-supplyRS22$psiRhizo[,3], lty=4, col="blue", lwd=2)
legend("topleft", bty="n", legend=c("Root crown", "Rhizo 1", "Rhizo 2", "Rhizo 3"), 
       lwd=2, lty=c(1,2,3,4,4,4), col=c(rep("black",4), "red","blue"), cex=0.8)

plot(supplyRS23$E, -supplyRS23$psiRoot, type="l", col="black", xlab="Total flow rate", 
     ylab = "Pressure (-MPa)",  main="Soil potentials 3 (original)", ylim=c(0, 5), xlim=c(0,max(supplyRS23$E)), lwd=2)
lines(supplyRS23$E,-supplyRS23$psiRhizo[,1], lty=4, col="black", lwd=2)
lines(supplyRS23$E,-supplyRS23$psiRhizo[,2],  lty=4, col="red", lwd=2)
lines(supplyRS23$E,-supplyRS23$psiRhizo[,3], lty=4, col="blue", lwd=2)
legend("topleft", bty="n", legend=c("Root crown", "Rhizo 1", "Rhizo 2", "Rhizo 3"), 
       lwd=2, lty=c(1,2,3,4,4,4), col=c(rep("black",4), "red","blue"), cex=0.8)
plot(supplyRS24$E, -supplyRS24$psiRoot, type="l", col="black", xlab="Total flow rate", 
     ylab = "Pressure (-MPa)",  main="Soil potentials 4 (original)", ylim=c(0, 5), xlim=c(0,max(supplyRS24$E)), lwd=2)
lines(supplyRS24$E,-supplyRS24$psiRhizo[,1], lty=4, col="black", lwd=2)
lines(supplyRS24$E,-supplyRS24$psiRhizo[,2],  lty=4, col="red", lwd=2)
lines(supplyRS24$E,-supplyRS24$psiRhizo[,3], lty=4, col="blue", lwd=2)
legend("topleft", bty="n", legend=c("Root crown", "Rhizo 1", "Rhizo 2", "Rhizo 3"), 
       lwd=2, lty=c(1,2,3,4,4,4), col=c(rep("black",4), "red","blue"), cex=0.8)
```

Note that when soil is not dry (first situation) pressure drop in the rhizosphere is negligible, but not the pressure drop in the root xylem. For drier soils rhizosphere becomes more relevant. We can also plot the flow rates across each of the parallel paths (again corresponding to the results of silt loam texture and for the four soil potential vectors):
```{r, fig.width=6, fig.height=7, fig.align = "center", echo=FALSE}
par(mar=c(4,4,5,1), mfrow=c(2,2))
plot(supplyRS21$E, supplyRS21$ERhizo[,1], type="l", col="black", xlab="Total flow rate", 
     ylab = "Path flow rate",  main="Soil potentials 1",  xlim=c(0, 4), ylim=c(-1,4), lwd=1)
lines(supplyRS21$E, supplyRS21$ERhizo[,2], lty=2)
lines(supplyRS21$E, supplyRS21$ERhizo[,3], lty=3)
abline(h=0, col="gray")
legend("topleft", legend=c("Layer 1", "Layer 2", "Layer 3"), bty="n", lty=c(1,2,3))
plot(supplyRS22$E, supplyRS22$ERhizo[,1], type="l", col="black", xlab="Total flow rate", 
     ylab = "Path flow rate",  main="Soil potentials 2",  xlim=c(0, 2), ylim=c(-0.5,2), lwd=1)
lines(supplyRS22$E, supplyRS22$ERhizo[,2], lty=2)
lines(supplyRS22$E, supplyRS22$ERhizo[,3], lty=3)
abline(h=0, col="gray")
legend("topleft", legend=c("Layer 1", "Layer 2", "Layer 3"), bty="n", lty=c(1,2,3))
plot(supplyRS23$E, supplyRS23$ERhizo[,1], type="l", col="black", xlab="Total flow rate", 
     ylab = "Path flow rate",  main="Soil potentials 3",  xlim=c(0, 0.4), ylim=c(-0.2,0.4), lwd=1)
lines(supplyRS23$E, supplyRS23$ERhizo[,2], lty=2)
lines(supplyRS23$E, supplyRS23$ERhizo[,3], lty=3)
abline(h=0, col="gray")
legend("topleft", legend=c("Layer 1", "Layer 2", "Layer 3"), bty="n", lty=c(1,2,3))
plot(supplyRS24$E, supplyRS24$ERhizo[,1], type="l", col="black", xlab="Total flow rate", 
     ylab = "Path flow rate",  main="Soil potentials 4",  xlim=c(0, 0.05), ylim=c(-0.05,0.05), lwd=1)
lines(supplyRS24$E, supplyRS24$ERhizo[,2], lty=2)
lines(supplyRS24$E, supplyRS24$ERhizo[,3], lty=3)
abline(h=0, col="gray")
legend("topleft", legend=c("Layer 1", "Layer 2", "Layer 3"), bty="n", lty=c(1,2,3))
```
Note that the contribution of each soil layer depends on the soil conditions and the total amount of flow. For a low total flow rate some layers may have negative flows if their potential is lower than others, which in a dynamic context will cause hydraulic redistribution of water among soil layers.


### Supply function of the soil-plant continuum
We can use a network of $(N \times 2 + S + 1)$ resistance elements to represent the soil-plant continuum, with soil being represented in $N$ different layers. As before, the $N$ soil layers are in parallel up to the root crown and each soil layer requires at least a rhizosphere and a root segment. From the root crown there are $S$ stem xylem elements (normally $S = 1$) in series and a final leaf element. The whole hydraulic network is illustrated in the figure below.

To build the supply function for the network, we proceed by calculating water potentials in the network for each value of flow. For any given $E$ value we start by calculating flows and potentials within the root system. After that, and assuming $S = 1$, the water potential at the upper end of the stem ($\Psi_{stem}$) is obtained using the inverse of the stem supply function and setting $\Psi_{up,k}=\Psi_{rootcrown}$. If $S > 1$, this is done for each of the stem segments (thus obtaining $\Psi_{stem, 1}$, $\Psi_{stem, 2}$, ... $\Psi_{stem, S}$), while using a maximum conductance for segments equal to $k_{max,s}$ times $S$. Leaf water potential ($\Psi_{leaf}$) is finaly obtained using the inverse of the leaf supply function and setting $\Psi_{up,k}=\Psi_{stem, S}$ and assuming a steady-state flow $E$. The whole supply function $E(\Psi_{leaf}$) is obtained repeating these operations from $E=0$ to a critical value $E_{crit}$. 
```{r, out.width='80%', fig.align="center", fig.cap="Schematic representation of hydraulics in a whole-plant network", echo=FALSE}
knitr::include_graphics("hydraulics_nocap.jpg")
```


The following figure shows network supply functions (with $S = 1$) for each soil texture and starting from the different soil water potential configurations (see function `hydraulics_supplyFunctionNetwork()`): 
```{r, fig.width=8, fig.height=3.5, fig.align = "center", echo=FALSE}
par(mar=c(4,4,2,1), mfrow=c(1,2))
psiMax = -7.0
supplyNetwork11 = hydraulics_supplyFunctionNetwork(psiSoilLayers1,
                                  krhizomaxvec1,rep(n1,3),rep(alpha1,3),
                                  krootmaxvec, rootc,rootd,
                                  kstemmax, stemc,stemd,
                                  kleafmax, leafc,leafd,
                                  PLCstem =0.0,
                                  maxNsteps = 400)
supplyNetwork12 = hydraulics_supplyFunctionNetwork(psiSoilLayers2,
                                  krhizomaxvec1,rep(n1,3),rep(alpha1,3),
                                  krootmaxvec, rootc,rootd,
                                  kstemmax, stemc,stemd,
                                  kleafmax, leafc,leafd,
                                  PLCstem=0.0,
                                  maxNsteps = 400)
supplyNetwork13 = hydraulics_supplyFunctionNetwork(psiSoilLayers3,
                                  krhizomaxvec1,rep(n1,3),rep(alpha1,3),
                                  krootmaxvec, rootc,rootd,
                                  kstemmax, stemc,stemd,
                                  kleafmax, leafc,leafd,
                                  PLCstem=0.0,
                                  maxNsteps = 400)
supplyNetwork14 = hydraulics_supplyFunctionNetwork(psiSoilLayers4,
                                  krhizomaxvec1,rep(n1,3),rep(alpha1,3),
                                  krootmaxvec, rootc,rootd,
                                  kstemmax, stemc,stemd,
                                  kleafmax, leafc,leafd,
                                  PLCstem=0.0,
                                  maxNsteps = 400)
supplyNetwork21 = hydraulics_supplyFunctionNetwork(psiSoilLayers1,
                                  krhizomaxvec2,rep(n2,3),rep(alpha2,3),
                                  krootmaxvec, rootc,rootd,
                                  kstemmax, stemc,stemd,
                                  kleafmax, leafc,leafd,
                                  PLCstem=0.0,
                                  maxNsteps = 400)
supplyNetwork22 = hydraulics_supplyFunctionNetwork(psiSoilLayers2,
                                  krhizomaxvec2,rep(n2,3),rep(alpha2,3),
                                  krootmaxvec, rootc,rootd,
                                  kstemmax, stemc,stemd,
                                  kleafmax, leafc,leafd,
                                  PLCstem=0.0,
                                  maxNsteps = 400)
supplyNetwork23 = hydraulics_supplyFunctionNetwork(psiSoilLayers3,
                                  krhizomaxvec2,rep(n2,3),rep(alpha2,3),
                                  krootmaxvec, rootc,rootd,
                                  kstemmax, stemc,stemd,
                                  kleafmax, leafc,leafd,
                                  PLCstem=0.0,
                                  maxNsteps = 400)
supplyNetwork24 = hydraulics_supplyFunctionNetwork(psiSoilLayers4,
                                  krhizomaxvec2,rep(n2,3),rep(alpha2,3),
                                  krootmaxvec, rootc,rootd,
                                  kstemmax, stemc,stemd,
                                  kleafmax, leafc,leafd,
                                  PLCstem=0.0,
                                  maxNsteps = 400)
supplyNetwork31 = hydraulics_supplyFunctionNetwork(psiSoilLayers1,
                                  krhizomaxvec3,rep(n3,3),rep(alpha3,3),
                                  krootmaxvec, rootc,rootd,
                                  kstemmax, stemc,stemd,
                                  kleafmax, leafc,leafd,
                                  PLCstem=0.0,
                                  maxNsteps = 400)
supplyNetwork32 = hydraulics_supplyFunctionNetwork(psiSoilLayers2,
                                  krhizomaxvec3,rep(n3,3),rep(alpha3,3),
                                  krootmaxvec, rootc,rootd,
                                  kstemmax, stemc,stemd,
                                  kleafmax, leafc,leafd,
                                  PLCstem=0.0,
                                  maxNsteps = 400)
supplyNetwork33 = hydraulics_supplyFunctionNetwork(psiSoilLayers3,
                                  krhizomaxvec3,rep(n3,3),rep(alpha3,3),
                                  krootmaxvec, rootc,rootd,
                                  kstemmax, stemc,stemd,
                                  kleafmax, leafc,leafd,
                                  PLCstem=0.0,
                                  maxNsteps = 400)
supplyNetwork34 = hydraulics_supplyFunctionNetwork(psiSoilLayers4,
                                  krhizomaxvec3,rep(n3,3),rep(alpha3,3),
                                  krootmaxvec, rootc,rootd,
                                  kstemmax, stemc,stemd,
                                  kleafmax, leafc,leafd,
                                  PLCstem=0.0,
                                  maxNsteps = 400)
plot(-supplyNetwork11$psiLeaf, supplyNetwork11$E, type="l", col=col1, ylab="Flow rate  (mmol·m-2·s-1)", 
     xlab = "Leaf pressure (-MPa)",  xlim=c(0, 7), ylim=c(0,max(supplyNetwork11$E)), lwd=1, main="original")
lines(-supplyNetwork12$psiLeaf, supplyNetwork12$E, lty=1, col=col2)
lines(-supplyNetwork13$psiLeaf, supplyNetwork13$E, lty=1, col=col3)
lines(-supplyNetwork14$psiLeaf, supplyNetwork14$E, lty=1, col=col4)
lines(-supplyNetwork21$psiLeaf, supplyNetwork21$E, lty=2, col=col1)
lines(-supplyNetwork22$psiLeaf, supplyNetwork22$E, lty=2, col=col2)
lines(-supplyNetwork23$psiLeaf, supplyNetwork23$E, lty=2, col=col3)
lines(-supplyNetwork24$psiLeaf, supplyNetwork24$E, lty=2, col=col4)
lines(-supplyNetwork32$psiLeaf, supplyNetwork32$E, lty=3, col=col1)
lines(-supplyNetwork32$psiLeaf, supplyNetwork32$E, lty=3, col=col2)
lines(-supplyNetwork33$psiLeaf, supplyNetwork33$E, lty=3, col=col3)
lines(-supplyNetwork34$psiLeaf, supplyNetwork34$E, lty=3, col=col4)
legend("topleft", bty="n", legend=textures, lwd=1, lty=1:3, cex=0.8)

supplyNetwork11emb = hydraulics_supplyFunctionNetwork(psiSoilLayers1,
                                  krhizomaxvec1,rep(n1,3),rep(alpha1,3),
                                  krootmaxvec, rootc,rootd,
                                  kstemmax, stemc,stemd,
                                  kleafmax, leafc,leafd,
                                  PLCstem=plcCav,
                                  maxNsteps = 400)
supplyNetwork12emb = hydraulics_supplyFunctionNetwork(psiSoilLayers2,
                                  krhizomaxvec1,rep(n1,3),rep(alpha1,3),
                                  krootmaxvec, rootc,rootd,
                                  kstemmax, stemc,stemd,
                                  kleafmax, leafc,leafd,
                                  PLCstem=plcCav,
                                  maxNsteps = 400)
supplyNetwork13emb = hydraulics_supplyFunctionNetwork(psiSoilLayers3,
                                  krhizomaxvec1,rep(n1,3),rep(alpha1,3),
                                  krootmaxvec, rootc,rootd,
                                  kstemmax, stemc,stemd,
                                  kleafmax, leafc,leafd,
                                  PLCstem=plcCav,
                                  maxNsteps = 400)
supplyNetwork14emb = hydraulics_supplyFunctionNetwork(psiSoilLayers4,
                                  krhizomaxvec1,rep(n1,3),rep(alpha1,3),
                                  krootmaxvec, rootc,rootd,
                                  kstemmax, stemc,stemd,
                                  kleafmax, leafc,leafd,
                                  PLCstem=plcCav,
                                  maxNsteps = 400)
supplyNetwork21emb = hydraulics_supplyFunctionNetwork(psiSoilLayers1,
                                  krhizomaxvec2,rep(n2,3),rep(alpha2,3),
                                  krootmaxvec, rootc,rootd,
                                  kstemmax, stemc,stemd,
                                  kleafmax, leafc,leafd,
                                  PLCstem=plcCav,
                                  maxNsteps = 400)
supplyNetwork22emb = hydraulics_supplyFunctionNetwork(psiSoilLayers2,
                                  krhizomaxvec2,rep(n2,3),rep(alpha2,3),
                                  krootmaxvec, rootc,rootd,
                                  kstemmax, stemc,stemd,
                                  kleafmax, leafc,leafd,
                                  PLCstem=plcCav,
                                  maxNsteps = 400)
supplyNetwork23emb = hydraulics_supplyFunctionNetwork(psiSoilLayers3,
                                  krhizomaxvec2,rep(n2,3),rep(alpha2,3),
                                  krootmaxvec, rootc,rootd,
                                  kstemmax, stemc,stemd,
                                  kleafmax, leafc,leafd,
                                  PLCstem=plcCav,
                                  maxNsteps = 400)
supplyNetwork24emb = hydraulics_supplyFunctionNetwork(psiSoilLayers4,
                                  krhizomaxvec2,rep(n2,3),rep(alpha2,3),
                                  krootmaxvec, rootc,rootd,
                                  kstemmax, stemc,stemd,
                                  kleafmax, leafc,leafd,
                                  PLCstem=plcCav,
                                  maxNsteps = 400)
supplyNetwork31emb = hydraulics_supplyFunctionNetwork(psiSoilLayers1,
                                  krhizomaxvec3,rep(n3,3),rep(alpha3,3),
                                  krootmaxvec, rootc,rootd,
                                  kstemmax, stemc,stemd,
                                  kleafmax, leafc,leafd,
                                  PLCstem=plcCav,
                                  maxNsteps = 400)
supplyNetwork32emb = hydraulics_supplyFunctionNetwork(psiSoilLayers2,
                                  krhizomaxvec3,rep(n3,3),rep(alpha3,3),
                                  krootmaxvec, rootc,rootd,
                                  kstemmax, stemc,stemd,
                                  kleafmax, leafc,leafd,
                                  PLCstem=plcCav,
                                  maxNsteps = 400)
supplyNetwork33emb = hydraulics_supplyFunctionNetwork(psiSoilLayers3,
                                  krhizomaxvec3,rep(n3,3),rep(alpha3,3),
                                  krootmaxvec, rootc,rootd,
                                  kstemmax, stemc,stemd,
                                  kleafmax, leafc,leafd,
                                  PLCstem=plcCav,
                                  maxNsteps = 400)
supplyNetwork34emb = hydraulics_supplyFunctionNetwork(psiSoilLayers4,
                                  krhizomaxvec3,rep(n3,3),rep(alpha3,3),
                                  krootmaxvec, rootc,rootd,
                                  kstemmax, stemc,stemd,
                                  kleafmax, leafc,leafd,
                                  PLCstem=plcCav,
                                  maxNsteps = 400)
plot(-supplyNetwork11emb$psiLeaf, supplyNetwork11emb$E, type="l", col=col1, ylab="Flow rate  (mmol·m-2·s-1)",
     xlab = "Leaf pressure (-MPa)",  xlim=c(0, 7), ylim=c(0,max(supplyNetwork11$E)), lwd=1, main="after cavitation")
lines(-supplyNetwork12emb$psiLeaf, supplyNetwork12emb$E, lty=1, col=col2)
lines(-supplyNetwork13emb$psiLeaf, supplyNetwork13emb$E, lty=1, col=col3)
lines(-supplyNetwork14emb$psiLeaf, supplyNetwork14emb$E, lty=1, col=col4)
lines(-supplyNetwork21emb$psiLeaf, supplyNetwork21emb$E, lty=2, col=col1)
lines(-supplyNetwork22emb$psiLeaf, supplyNetwork22emb$E, lty=2, col=col2)
lines(-supplyNetwork23emb$psiLeaf, supplyNetwork23emb$E, lty=2, col=col3)
lines(-supplyNetwork24emb$psiLeaf, supplyNetwork24emb$E, lty=2, col=col4)
lines(-supplyNetwork32emb$psiLeaf, supplyNetwork32emb$E, lty=3, col=col1)
lines(-supplyNetwork32emb$psiLeaf, supplyNetwork32emb$E, lty=3, col=col2)
lines(-supplyNetwork33emb$psiLeaf, supplyNetwork33emb$E, lty=3, col=col3)
lines(-supplyNetwork34emb$psiLeaf, supplyNetwork34emb$E, lty=3, col=col4)
legend("topleft", bty="n", legend=textures, lwd=1, lty=1:3, cex=0.8)
abline(v=-psiCav, col="gray", lwd=1.5)
```

As with previous representations of the soil-plant continuum, the derivative of $dE/d\Psi_{leaf}$ for the network topology is obtained numerically:

```{r, fig.width=8, fig.height=3.5, fig.align = "center", echo=FALSE}
par(mar=c(4,4,2,1), mfrow=c(1,2))
plot(-supplyNetwork11$psiLeaf, supplyNetwork11$dEdP, type="l", col=col1, ylab="dE/dP  (mmol·m-2·s-1·MPa-1)", 
     xlab = "Leaf pressure (-MPa)",  xlim=c(0, 7), ylim=c(0,max(supplyNetwork11$dEdP)), lwd=1, main="original")
lines(-supplyNetwork12$psiLeaf, supplyNetwork12$dEdP, lty=1, col=col2)
lines(-supplyNetwork13$psiLeaf, supplyNetwork13$dEdP, lty=1, col=col3)
lines(-supplyNetwork14$psiLeaf, supplyNetwork14$dEdP, lty=1, col=col4)
lines(-supplyNetwork21$psiLeaf, supplyNetwork21$dEdP, lty=2, col=col1)
lines(-supplyNetwork22$psiLeaf, supplyNetwork22$dEdP, lty=2, col=col2)
lines(-supplyNetwork23$psiLeaf, supplyNetwork23$dEdP, lty=2, col=col3)
lines(-supplyNetwork24$psiLeaf, supplyNetwork24$dEdP, lty=2, col=col4)
lines(-supplyNetwork31$psiLeaf, supplyNetwork31$dEdP, lty=3, col=col1)
lines(-supplyNetwork32$psiLeaf, supplyNetwork32$dEdP, lty=3, col=col2)
lines(-supplyNetwork33$psiLeaf, supplyNetwork33$dEdP, lty=3, col=col3)
lines(-supplyNetwork34$psiLeaf, supplyNetwork34$dEdP, lty=3, col=col4)
legend("topright", bty="n", legend=textures, lwd=1, lty=1:3, cex=0.8)

plot(-supplyNetwork11emb$psiLeaf, supplyNetwork11emb$dEdP, type="l", col=col1, ylab="dE/dP  (mmol·m-2·s-1·MPa-1)", 
     xlab = "Leaf pressure (-MPa)",  xlim=c(0, 7), ylim=c(0,max(supplyNetwork11$dEdP)), lwd=1, main="after cavitation")
lines(-supplyNetwork12emb$psiLeaf, supplyNetwork12emb$dEdP, lty=1, col=col2)
lines(-supplyNetwork13emb$psiLeaf, supplyNetwork13emb$dEdP, lty=1, col=col3)
lines(-supplyNetwork14emb$psiLeaf, supplyNetwork14emb$dEdP, lty=1, col=col4)
lines(-supplyNetwork21emb$psiLeaf, supplyNetwork21emb$dEdP, lty=2, col=col1)
lines(-supplyNetwork22emb$psiLeaf, supplyNetwork22emb$dEdP, lty=2, col=col2)
lines(-supplyNetwork23emb$psiLeaf, supplyNetwork23emb$dEdP, lty=2, col=col3)
lines(-supplyNetwork24emb$psiLeaf, supplyNetwork24emb$dEdP, lty=2, col=col4)
lines(-supplyNetwork31emb$psiLeaf, supplyNetwork31emb$dEdP, lty=3, col=col1)
lines(-supplyNetwork32emb$psiLeaf, supplyNetwork32emb$dEdP, lty=3, col=col2)
lines(-supplyNetwork33emb$psiLeaf, supplyNetwork33emb$dEdP, lty=3, col=col3)
lines(-supplyNetwork34emb$psiLeaf, supplyNetwork34emb$dEdP, lty=3, col=col4)
abline(v=-psiCav, col="gray", lwd=1.5)
legend("topright", bty="n", legend=textures, lwd=1, lty=1:3, cex=0.8)
```

As with the root system, we can know the water potentials in different points of the continuum. Here we plot them for the results of silt loam texture and the first and last soil potential vectors defined above:

```{r, fig.width=8, fig.height=8, fig.align = "center", echo=FALSE}
par(mar=c(4,4,4,1), mfrow=c(2,2))
plot(supplyNetwork21$E, -supplyNetwork21$psiLeaf, type="l", col="black", xlab="Total flow rate", 
     ylab = "Pressure (-MPa)",  main="Soil potentials 1 (original)", ylim=c(0, 5), xlim=c(0,max(supplyNetwork21$E)), lwd=2)
lines(supplyNetwork21$E,-supplyNetwork21$psiStem[,1], lty=2, lwd=2)
lines(supplyNetwork21$E,-supplyNetwork21$psiRoot, lty=3, lwd=2)
lines(supplyNetwork21$E,-supplyNetwork21$psiRhizo[,1], lty=4, col="black", lwd=2)
lines(supplyNetwork21$E,-supplyNetwork21$psiRhizo[,2],  lty=4, col="red", lwd=2)
lines(supplyNetwork21$E,-supplyNetwork21$psiRhizo[,3], lty=4, col="blue", lwd=2)
legend("topleft", bty="n", legend=c("Leaf","Stem","Root crown", "Rhizo 1", "Rhizo 2", "Rhizo 3"), 
       lwd=2, lty=c(1,2,3,4,4,4), col=c(rep("black",4), "red","blue"), cex=0.8)
plot(supplyNetwork21emb$E, -supplyNetwork21emb$psiLeaf, type="l", col="black", xlab="Total flow rate", 
     ylab = "Pressure (-MPa)",  main="Soil potentials 1 (cavitation)", ylim=c(0, 5), xlim=c(0,max(supplyNetwork21$E)), lwd=2)
lines(supplyNetwork21emb$E,-supplyNetwork21emb$psiStem[,1], lty=2)
lines(supplyNetwork21emb$E,-supplyNetwork21emb$psiRoot, lty=3)
lines(supplyNetwork21emb$E,-supplyNetwork21emb$psiRhizo[,1], lty=4, col="black", lwd=2)
lines(supplyNetwork21emb$E,-supplyNetwork21emb$psiRhizo[,2], lty=4, col="red", lwd=2)
lines(supplyNetwork21emb$E,-supplyNetwork21emb$psiRhizo[,3], lty=4, col="blue", lwd=2)
legend("topleft", bty="n", legend=c("Leaf","Stem","Root crown", "Rhizo 1", "Rhizo 2", "Rhizo 3"), 
       lwd=2, lty=c(1,2,3,4,4,4), col=c(rep("black",4), "red","blue"), cex=0.8)

plot(supplyNetwork24$E, -supplyNetwork24$psiLeaf, type="l", col="black", xlab="Total flow rate", 
     ylab = "Pressure (-MPa)",  main="Soil potentials 4 (original)", ylim=c(0, 5), xlim=c(0,max(supplyNetwork24$E)), lwd=2)
lines(supplyNetwork24$E,-supplyNetwork24$psiStem[,1], lty=2, lwd=2)
lines(supplyNetwork24$E,-supplyNetwork24$psiRoot, lty=3, lwd=2)
lines(supplyNetwork24$E,-supplyNetwork24$psiRhizo[,1], lty=4, col="black", lwd=2)
lines(supplyNetwork24$E,-supplyNetwork24$psiRhizo[,2],  lty=4, col="red", lwd=2)
lines(supplyNetwork24$E,-supplyNetwork24$psiRhizo[,3], lty=4, col="blue", lwd=2)
legend("topleft", bty="n", legend=c("Leaf","Stem","Root crown", "Rhizo 1", "Rhizo 2", "Rhizo 3"), 
       lwd=2, lty=c(1,2,3,4,4,4), col=c(rep("black",4), "red","blue"), cex=0.8)
plot(supplyNetwork24emb$E, -supplyNetwork24emb$psiLeaf, type="l", col="black", xlab="Total flow rate", 
     ylab = "Pressure (-MPa)",  main="Soil potentials 4 (cavitation)", ylim=c(0, 5), xlim=c(0,max(supplyNetwork24$E)), lwd=2)
lines(supplyNetwork24emb$E,-supplyNetwork24emb$psiStem[,1], lty=2)
lines(supplyNetwork24emb$E,-supplyNetwork24emb$psiRoot, lty=3)
lines(supplyNetwork24emb$E,-supplyNetwork24emb$psiRhizo[,1], lty=4, col="black", lwd=2)
lines(supplyNetwork24emb$E,-supplyNetwork24emb$psiRhizo[,2], lty=4, col="red", lwd=2)
lines(supplyNetwork24emb$E,-supplyNetwork24emb$psiRhizo[,3], lty=4, col="blue", lwd=2)
legend("topleft", bty="n", legend=c("Leaf","Stem","Root crown", "Rhizo 1", "Rhizo 2", "Rhizo 3"), 
       lwd=2, lty=c(1,2,3,4,4,4), col=c(rep("black",4), "red","blue"), cex=0.8)

```

### Supply function with water compartments

So far we assumed there are no other sources of water than the soil. In this section we  consider the effect of additional water from leaf and stem tissues on the supply function. The supply function of a network representing the continuum is build for a given state of soil water potentials. This approach allows determining flows and water potential for \emph{steady-state} conditions. In a dynamic context one has to calculate the supply function for all values of $E$, then to determine stomatal conductance (see sections devoted to photosynthesis and stomatal regulation) and finally to decide on a specific value of $E$ and the corresponding steady-state configuration. Because light and temperature conditions change along the day, steady-state stomatal conductance and instantaneous $E$ values have to be determined for subdaily steps (e.g. 1-hour steps) and then flows need to be scaled and aggregated. At the end of the day, one may substract water from soil layers and recalculate the supply function for the next day.  

When considering water compartments, plant transpiration can be larger or smaller than the water extracted from the soil. Moreover, the supply function of a given time step will be dependent on the status of storage comparments in the previous time step, because this determines how much water is added or removed to the stemflow due to the effect of water compartments. For any segment (either a stem segment or the leaf segment) the flow out of it, $E_{i,out}$, is not necessarily equal to the flow entering the segment, $E_{i, in}$. Thus, instead of eq. \ref{eq:generalsupply}, the equation governing the flow is (Sperry et al. 1998; Steppe et al. 2005):
\begin{equation}
E_{i,out} = E_{i, in} - \frac{\Delta S_{i}}{\Delta t} = \int_{\Psi_{up}}^{\Psi_{down}}{k_i(\Psi) d\Psi} - \frac{\Delta S_{i}}{\Delta t}
\end{equation}


```{r, out.width='80%', fig.align="center", fig.cap="Schematic representation of hydraulics in a whole-plant network with water compartments", echo=FALSE}
knitr::include_graphics("hydraulics_full.jpg")
```


When building the supply function from the root crown to the leaf, one has to consider changes in storage water of the current segment before processing the next segment. Specifically, for every segment $i$ we take the current downstream water potential of the previous segment as upstream water potential (i.e.  $\Psi_{up} = \Psi_{rootcrown, t}$ when processing the first stem segment, $\Psi_{up} = \Psi_{i-1, t}$ when processing intermediate stem segments or $\Psi_{up} = \Psi_{S, t}$ when processing the leaf segment). Then we calculate the steady-state drop in water potential (i.e., determine $\Psi_{down} = \Psi_{i, t}$) corresponding to the input flow ($E_{i,in}$) using the inverse of the integral transform. If stem cavitation has occurred previously then $\Psi_{cav,i}$ will limit the maximum conductance. To determine $E_{i,out}$ we calculate the additional instantaneous flow due to changes in storage water volume ($\Delta S_{i}/\Delta t$) using:
\begin{equation}
\Delta S_{i} = S_i(\Psi_{i, t}) - S_i(\Psi_{i, t-1})
\end{equation}

As mentioned when describing water content functions, we consider two sources of water in plant segments [@Tyree1990]. The amount of water absorbed by or released from the storage compartment will depend on the properties of the apoplastic and symplastic tissues and the fraction of the segment that corresponds to each kind of tissue. For example, let us take the following storage capacities, fractions of apoplastic tissue and parameters of the pressure-volume curves for symplastic tissue.
```{r}
Vmaxstem = 0.001005046
Vmaxleaf = 0.0001327463
stemfapo = 0.8
leaffapo = 0.15
stempi0 = -2
stemeps = 16
leafpi0 = -1.5
leafeps = 8
```

The following figures show the change in supply function caused by stem and leaf water compartments, assuming a 1-hr time step and either 0 MPa or -1.5 MPa as previous water potential for all segments (see function `hydraulics_supplyFunctionNetworkCapacitance()`):

```{r, fig.width=8, fig.height=8, fig.align = "center", echo=FALSE}
psiStemPrev1 = 0
psiLeafPrev1 = 0
psiStemPrev2 = -1.5
psiLeafPrev2 = -1.5
par(mar=c(4,4,4,1), mfrow=c(2,2))
supplyN11Cap1 = hydraulics_supplyFunctionNetworkCapacitance(
                                  psiSoilLayers1,
                                  psiStemPrev1, PLCstem=0,
                                  psiLeafPrev1,
                                  krhizomaxvec1,rep(n1,3),rep(alpha1,3),
                                  krootmaxvec, rootc,rootd,
                                  kstemmax, stemc,stemd,
                                  kleafmax, leafc,leafd,
                                  Vmaxstem, stemfapo, stempi0, stemeps,
                                  Vmaxleaf, leaffapo, leafpi0, leafeps)
supplyN11Cap2 = hydraulics_supplyFunctionNetworkCapacitance(
                                  psiSoilLayers1,
                                  psiStemPrev2, PLCstem=0,
                                  psiLeafPrev2,
                                  krhizomaxvec1,rep(n1,3),rep(alpha1,3),
                                  krootmaxvec, rootc,rootd,
                                  kstemmax, stemc,stemd,
                                  kleafmax, leafc,leafd,
                                  Vmaxstem, stemfapo, stempi0, stemeps,
                                  Vmaxleaf, leaffapo, leafpi0, leafeps)

supplyN11Cap1Emb = hydraulics_supplyFunctionNetworkCapacitance(
                                  psiSoilLayers1,
                                  psiStemPrev1, PLCstem=plcCav,
                                  psiLeafPrev1,
                                  krhizomaxvec1,rep(n1,3),rep(alpha1,3),
                                  krootmaxvec, rootc,rootd,
                                  kstemmax, stemc,stemd,
                                  kleafmax, leafc,leafd,
                                  Vmaxstem, stemfapo, stempi0, stemeps,
                                  Vmaxleaf, leaffapo, leafpi0, leafeps)
supplyN11Cap2Emb = hydraulics_supplyFunctionNetworkCapacitance(
                                  psiSoilLayers1,
                                  psiStemPrev2, PLCstem=plcCav,
                                  psiLeafPrev2,
                                  krhizomaxvec1,rep(n1,3),rep(alpha1,3),
                                  krootmaxvec, rootc,rootd,
                                  kstemmax, stemc,stemd,
                                  kleafmax, leafc,leafd,
                                  Vmaxstem, stemfapo, stempi0, stemeps,
                                  Vmaxleaf, leaffapo, leafpi0, leafeps)

plot(-supplyNetwork11$psiLeaf, supplyNetwork11$E, type="l", col=col1, ylab="Flow rate  (mmol·m-2·s-1)", 
     xlab = "Leaf pressure (-MPa)",  xlim=c(0, 7), ylim=c(-1,6), lwd=1, main="original")
lines(-supplyN11Cap1$psiLeaf, supplyN11Cap1$ELeaf, lty=1, col=col2)
lines(-supplyN11Cap2$psiLeaf, supplyN11Cap2$ELeaf, lty=1, col=col3)
legend("bottomright",  legend= c("No capacitance", "Psi_prev = 0 MPa", "Psi_prev = -1.5 MPa"),       col = c(col1, col2, col3), lty=1, bty="n")
plot(-supplyNetwork11emb$psiLeaf, supplyNetwork11emb$E, type="l", col=col1, ylab="Flow rate  (mmol·m-2·s-1)", 
     xlab = "Leaf pressure (-MPa)",  xlim=c(0, 7), ylim=c(-1,6), lwd=1, main="cavitated")
legend("bottomright",  legend= c("No capacitance", "Psi_prev = 0 MPa", "Psi_prev = -1.5 MPa"), col = c(col1, col2, col3), lty=1, bty="n")
lines(-supplyN11Cap1Emb$psiLeaf, supplyN11Cap1Emb$ELeaf, lty=1, col=col2)
lines(-supplyN11Cap2Emb$psiLeaf, supplyN11Cap2Emb$ELeaf, lty=1, col=col3)

plot(-supplyNetwork11$psiLeaf, supplyNetwork11$dEdP, type="l", col=col1, ylab="dE/dP  (mmol·m-2·s-1·MPa-1)",     xlab = "Leaf pressure (-MPa)",  xlim=c(0, 7), ylim=c(0,3), lwd=1, main="original")
legend("topright",  legend= c("No capacitance", "Psi_prev = 0 MPa", "Psi_prev = -1.5 MPa"), col = c(col1, col2, col3), lty=1, bty="n")
lines(-supplyN11Cap1$psiLeaf, supplyN11Cap1$dEdP, lty=1, col=col2)
lines(-supplyN11Cap2$psiLeaf, supplyN11Cap2$dEdP, lty=1, col=col3)
plot(-supplyNetwork11emb$psiLeaf, supplyNetwork11emb$dEdP, type="l", col=col1, ylab="dE/dP  (mmol·m-2·s-1·MPa-1)", 
    xlab = "Leaf pressure (-MPa)",  xlim=c(0, 7), ylim=c(0,3), lwd=1, main="cavitated")
legend("topright",  legend= c("No capacitance", "Psi_prev = 0 MPa", "Psi_prev = -1.5 MPa"),col = c(col1, col2, col3), lty=1, bty="n")
lines(-supplyN11Cap1Emb$psiLeaf, supplyN11Cap1Emb$dEdP, lty=1, col=col2)
lines(-supplyN11Cap2Emb$psiLeaf, supplyN11Cap2Emb$dEdP, lty=1, col=col3)
```

For the same water potential drop, the effect of the water compartment results in a larger transpiration flow. If the previous water potential is more negative than the root crown, negative flows may occur, because of the need to replenish the water compartment. Note, in addition, that $dE/d\Psi$ is no longer a non-increasing function of $\Psi$. This has important consequences for the definition of the cost function (see subsection 'Stomatal regulation'). In our opinion, the effect of water compartments on the transpiration flow are important for subdaily variations in transpiration but are less necessary for seasonal to multi-year simulations. However, we will come back to the importance of compartments for plants being disconnected from the soil.

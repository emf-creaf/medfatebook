# (PART) Landscape processes {-}

# Watershed hydrology {#watershedhydrology}

This chapter describes the distributed watershed water balance model implemented in function `wswb` of package **medfateland**. 

## Design principles

Watersheds are described in raster (i.e. gridded) mode, each cell representing a patch of vegetation (or another land cover) in a catchment. Watershed water balance simulations extend the simulation of soil water balance to the landscape scale. Hence, the design of most vertical hydrological processes is the same as those of forest water balance. However, additional water compartments and processes are represented in watershed water balance simulations. Each cell in the watershed may include the following: a snowpack comparment, one or several soil layers (including a rocky layer down to several meters depth), and a groundwater compartment assumed to be beyond the reach of plant roots. Similar to other models such as TETIS [@Frances2007], three lateral flows are considered between adjacent cells: 

  (a) Overland surface flows from upper elevation cells.
  (b) Lateral saturated soil flows (i.e. interflow) between adjacent cells. 
  (c) Lateral groundwater flow (i.e. baseflow) between adjacent cells.

Overland surface flows are modeled following T-HYDRO @Ostendorf1993. Subsurface flows, including both soil saturated flow and groundwater flow, are modeled following the kinematic wave approach of DSHVM @Wigmosta1994.

Split-parameter parametrization following @Frances2007.

## State variables {#statevariableswatershed}

Distributed simulation of rainfall-runoff processes implies that state variables are defined for each cell of the watershed. For this kind of simulations, state variables describing the water content of different compartments are the most important:

+ $W_s$, the proportion of soil moisture in relation to field capacity for each soil layer $s$ in the cell.
+ $S_{snow}$ the snow water equivalent (mm) of the snow pack storage over the cell surface.
+ $S_{aquifer}$ the water content (mm) in the cell's aquifer beyond the reach of plant roots.

Additional cell state variables concern the water status (or other state variables) of plant cohorts in the cell, and they were described in chapters \@ref(basicwaterbalance) and \@ref(advancedwaterbalance).

## Water balance {#watershedbalance}

In distributed watershed simulations water balance can be defined both at the cell level and at the watershed level.

### Cell level water balance
At the cell level, daily variations in water content can occur in the *snowpack*, *soil* or *groundwater* compartments: 

1. Variations in snowpack water equivalent content follows eq. \@ref(eq:snowbalanceequation).
2. Variations in soil water content ($\Delta{V_{soil}}$) need to account for additional flows and are summarized as (compare to \@ref(eq:basicwaterbalanceequation)):
  \begin{equation}
  \Delta{V_{soil}} = Pr + Sm + Ro + Ad - In - Ru - Dd - Es - Tr + \Delta{S_{inter}}
  (\#eq:cellsoilwaterbalanceequation)
  \end{equation}
where $Pr$ is precipitation as rainfall, $Sm$ is snowmelt, $Ro$ is surface *runon* water entering the cell from neighboring cells at higher elevation, $Ad$ is aquifer discharge, $In$ is rainfall interception loss, $Ru$ is cell surface runoff, $Dd$ is deep drainage towards the aquifer, $Es$ is soil evaporation, $Tr$ is plant transpiration and $\Delta{S_{inter}}$ is the variation in soil water content derived from the balance between saturated soil lateral inputs and outputs.
3. Variations in the aquifer water content of a cell are summarized by:
\begin{equation}
  \Delta{S_{aquifer}} = Dd - Ad - \Delta{S_{base}}
  (\#eq:cellaquiferwaterbalanceequation)
\end{equation}
where $\Delta{S_{base}}$ is the variation in water content of the aquifer derived from the balance between groundwater lateral inputs and outputs.

### Watershed water balance

At the watershed level, separate water balances can again be defined for the average water content of snow pack, soil or groundwater compartments. These result from averaging water balances across cells. Additionally, a water balance is defined regarding the overall water content in the watershed. 

1. Changes in the average snow pack water equivalent over cells is the result of balancing precipitation as snow ($Ps$) and snow melt ($Sm$), both flows averaged over cells:
\begin{equation}
  \Delta{\hat{S}_{snow}} = \hat{Ps} - \hat{Sm}
\end{equation}
where $\hat{Ps}$ and $\hat{Sm}$ are the average snow fall and snow melt over cells.
2. Changes in the average soil moisture ($\Delta{\hat{V}_{soil}}$) are the result of pooling soil inputs and outputs over cells, which yields:
\begin{equation}
\Delta{\hat{V}_{soil}} = \hat{Pr} + \hat{Sm} + \hat{Ad} + \hat{Ro} - \hat{Ru} - \hat{In} - \hat{Dd} - \hat{Es} - \hat{Tr}
\end{equation}
where $\hat{Pr}$, $\hat{Ad}$, $\hat{Ro}$, $\hat{Ru}$, $\hat{In}$, $\hat{Dd}$, $\hat{Es}$ and $\hat{Tr}$ are the average (over cells) of precipitation (including rain and snow), aquifer discharge, lateral surface water input (runon), runoff, rainfall interception loss, deep drainage, soil evaporation and plant transpiration, respectively. Lateral saturated soil flows are not included as they cancel out at the watershed level.
3. Changes in the average of cell aquifer water content ($\Delta{\hat{S}_{aquifer}}$) are the result of balancing deep drainage ($Dd$) from soils and aquifer discharge ($Ad$):
\begin{equation}
  \Delta{\hat{S}_{aquifer}} = \hat{Dd} - \hat{Ad}
\end{equation}
4. If we integrate the three water compartments, water balance at the watershed level is given by:
\begin{equation}
  \Delta{S_{watershed}} = \hat{Pr} - \hat{In} - \hat{Es} - \hat{Tr} - \hat{Ex}
\end{equation}
where $\Delta{S_{watershed}} = \Delta{\hat{S}_{snow}}+\Delta{\hat{V}_{soil}}+\Delta{\hat{S}_{aquifer}}$ is the change in water content in the watershed and $\hat{Ex}$ is the water exported as runoff from cells without neighbors (i.e. catchment outlet cells).

## Process scheduling {#watershedbalancescheduling}

For every day to be simulated, the model performs the following steps:

 1. Calculation of soil and groundwater hydraulic heads for each cell (see \@ref(subsurfaceflows)).
 2. Calculation of soil and groundwater lateral flows between adjacent cells, according to hydraulic gradients (see \@ref(subsurfaceflows)).
 3. Apply changes in cell soil moisture content due to soil lateral flows (i.e. determine $\Delta{S_{sub}}$ for each cell), including the possibility of a return flow to the surface if the soil becomes saturated (i.e. saturation excess flow).
 4. Apply changes in cell aquifer water content, including the possibility of discharge from the aquifer to the soil and a saturation excess flow (eq. \@ref(eq:cellaquiferwaterbalanceequation)).
 5. Determine remaining cell flows by processing watershed cells in order of decreasing elevation (i.e. cells at higher elevation are processed before cells at lower elevation). For each cell to be processed:
    a. Determine snowpack dynamics, rainfall interception loss, infiltration and runoff, transpiration, soil evaporation processes as described in \@ref(basicwaterbalancescheduling), while including saturation excess flow as well as potential runon ($Ro$) from upslope cells as additional water inputs.
    b. Distribute surface runoff among cells downhill (\@ref(overlandflows)). If a cell does not have downhill neighbors (i.e outlet cell) its runoff becomes water exported from the watershed.

## Inputs and outputs

### Soil, vegetation and meteorology


### Watershed hydraulic correction parameters {#watershedbalancecontrol}


### Model output {#watershedbalanceoutput}


## Applications

## Details of processes

### Subsurface flows  {#subsurfaceflows}

### Overland flows {#overlandflows}

To simulate surface runoff routing from one cell to the other, the approach of @Ostendorf1993 is used, as in SIERRA [@Mouillot2001]. Overland water lateral transport for a given day occurs instantaneously (i.e. no velocities are calculated) and depends on topography only. The model determines cell neighbors following the queen rule (up to eight neighbors per cell). The proportion of surface water runoff of cell $i$ that will be added to the infiltration input (runon) of a neighboring cell $j$ is @Ostendorf1993:
\begin{equation}
q_{ij} = \frac{\Delta z_{ij}/L_{ij}}{\sum_{j}{\Delta z_{ij}/L_{ij}}}
\end{equation}
if $\Delta z_{ij} = z_i - z_j > 0$, that is, if the difference in elevation between the two cells is positive (i.e. if $z_j < z_i$). Otherwise there is no overland transport from $i$ to $j$, i.e. $q_{ij} = 0$. $L_{ij}$ indicates the distance between cell $i$ and $j$ (which depends on cell size and on whether the neighboring cell $j$ is diagonal to cell $i$). The summation of the denominator is done only for neighbors at lower elevation, so that $\sum_{i}{q_{ij}} = 1$. The table of $q_{ij}$ values is calculated when initializing distributed watershed objects.

Every day, cells are processed in order from higher to lower elevation. After the daily water balance of a given cell $i$, water runoff $R_i$ is divided among the neighboring cells at lower elevation. The runon of a neighbor $j$, $O_j$ is updated as:

\begin{equation}
O_j = O_j + R_i \cdot q_{ij}
\end{equation}

Note that a given cell $j$ can receive overland flow from more than one neighbor. $O_j$ values are set to zero at the beginning of each day.

### Watershed runoff

A special situation arises when processing cells that do not have downhill neighbors defined (i.e. where $q_{ij} = 0$ for all $j$), either because they are in flat surfaces or at the watershed boundary. In both cases, these cells should correspond to water bodies or streams connecting to the catchment outlet. Hence, these cells are called *outlet cells* in the model, and the runoff they generate becomes watershed runoff.

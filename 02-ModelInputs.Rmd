# Model inputs

Data input for process-based models of forest functioning and dynamics can be described using three broad categories. First, a description of the target **vegetation** is needed, at a level of detail appropriate for the model design. This includes not only species composition and/or structure, but also functional parameters of the plants. Second, most often **soil** information is required, specially if underground resources (i.e. water and/or nutrients) are important for the processes included in the model. While soil and vegetation features are sometimes considered static parameters in model simulations, **meteorology** is most often a dynamic input which defines the temporal variation of environmental conditions in which biological processes occur. This chapter describes the requirements of **medfate** package with respect to each of these three kinds of input. The last section describes additional parameters that are used to control the behaviour of simulation functions, such as `spwb()` and `growth()`.

## Soil description  {#soilinput}

Soils can be described in **medfate** using between 1 and 5 soil layers. The number and size of layers may reflect changes in soil properties, but also can be chosen to reflect different plant rooting depths. The physical properties of the soil are needed to estimate its hydraulic properties. Most soil properties are considered static parameters in simulations, except those that depend on soil water balance (e.g. soil moisture content, soil water potential and soil conductivity) and soil temperature, if the soil energy balance is considered in simulations.

### Physical properties

Physical soil properties, like soil texture (i.e. percent of sand, silt and clay), bulk density or rock fragment content, can differ between soil layers, and this has important consequences for water retention capacity and soil hydraulics. In addition, specifying a deep rocky layer may be important in some biomes like the Mediterranean one, because plants often extend their roots into cracks existing in the parent rock [@Ruffault2013]. For each soil layer $s$ the following physical parameters are needed:

| Symbol | Units | R  | Description                         | 
|--------|-------|----| ------------------------------------|
| $d_{s}$ | $mm$ | `widths` | Soil layer width |
| $P_{clay,s}$ | % | `clay` | Percent of clay (within soil particles)  |
| $P_{sand,s}$ | % | `sand` | Percent of sand (within soil particles) |
| $OM$ | % | `om` | Percentage of organic mater per dry weight (can be missing) |
| $BD_{s}$ | $g \cdot cm^{-3}$ |`bd` | Bulk density |
| $P_{rocks,s}$ | % | `rfc` | Rock fragment content as percent per soil volume |

*Soil depth* is defined as the sum of soil layer widths. If possible, soil physical properties should be measured in soil profiles conducted at the target forest plot. Soil input data should be arranged in a `data.frame` with soil layers in rows and physical variables in columns (see function `defaultSoilParams()`). The package includes function `soilgridsParams()` to fetch soil information from [SoilGrids.org](https://soilgrids.org/), a global soil database currently providing soil data at 250m scale. This can be helpful to users lacking local soil measurements, but the uncertainty of SoilGrids estimates can be high for some areas and soil properties, especially soil depth and rock fragment content.

### Water retention curves

The water retention curve of a soil is the relationship between volumetric soil moisture ($\theta$, in $m^3 \cdot m^{-3}$ of soil, excluding rock fragments) and the soil water potential ($\Psi$, in MPa). This curve is characteristic for different types of soil, and is also called the *soil moisture characteristic curve*. Two water retention curve models are available in **medfate** (fig. \@ref(fig:retention-curves)):

1. *Saxton model*: In this model, volumetric soil moisture $\theta(\Psi)$ corresponding to a given water potential $\Psi$ (in MPa) below $\Psi_{fc}$ is calculated using: 
\begin{equation}\theta(\Psi) = (\Psi/A)^{(1/B)}\end{equation}
where $A$ and $B$ depend on the texture and, if available, organic matter in the soil. If organic matter is available, $A$ and $B$ are calculated from $P_{clay}$, $P_{sand}$ and $OM$ following @Saxton2006. Otherwise, they are calculated from $P_{clay}$ and $P_{sand}$ as indicated in @Saxton1986. Volumetric changes between field capacity and saturation are estimated using a linear function.
2. *Van Genuchten model*: The well known van Genuchten [-@Genuchten1980] model is:
\begin{equation}\theta(\Psi) = \theta_{res}+\frac{\theta_{sat}-\theta_{res}}{\left[1+ (\alpha \cdot \Psi)^n \right]^{1-1/n}}\end{equation}
where $\theta(\psi)$ is the water retention, $\theta_{sat}$ is the saturated water content, $\theta_{res}$ is the residual water content, $\alpha$ is related to the inverse of the air entry pressure, and $n$ is a measure of the pore-size distribution. 

(ref:retention-curves-cap) Water retention curves under the Saxton and Van Genuchten models, for the same physical attributes (25% sand, 25% clay, 50% silt and bulk density of $1.5 g \cdot cm^{-3}$).

```{r retention-curves, fig.align='center', fig.width=4, fig.height=3.5, echo = FALSE, fig.cap='(ref:retention-curves-cap)'}
soil_retentionCurvePlot(soil(defaultSoilParams()), model="both")+
  theme(legend.position =c(0.7,0.8))
```


### Soil initialization
Soil initialization is needed to estimate soil hydrological parameters for each soil layer $s$ from their physical attributes. Initialization is done using function `soil()`, which returns an object of a class with the same name. Function `soil()` adds the following information to the physical soil description: 

| Symbol | Units | R  | Description                               | 
|--------|-------|----| ------------------------------------------|
| $P_{macro, s}$ | % | `macro` | Percentage of macroporosity corresponding to each soil layers | 
| $\gamma_{soil}$ | $mm \cdot day^{-1}$ | `Gsoil` | The maximum daily evaporation rate from soil |
| $\kappa_{soil}$ |  | `Ksoil` | Extinction parameter to regulate the amount of water extracted from each soil layer when simulating evaporation from bare soil |
| $\theta_{sat, s}$ |$m^3 \cdot m^{-3}$ | `VG_theta_sat`| Volumetric moisture at saturation |
| $\theta_{res, s}$ |$m^3 \cdot m^{-3}$ | `VG_theta_res` | Residual volumetric moisture |
| $n_s$ | | `VG_n` | Parameter of the Van Genuchten [-@Genuchten1980] model |
| $\alpha_s$ | $MPa^{-1}$ | `VG_alpha`| Parameter of the Van Genuchten [-@Genuchten1980] model |

Macroporosity values are calculated using the equations given in @Stolf2011, while $\gamma_{soil}$ and $\kappa_{soil}$ are derived from texture. Parameters of the van Genuchten model (including are estimated from the physical description of the soil using one of two pedotransfer functions (see help for `soil()`): 

1. Using the USDA texture classification and the average texture class parameters given by @Carsel1988.
2. Directly from the soil texture, organic matter and bulk density, using the pedotransfer functions in @Toth2015.

All simulation functions need an object of class `soil` to be run. Users can edit the `soil` object manually (it is actually a list), for example to provide specific parameters of the Van Genuchten retention curve calibrated from soil samples.

### Water content and water table depth

The *water content* ($V_s$ in mm) of a soil layer $s$ is calculated from its water potential and water retention curve using:
\begin{equation}
V_s(\Psi) = d_s\cdot ((100-P_{rocks,s})/100)\cdot\theta_{s}(\Psi)
\end{equation}
where $d_s$ is the depth of the soil layer (in mm) and $P_{rocks,s}$ is the percentage of rock fragments. Besides this general formula, a number of contents are important to remember. 

  + *Water holding capacity* ($V_{fc, s}$, in mm) of the soil layer $s$ is defined as the volumetric water content at field capacity, i.e. -0.033 MPa:
\begin{equation}
V_{fc,s} = V_{s}(-0.033) = d_s\cdot ((100-P_{rocks,s})/100)\cdot\theta_{fc,s}
\end{equation}
where $\theta_{fc,s} = \theta_s(-0.033)$. 
  + *Water content at saturation* is calculated anagolously, but replacing $\theta_{fc,s}$ by $\theta_{sat, s} = \theta_s(0)$. 
  + *Water content at wilting point* (-1.5 MPa) is calculated replacing $\theta_{fc,s}$ by $\theta_{wp,s} = \theta_s(-1.5)$. 
  + The *amount of extractable water* is the difference between water content at field capacity and a the water content at a conventional minimum water potential, which can be set at wilting point or lower values (by default at -5 MPa in **medfate**).

The depth of water table is the depth of saturated soil. In medfate, *water table depth* ($WT$, in mm) equals soil depth when all soil layers are below field capacity. When some layers are between field capacity and saturation, water table depth is calculated as:
\begin{equation}
WT = \sum_{s}{d_s \cdot \min\left[1,(\theta_{sat,s} - \theta(\Psi_s))/(\theta_{sat,s}-\theta_{fc,s})\right]}
\end{equation}


## Vegetation description {#vegetationinput}

The representation of plants within a target plot is done in **medfate** by means of **cohorts** of woody plants (i.e. trees and shrubs). A plant cohort respresents plants that belong to the same species (or functional group) and are more or less of the same *size*. For example, trees in a stand may be grouped by species and diameter class. This representation is chosen so that package functions can be easily applied to forest plot data, for example from national forest inventories. The description of plant cohorts includes a measure of *abundance* of the cohort in the stand, which in the case of trees is density as stems per hectare and for shrubs is percent cover. In fact this (and the fact that shrubs are multi-stemmed) is the only motivation for distinguishing between tree cohorts and shrub cohorts. 

Note that one limitation of the representation of vegetation using plant cohorts is that it is not spatially-explicit (i.e. plants cannot have explicit coordinates within forest stands) and hence spatial (horizontal) interactions cannot be taken into account.  

### Structural attributes of plant cohorts 

A plant cohort $i$ is either a *tree cohort* or a *shrub cohort*, and is defined using a set of structural attributes shown in the following table, where columns **spwb** and **growth** indicate whether attributes are required by functions `spwb()` and `growth()`, respectively:

| Symbol | Units | R  | Description                        | spwb | growth |
|--------|-------|----| ------------------------------------|-----|-----|
| $SP_i$  |  | `Species` | Species identity |  Y  |  Y  |
| $H_i$  | $cm$  | `Height` | Average tree or shrub height |  Y  |  Y  |
| $CR_i$ |       | `CR`| Crown ratio (i.e. ratio between crown length and plant height) | Y | Y |
| $N_i$ | $ind · ha^{-1}$ | `N` | Density of tree individuals | N | Y |
| $DBH_i$ | $cm$ | `DBH` | Tree diameter at breast height | N | Y |
| $Cover_i$ | % | `Cover` | Shrub percent cover | N | Y |
| $LAI^{live}_i$ | $m^2 \cdot m^{-2}$ | `LAI_live` | (Maximum) leaf area index | Y | Y |
| $LAI^{dead}_i$ | $m^2 \cdot m^{-2}$ | `LAI_dead` | Dead leaf area index | Y | Y |
| $LAI^{\phi}_i$ | $m^2 \cdot m^{-2}$ | `LAI_expanded` | Current expanded leaf area index | Y | Y |
| $Z_{50,i}$ | mm | `Z50` | Depth above which 50% of the fine root mass is located | Y | Y |
| $Z_{95,i}$ | mm | `Z95` | Depth above which 95% of the fine root mass is located | Y | Y |

Height values refer to average height of individuals included in the cohort, and the same for crown ratio and $DBH$. $LAI$ variables refer to one-side leaf area of plants in the cohort per surface area of the stand. While plant height is relatively easy to measure, it is normally quite hard to estimate leaf area indices for stands and species. Package **medfate** provides some utilities to provide estimates crown ratio and $LAI$ from forest inventory data (e.g. heights, DBH and density for measured trees), using allometric relationships calibrated for catalonia (see chapter \@ref(allometricmodels)). 

Trees and shrubs do not need to be distinguished in soil water balance calculations, since both kinds of cohort have a $LAI$ value. Vegetation characteristics stay constant during simulations using function `spwb()`, although the actual expanded leaf area and dead leaf area may vary is the species is winter deciduous.

In contrast, growth simulation requires updating the structure of vegetation, i.e. heights, tree diameters and shrub cover. Function `growth()` can modify any of the vegetation attributes.


### Vertical root distribution

The root system of each plant cohort $i$ is described using the proportion of fine roots in each soil layer $s$: $v_{i,s}$. The proportions $v_{i,s}$ are normally defined using the linear dose response model [@Schenk2002; @Collins2007]: 
\begin{equation}
Y_i(z)=\frac{1}{1+(z/Z_{50,i})^{c_i}}
\end{equation}
where $Y_i(z)$ is the cumulative fraction of fine root mass located between surface and depth $z$; $Z_{50,i}$ is the depth above which 50% of the root mass is located; and $c_i$ is a shape parameter related to $Z_{50,i}$ and $Z_{95,i}$ as $c_i  = 2.94 / \ln(Z_{50,i} / Z_{95,i})$ (see `root_ldrDistribution()`). 

```{r root-distribution, echo = FALSE, fig.width=8, fig.height=4, fig.cap = "Examples of root density profile according to a conic distribution (left) and the linear dose response model (right)."}
par(mar=c(4,4,1,1), mfrow=c(1,2))
P = root_conicDistribution(c(200,1500), rep(10,151))
matplot(x=t(P)*10, y=seq(0,1500, by=10), type="l", xlim=c(0,2), ylim=c(1500,0), ylab = "Depth (mm)", 
        xlab="Percentage of fine roots/mm")
legend("bottomright", legend=c("Z = 200", 
       "Z = 1500"), col=c("black","red"), lty=1:2, bty="n")
P = root_ldrDistribution(c(100,500), c(200,1500), rep(10,151))
matplot(x=t(P)*10, y=seq(0,1500, by=10), type="l", xlim=c(0,2), ylim=c(1500,0), ylab = "Depth (mm)", 
        xlab="Percentage of fine roots/mm")
legend("bottomright", legend=c("Z50 = 100, Z95 = 200", 
       "Z50 = 200, Z95 = 1500"), col=c("black","red"), lty=1:2, bty="n")
```

Note, however, that the actual input to simulation functions is the matrix of $v_{i,s}$ values - not $Z_{50,i}$ and $Z_{95,i}$ -, which means that the proportions of fine roots can be modified manually or be defined by another model. In fact, **medfate** also allows calculating $v_{i,s}$ values assuming a conic distribution of fine roots (see `root_conicDistribution()`), as shown in fig. \@ref(fig:root-distribution) above. 


### Forest plot objects {#forestobjects}

Forest plots in `medfate` are assumed to be in a format that follows closely the Spanish national forest inventory. Each forest plot is represented in an object of class `forest`, a list that contains several elements. Among them, the most important items are two data frames, `treeData` (for trees) and `shrubData` for shrubs:
```{r}
data(exampleforest)
exampleforest
```
While not strictly necessary, forest objects are the convenient format to start calculations with **medfate**, because there are many static functions that take forest objects as input. The package includes functions to facilitate mapping variables in user data into tables `treeData` and `shrubData` (see function `forest_mapWoodyTables()`).


### Functional traits and vegetation initialization

Besides the physical representation of vegetation, forest ecosystem models require information regarding vegetation functioning, because this influences the outcome of biophysical, physiological and hydrological processes. In the following chapters, we will indicate for each simulated process its required functional parameters. Normally, functional traits are described at the species level because infra-specific parameters are hard to get. Even at the species level, many hard (e.g. physiological) traits are hard to obtain, so in **medfate** we provide a default species parameter table for woody species found in Catalonia, with many of them occurring elsewhere in the Mediterranean Basin (`SpParamsMED`). User can modify this data frame to account for intra-specific trait variation (see function `modifySpParams()`). 

The package provides functions `spwbInput()` and `growthInput()` that prepare the vegetation input for simulation functions `spwb()` and `growth()`, respectively. This initialization mostly consists in compiling the necessary functional traits from the species parameter table, following the species (or species group) attribute of plant cohorts. Some new parameters are derived from others but take into account the structural attributes of cohorts (an example of these derived quantities is stem conductance, which estimated from stem xylem conductivity and other attributes). Users can modify the output of these initialization functions to modify values for specific plant cohorts, either the species parameters or cohort specific parameters (see function `modifyCohortParams()`). 


## Metereological input {#meteoinput}
Weather input data must include variables calculated at the **daily** scale. Data should be arranged in a data frame with days in rows and variables in columns. The following table indicates the symbols, units, definitions and the variable name in R.

| Symbol | Units | R param | Description                        |
|--------|-------|---------|------------------------------------|
| $T_{mean}$ | $^{\circ} \mathrm{C}$ | `MeanTemperature` | Mean temperature |
| $T_{min}$ | $^{\circ} \mathrm{C}$ | `MinTemperature` | Minimum temperature |
| $T_{max}$ | $^{\circ} \mathrm{C}$ | `MaxTemperature` | Maximum temperature |
| $RH_{min}$ | % | `MinRelativeHumidity` | Minimum relative humidity |
| $RH_{max}$ | % | `MaxRelativeHumidity` | Maximum relative humidity |
| $P$ | $L \cdot m^{-2} = mm$ | `Precipitation` | Precipitation |
| $PET$ | $L \cdot m^{-2} = mm$ | `PET` | Potential evapotranspiration, preferably calculated using Penman's equation |
| $Rad$ | $MJ \cdot m^{-2}$ | `Radiation` | Solar radiation after accounting for clouds |
| $u$ | $m \cdot s^{-1}$ | `WindSpeed` | Wind speed |

Not all simulation models require all weather variables. In particular, basic water balance modelling requires much less information than advance water balance modelling. The meteorological variables required in each case will be indicated in the corresponding model chapters. Since it allows producing data frames with appropiate variable units and column names, we recommend meteorological input to be generated using package **meteoland** [@DeCaceres2018].


## Control parameters

Control parameters are a list of global parameter values, initialized using function `defaultControl()`, that the user can modify to change the general behavior of simulation functions. Here is the set of global control parameters currently accepted in **medfate**:
```{r}
names(defaultControl())
```



Not all control parameters are relevant to all simulation functions (this will be indicated in the following chapters), but there is an important control parameter called `transpirationMode`, because it allows the user to switch between the basic and advanced water balance models (chapters \@ref(basicwaterbalance) and \@ref(advancedwaterbalance)). 

Control parameters are employed when initializing vegetation information using functions `spwbInput()` and `growthInput()`, since they are needed also to make decisions at the point of initialization. Control parameters are also stored in the result of this functions, so the user does not need to specify again control parameters when calling simulation functions `spwb()` or `growth()`.